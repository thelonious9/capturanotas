<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    /* ImportaciÃ³n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;
      /* Oscuro Suave */
      --color-fondo-form: #52504E;
      /* Gris CÃ¡lido (Fondo del Formulario) */
      --color-primary: #6F0909;
      /* Rojo Intenso (Guardar/Borrar Todo) */
      --color-primary-hover: #792929;
      /* Rojo Suave */
      --color-secondary: #792929;
      /* Rojo Suave (BotÃ³n Limpiar/Hover) */
      --color-secondary-hover: #6F0909;
      /* Rojo Intenso */
      --color-danger: #dc3545;
      /* Rojo estÃ¡ndar para peligro */
      --color-danger-hover: #c82333;
      /* Rojo oscuro */
      --color-telegram: #0088cc;
      --color-telegram-hover: #0077b3;
      --color-dark-text: #31302F;
      /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;
      /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;
      /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;
      --radius: 0.25rem;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }

    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding: 10px 20px 15px 20px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      /* ðŸŒŸ MEJORA: Cabecera Pegajosa y TransiciÃ³n ðŸŒŸ */
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    header img {
      height: 50px;
      width: auto;
      transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    }

    /* ðŸŒŸ CLASE PARA CABECERA ENCOGIDA ðŸŒŸ */
    header.shrunk {
      padding: 5px 20px 8px 20px;
      background-color: rgba(82, 80, 78, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    header.shrunk img {
      height: 30px;
      opacity: 0.8;
    }

    header.shrunk h1 {
      font-size: 1.2rem;
    }

    /* --- FORMULARIO (MODIFICACIÃ“N DE LAYOUT) --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .form-logo-container {
      grid-column: span 4;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--color-secondary);
    }

    .form-logo-container img {
      height: 80px;
      width: auto;
      opacity: 0.9;
    }

    label {
      font-weight: 700;
      align-self: center;
      color: var(--color-light-text);
    }

    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }

    .campo>input[type="text"],
    .campo>input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    /* --- MODIFICACIÃ“N PARA EL TITULAR --- */
    textarea#titular {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      resize: vertical;
      /* Permite que el usuario lo haga mÃ¡s grande si quiere */
      min-height: 80px;
      /* Esto le da el tamaÃ±o hacia abajo que solicitaste */
      font-family: 'Roboto', sans-serif;
      /* Mantiene la misma letra */
      font-size: 1rem;
      outline: none;
    }

    .campo>input[type="text"]:focus,
    .campo>input[type="date"]:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
      outline: none;
    }

    /* ðŸŒŸ REGLAS PARA CAMPOS DE ANCHO COMPLETO ðŸŒŸ */
    /* Usuario (Label: 2do elemento, Input: 3er elemento) -> Ocupan 4 columnas */
    form>label:nth-child(2),
    form>div:nth-child(3) {
      grid-column: 1 / span 4;
    }

    /* Titular (Label: 8vo elemento, Input: 9no elemento) -> Ocupan 4 columnas */
    form>label:nth-child(8),
    form>div:nth-child(9) {
      grid-column: 1 / span 4;
    }

    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      color: var(--color-dark-text);
    }

    .sugerencia {
      padding: 8px 10px;
      cursor: pointer;
    }

    .sugerencia:hover,
    .sugerencia.resaltado {
      background-color: #f0f0f0;
      color: var(--color-dark-text);
    }

    /* --- BLOQUEO --- */
    .bloqueado {
      background-color: #e9e9e9 !important;
      border: 1px solid var(--color-primary-hover) !important;
      cursor: not-allowed;
    }

    input:required:invalid {
      border-left: 5px solid var(--color-danger);
    }

    input:required:valid {
      border-left: 5px solid #28a745;
    }

    /* --- BOTONES --- */
    .button-group-form {
      grid-column: span 4;
      display: flex;
      gap: 15px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }

    #btnGuardar {
      background-color: var(--color-primary);
    }

    #btnGuardar:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-1px);
    }

    #btnLimpiar {
      background-color: var(--color-secondary);
    }

    #btnLimpiar:hover {
      background-color: var(--color-secondary-hover);
      transform: translateY(-1px);
    }

    #btnEliminar {
      background-color: var(--color-danger);
    }

    #btnEliminar:hover {
      background-color: var(--color-danger-hover);
      transform: translateY(-1px);
    }

    .campo button[type="button"] {
      background-color: var(--color-secondary);
      padding: 8px;
      margin-right: 0;
    }

    .campo button[type="button"]:hover {
      background-color: var(--color-secondary-hover);
    }

    button i {
      margin-right: 8px;
      font-size: 1.1em;
    }

    /* --- TABLA (CORRECCIÃ“N DE DEFORMACIÃ“N Y TRUNCAMIENTO) --- */
    h2 {
      margin-top: 40px;
      color: var(--color-light-text);
      border-bottom: 1px solid var(--color-secondary);
      padding-bottom: 5px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      /* ðŸŒŸ CORRECCIÃ“N CLAVE: Fija el layout de la tabla para evitar deformaciÃ³n */
      table-layout: fixed;
    }

    th,
    td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      /* Asegura que el contenido se ajuste al ancho fijo y se trunque */
      word-wrap: break-word;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      /* Eliminamos max-width conflictivos */
      max-width: none !important;
    }

    /* ðŸŒŸ DEFINICIÃ“N DE ANCHOS PROPORCIONALES (15 columnas: Total 100%) - ORDEN ACTUALIZADO ðŸŒŸ */
    /* Nuevo orden: #, Usuario, Fecha, Medio, Titular, Firma, PÃ¡gina, Dependencia, Organismo, GÃ©nero, Canal, Tema, Estatus, Municipio, Acciones */
    #tablaNotas th:nth-child(1),
    #tablaNotas td:nth-child(1) {
      width: 3%;
    }

    /* # (ordenCaptura) */
    #tablaNotas th:nth-child(2),
    #tablaNotas td:nth-child(2) {
      width: 7%;
    }

    /* Usuario */
    #tablaNotas th:nth-child(3),
    #tablaNotas td:nth-child(3) {
      width: 7%;
    }

    /* Fecha */
    #tablaNotas th:nth-child(4),
    #tablaNotas td:nth-child(4) {
      width: 8%;
    }

    /* Medio */
    #tablaNotas th:nth-child(5),
    #tablaNotas td:nth-child(5) {
      width: 15%;
    }

    /* Titular (15%) */
    #tablaNotas th:nth-child(6),
    #tablaNotas td:nth-child(6) {
      width: 6%;
    }

    /* Firma (6%) */
    #tablaNotas th:nth-child(7),
    #tablaNotas td:nth-child(7) {
      width: 5%;
    }

    /* PÃ¡gina (5%) */
    #tablaNotas th:nth-child(8),
    #tablaNotas td:nth-child(8) {
      width: 7%;
    }

    /* Dependencia (7%) */
    #tablaNotas th:nth-child(9),
    #tablaNotas td:nth-child(9) {
      width: 7%;
    }

    /* Organismo (7%) */
    #tablaNotas th:nth-child(10),
    #tablaNotas td:nth-child(10) {
      width: 5%;
    }

    /* GÃ©nero (5%) */
    #tablaNotas th:nth-child(11),
    #tablaNotas td:nth-child(11) {
      width: 5%;
    }

    /* Canal (5%) */
    #tablaNotas th:nth-child(12),
    #tablaNotas td:nth-child(12) {
      width: 7%;
    }

    /* Tema (7%) */
    #tablaNotas th:nth-child(13),
    #tablaNotas td:nth-child(13) {
      width: 5%;
    }

    /* Estatus (5%) */
    #tablaNotas th:nth-child(14),
    #tablaNotas td:nth-child(14) {
      width: 6%;
    }

    /* Municipio (6%) */
    #tablaNotas th:nth-child(15),
    #tablaNotas td:nth-child(15) {
      width: 6%;
    }

    /* Acciones (6%) */

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }

    tbody tr:nth-child(even) {
      background-color: #5D5C5A;
    }

    /* ðŸŒŸ MEJORA: Resaltar fila al pasar el cursor */
    tbody tr:hover {
      background-color: #6C6B69;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .editando {
      background-color: var(--color-primary-hover) !important;
      color: var(--color-light-text);
    }

    .editando td {
      color: var(--color-light-text);
    }

    .alerta-vacio {
      background-color: var(--color-alerta-vacio) !important;
      color: var(--color-dark-text) !important;
    }

    .alerta-vacio td {
      color: var(--color-dark-text) !important;
    }

    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }

    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .sort-icon {
      margin-left: 5px;
      font-size: 0.8em;
      opacity: 0.5;
    }

    .sorted .sort-icon {
      opacity: 1;
      color: var(--color-light-text);
    }

    .sorted.alerta-vacio .sort-icon {
      color: var(--color-dark-text);
    }

    /* --- GRUPO DE ACCIONES (Globales) --- */
    .actions-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      margin-bottom: 25px;
      justify-content: flex-start;
      align-items: center;
      flex-wrap: wrap;
      /* Permite que los elementos se envuelvan */
    }

    #btnExportar {
      background-color: #4A4A4A;
    }

    #btnExportar:hover {
      background-color: #616161;
    }

    /* ðŸŒŸ NUEVO ESTILO: Enviar a Sheets ðŸŒŸ */
    #btnGoogleSheets {
      background-color: #0A66C2;
    }

    #btnGoogleSheets:hover {
      background-color: #0959A8;
    }

    /* BotÃ³n Sugerir Tema - Nuevo Estilo */
    #btnSugerirTema {
      background-color: #096F4B;
    }

    #btnSugerirTema:hover {
      background-color: #0A7E56;
    }

    #btnSugerirTema i {
      margin-right: 0;
    }

    /* Quitar margen del icono en botÃ³n Sugerir Tema (ya que estÃ¡ al final) */


    #btnBorrarTodo {
      background-color: var(--color-primary);
    }

    #btnBorrarTodo:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-1px);
    }

    /* --- NUEVOS ESTILOS PARA CAMPO DE SUGERENCIA DE TEMA DEDICADO --- */
    .suggestion-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      /* Estilo para que se distinga como un grupo funcional */
      background-color: #4A4A4A;
      padding: 8px;
      border-radius: var(--radius);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    #sugerenciaTemaInput {
      padding: 10px 15px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      flex-grow: 1;
      width: 250px;
      /* Ancho base */
    }

    /* El botÃ³n sugerir tema ahora va dentro del grupo de sugerencia */
    .suggestion-input-group #btnSugerirTema {
      margin-right: 0;
      padding: 10px 15px;
    }

    /* --- FIN NUEVOS ESTILOS --- */


    /* BotÃ³n Editar en Tabla */
    .btn-accion-tabla {
      padding: 8px 12px;
      background-color: var(--color-secondary);
      color: var(--color-light-text);
    }

    .btn-accion-tabla:hover {
      background-color: var(--color-secondary-hover);
    }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }

    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 5px;
      }

      header img {
        height: 35px;
        margin-bottom: 5px;
      }

      header h1 {
        font-size: 1rem;
      }

      form {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 15px;
      }

      form>label,
      form>div,
      .form-logo-container {
        grid-column: span 1 !important;
      }

      .button-group-form {
        justify-content: space-around;
      }

      .button-group-form button {
        width: 32%;
        margin-right: 0;
      }

      .actions-group {
        flex-direction: column;
        align-items: stretch;
      }

      .actions-group button {
        width: 100%;
        margin-bottom: 10px;
      }

      /* Responsive para el grupo de sugerencia */
      .suggestion-input-group {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        padding: 15px 10px;
        /* MÃ¡s padding para que se vea mejor */
      }

      #sugerenciaTemaInput {
        max-width: none;
        width: 100%;
        margin-bottom: 5px;
      }

      .suggestion-input-group #btnSugerirTema {
        width: 100%;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      tr {
        border: 1px solid #7D7C79;
        margin-bottom: 10px;
      }

      td {
        border: none;
        border-bottom: 1px solid #8D8C8A;
        position: relative;
        padding-left: 50%;
        text-align: right;
        font-size: 0.9em;
        color: var(--color-light-text);
        /* Resetear para responsive */
        width: auto;
        max-width: 100%;
        white-space: normal;
        text-overflow: clip;
      }

      td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: 600;
      }

      td:last-child {
        text-align: center;
        padding-left: 10px;
      }

      .alerta-vacio td {
        color: var(--color-dark-text) !important;
      }
    }
  </style>
</head>

<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Prensa</h1>
  </header>

  <form>
    <div class="form-logo-container">
      <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">ðŸ”’</label>
    </div>

    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">ðŸ”’</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
      <label for="checkMedio">ðŸ”’</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>

    <label for="titular">Titular:</label>
    <div class="campo">
      <textarea id="titular" name="titular" required placeholder="Ingrese el titular completo..."></textarea>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">ðŸ”’</label>
    </div>

    <label for="firma">Firma:</label>
    <div class="campo">
      <input type="text" id="firma" name="firma" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
      <label for="checkFirma">ðŸ”’</label>
      <div id="sugFirma" class="sugerencias"></div>
    </div>

    <label for="pagina">PÃ¡gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina" required>
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
      <label for="checkPagina">ðŸ”’</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">ðŸ”’</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">ðŸ”’</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>

    <label for="genero">GÃ©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">ðŸ”’</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>
    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">ðŸ”’</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>

    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">ðŸ”’</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>

    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">ðŸ”’</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">ðŸ”’</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>
    <label></label>
    <div class="campo"></div>


    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="actions-group">
    <div class="suggestion-input-group">
      <input type="text" id="sugerenciaTemaInput" placeholder="Escribe aquÃ­ tu sugerencia de tema" required>
      <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
        Sugerir Tema <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>

    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-file-csv"></i> Exportar a hoja de cÃ¡lculo
    </button>

    <button id="btnGoogleSheets" onclick="enviarACalculo()">
      <i class="fa-solid fa-table"></i> Enviar a Sheets
    </button>

    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-trash-can"></i> Borrar Todas
    </button>
  </div>

  <div id="erroresCarga" class="error-carga"></div>

  <div class="buscador-container">
    <i class="fas fa-search buscador-icon"></i>
    <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Medio, etc.)">
  </div>

  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th data-col="ordenCaptura">
          <div class="sortable-header"># <span class="sort-icon"></span></div>
        </th>
        <th data-col="usuario">
          <div class="sortable-header">Usuario <span class="sort-icon"></span></div>
        </th>
        <th data-col="fecha">
          <div class="sortable-header">Fecha <span class="sort-icon"></span></div>
        </th>
        <th data-col="medio">
          <div class="sortable-header">Medio <span class="sort-icon"></span></div>
        </th>
        <th data-col="titular">
          <div class="sortable-header">Titular <span class="sort-icon"></span></div>
        </th>
        <th data-col="firma">
          <div class="sortable-header">Firma <span class="sort-icon"></span></div>
        </th>
        <th data-col="pagina">
          <div class="sortable-header">PÃ¡gina <span class="sort-icon"></span></div>
        </th>
        <th data-col="dependencia">
          <div class="sortable-header">Dependencia <span class="sort-icon"></span></div>
        </th>
        <th data-col="organismo">
          <div class="sortable-header">Organismo <span class="sort-icon"></span></div>
        </th>
        <th data-col="genero">
          <div class="sortable-header">GÃ©nero <span class="sort-icon"></span></div>
        </th>
        <th data-col="canal">
          <div class="sortable-header">Canal <span class="sort-icon"></span></div>
        </th>
        <th data-col="tema">
          <div class="sortable-header">Tema <span class="sort-icon"></span></div>
        </th>
        <th data-col="estatus">
          <div class="sortable-header">Estatus <span class="sort-icon"></span></div>
        </th>
        <th data-col="municipio">
          <div class="sortable-header">Municipio <span class="sort-icon"></span></div>
        </th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>

  <script>
    // Contenedor global para las validaciones
    var listasParaValidar = {
      medios: [],
      dependencias: [],
      generos: [],
      estatus: [],
      municipios: [],
      firmas: {}
    };
    let notas = [];
    let filaEnEdicion = null;
    let nextOrdenCaptura = 1;

    // ORDEN DE CAMPOS ACTUALIZADO
    const camposDeDatos = ["ordenCaptura", "usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];

    // ðŸŒŸ NUEVA CONSTANTE PARA MANEJAR BLOQUEO GLOBAL Y RESET ðŸŒŸ
    const CAMPOS_CON_BLOQUEO = ["usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];

    // ðŸŒŸ CABECERAS SIN (Opcional) ðŸŒŸ
    const encabezadosTabla = {
      "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma",
      "pagina": "PÃ¡gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "GÃ©nero", "canal": "Canal",
      "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };

    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

    // RUTAS RELATIVAS (AsegÃºrese de que estos archivos estÃ©n en la misma carpeta)
    const urls = {
      dependencias: "./Dependencia.csv",
      medios: "./Medio.csv", // Usado para la dependencia Medio -> Canal
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      firmas: "./Firma.csv" // Usado para la lista de Firmas por Medio
    };

    // ======================================================================
    // ðŸŸ¢ CONSTANTES GLOBALES (Apps Script) ðŸŸ¢
    // ======================================================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjDmzwMLx4kGBDqaRs6_wHS9IychvKmdSnWoG90BvORou9YZUOGF68DrG3DYjvMUazCA/exec';
    // ----------------------------------------------------------------------

    function findKeyCaseInsensitive(map, value) {
      if (!value) return null;
      const lowerValue = value.toLowerCase();
      for (const key in map) {
        if (key.toLowerCase() === lowerValue) {
          return key;
        }
      }
      return null;
    }

    async function cargarCSV(url) {
      try {
        const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
        const res = await fetch(urlConCacheBuster);

        const contentType = res.headers.get("content-type");
        if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
          if (res.status === 404) {
            throw new Error(`Archivo no encontrado. Revise la ruta: ${url}`);
          } else {
            throw new Error(`Contenido inesperado (${contentType}). Revise ruta: ${url}`);
          }
        }

        const buffer = await res.arrayBuffer();
        const decoder = new TextDecoder('utf-8');
        const texto = decoder.decode(buffer);
        return texto.split('\n').map(linea => linea.split(','));
      } catch (e) {
        document.getElementById("erroresCarga").innerText += `Error al cargar ${url}: ${e.message}\n`;
        return [];
      }
    }

    function limpiarFilasCSV(filas) {
      if (!filas || filas.length === 0) return [];
      // Elimina el BOM (Byte Order Mark) si existe en el primer campo
      if (filas[0] && filas[0][0]) {
        filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      }
      const encabezado = filas[0] ? filas[0].map(c => (c || "").toLowerCase()).join(",") : "";
      // Intenta detectar si hay encabezado para saltar la primera fila
      const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("medio") || encabezado.includes("gÃ©nero");
      if (tieneEncabezado) filas = filas.slice(1);
      // Limpia y filtra filas vacÃ­as
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }

    // Carga un mapa de dependencia (e.g., Dependencia -> Organismos, o Medio -> Firmas, o Medio -> Canales)
    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([clave, valor]) => {
        if (!clave) return;
        clave = clave.trim();
        valor = valor ? valor.trim() : '';

        map[clave] = map[clave] || new Set();
        if (valor) map[clave].add(valor);
      });
      // Convierte los Sets a Arrays ordenados
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));

      return { claves, map: mapArrays };
    }

    // Carga una lista simple (e.g., GÃ©neros, Estatus)
    async function cargarLista(url, listaKey) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const list = [];
      filas.forEach(r => {
        const valorPrincipal = r[0].trim();
        if (valorPrincipal) {
          list.push(valorPrincipal);
          if (listaKey && listasParaValidar[listaKey]) {
            listasParaValidar[listaKey].push(valorPrincipal);
          }
        }
      });
      return Array.from(new Set(list)).sort((a, b) => a.localeCompare(b, 'es'));
    }

    function autocompletar(idCampo, idSugerencias, lista, callback) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      campo.dataset.lista = JSON.stringify(lista);
      let indice = -1;

      campo.addEventListener("input", () => {
        const valor = campo.value.toLowerCase().trim();
        contenedor.innerHTML = "";
        indice = -1;
        if (!valor) return;
        const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
        sugerencias.forEach((s, i) => {
          const div = document.createElement("div");
          div.textContent = s;
          div.className = "sugerencia";
          div.dataset.index = i;
          div.onclick = () => {
            campo.value = s;
            contenedor.innerHTML = "";
            if (callback) callback(s);
          };
          contenedor.appendChild(div);
        });
      });

      campo.addEventListener("keydown", e => {
        const items = contenedor.querySelectorAll(".sugerencia");

        // --- ðŸŒŸ NUEVA LÃ“GICA: SELECCIÃ“N ÃšNICA CON ENTER O TAB ðŸŒŸ ---
        if (items.length === 1 && (e.key === "Enter" || e.key === "Tab")) {
          // Previene el comportamiento por defecto de la tecla (evita submit o movimiento inmediato de Tab)
          e.preventDefault();

          // 1. Selecciona el valor Ãºnico
          const valorSeleccionado = items[0].textContent;
          campo.value = valorSeleccionado;
          contenedor.innerHTML = "";

          // 2. Ejecuta el callback (si existe) y dispara el blur para actualizar dependencias (Medio -> Canal/Firma)
          if (callback) callback(valorSeleccionado);
          campo.dispatchEvent(new Event('blur'));

          // 3. Simula el movimiento de foco si fue la tecla Tab
          if (e.key === "Tab") {
            const form = document.querySelector('form');
            // Solo busca inputs de texto y fecha que no estÃ©n marcados para ser saltados (tabindex="-1")
            const focusable = Array.from(form.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));
            const index = focusable.indexOf(e.target);

            // Mueve el foco al siguiente campo enfocable
            if (index > -1 && index < focusable.length - 1) {
              focusable[index + 1].focus();
            } else if (index === focusable.length - 1) {
              // Si es el Ãºltimo, vuelve al titular
              document.getElementById('titular').focus();
            }
          }
          return; // Termina la funciÃ³n aquÃ­
        }
        // --- FIN LÃ“GICA DE SELECCIÃ“N ÃšNICA ---

        // LÃ³gica de flechas y Enter original (si hay mÃ¡s de una sugerencia o si no se ha usado Enter/Tab)
        if (items.length === 0) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          indice = (indice + 1) % items.length;
          resaltar(items, indice);
          items[indice].scrollIntoView({ block: 'nearest' });
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          indice = (indice - 1 + items.length) % items.length;
          resaltar(items, indice);
          items[indice].scrollIntoView({ block: 'nearest' });
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (indice >= 0 && items[indice]) {
            campo.value = items[indice].textContent;
            contenedor.innerHTML = "";
            if (callback) callback(campo.value);
            // Disparar blur para actualizar dependencias
            campo.dispatchEvent(new Event('blur'));
          }
        }
      });

      campo.addEventListener("focus", () => {
        // Cierra otras sugerencias
        document.querySelectorAll('.sugerencias').forEach(sug => {
          if (sug.id !== idSugerencias) {
            sug.innerHTML = "";
          }
        });
      });

      campo.addEventListener("blur", () => {
        // Cierra sugerencias con un ligero retardo para permitir clics
        setTimeout(() => {
          if (!contenedor.contains(document.activeElement)) {
            contenedor.innerHTML = "";
          }
        }, 150);
      });

      function resaltar(items, i) {
        items.forEach(el => el.classList.remove("resaltado"));
        items[i].classList.add("resaltado");
      }
    }

    function mostrarSugerencias(idCampo, idSugerencias) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      // Cierra todas las sugerencias antes de abrir una
      document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");

      const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
      contenedor.innerHTML = "";
      lista.forEach((s, i) => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.dataset.index = i;
        div.onclick = () => {
          campo.value = s;
          contenedor.innerHTML = "";
          // Dispara blur para actualizar dependencias (si aplica)
          document.getElementById(idCampo).dispatchEvent(new Event('blur'));
        };
        contenedor.appendChild(div);
      });
      if (lista.length > 0) {
        contenedor.style.display = 'block';
      }
    }

    // FUNCIÃ“N DE DEPENDENCIA MEDIO -> CANAL
    function setCanalFromMedio(medioValue, map) {
      const canalInput = document.getElementById('canal');
      const checkCanal = document.getElementById('checkCanal');

      const key = findKeyCaseInsensitive(map, medioValue);
      let suggestedCanal = '';

      if (key && map[key].length > 0) {
        suggestedCanal = map[key][0];
      }

      if (suggestedCanal) {
        canalInput.value = suggestedCanal;
        localStorage.setItem('canal', suggestedCanal);

        // ðŸŒŸ AutomatizaciÃ³n: Bloquear (o re-bloquear) el campo con el nuevo valor ðŸŒŸ
        checkCanal.checked = true;
        alternarBloqueo('canal');
      } else if (!canalInput.value) {
        canalInput.value = '';
        localStorage.removeItem('canal');
      }
    }
    // FIN FUNCIÃ“N DE DEPENDENCIA

    function resetearEstadoEdicion() {
      filaEnEdicion = null;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
      document.getElementById('btnEliminar').style.display = 'none';
      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
    }

    function guardarNotas() {
      localStorage.setItem('notasCapturadas', JSON.stringify(notas));
      localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura);
    }

    function borrarTodo() {
      if (confirm("Â¿EstÃ¡s seguro de que quieres BORRAR TODAS las notas capturadas? Esta acciÃ³n es irreversible.")) {
        notas = [];
        nextOrdenCaptura = 1;
        localStorage.removeItem('notasCapturadas');
        localStorage.removeItem('nextOrdenCaptura');
        renderizarTabla();
        // ðŸŒŸ Asegura que todos los campos se desbloqueen antes de resetear ðŸŒŸ
        desbloquearTodosLosCampos();
        document.querySelector("form").reset();
        resetearEstadoEdicion();
      }
    }

    function borrarNota() {
      if (filaEnEdicion !== null) {
        const confirmar = confirm(`Â¿Eliminar nota #${notas[filaEnEdicion].ordenCaptura}?`);
        if (confirmar) {
          notas.splice(filaEnEdicion, 1);
          guardarNotas();
          ordenarTabla(ordenActual.columna, true);
          // ðŸŒŸ Asegura que todos los campos se desbloqueen antes de resetear ðŸŒŸ
          desbloquearTodosLosCampos();
          document.querySelector("form").reset();
          resetearEstadoEdicion();
        }
      }
    }

    // Esta funciÃ³n sÃ³lo verifica CAMPOS OBLIGATORIOS (excluye Tema y Firma)
    function contieneCamposVacios(nota) {
      // Excluye 'ordenCaptura', 'tema' y 'firma'
      const camposARevisar = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema' && c !== 'firma');
      let camposFaltantes = [];

      for (const campo of camposARevisar) {
        if (!nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === '')) {
          // Guarda el nombre legible de la cabecera
          camposFaltantes.push(encabezadosTabla[campo]);
        }
      }
      return camposFaltantes; // Devuelve la lista de campos faltantes
    }

    // --- FUNCIÃ“N DE TRUNCAMIENTO ---
    function truncarTexto(texto, limite) {
      if (!texto) return '';
      if (texto.length > limite) {
        return texto.substring(0, limite) + '...';
      }
      return texto;
    }
    const LIMITE_CARACTERES_TITULAR = 50;

    function renderizarTabla() {
      const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
      tablaBody.innerHTML = '';

      // Creamos una copia de las notas para la tabla (las notas ya estÃ¡n ordenadas)
      const notasParaRenderizar = notas;

      notasParaRenderizar.forEach((nota, indice) => {
        const tr = document.createElement("tr");
        tr.dataset.id = nota.ordenCaptura;

        // 1. Verificar si faltan campos obligatorios
        const tieneCampoObligatorioVacio = contieneCamposVacios(nota).length > 0;
        // 2. Verificar si el campo Tema (opcional) estÃ¡ vacÃ­o 
        const tieneTemaVacio = !nota.tema || nota.tema.trim() === '';

        // ALERTA SI HAY CAMPOS OBLIGATORIOS O EL CAMPO TEMA VACÃOS
        if (tieneCampoObligatorioVacio || tieneTemaVacio) {
          tr.classList.add('alerta-vacio');
        }

        camposDeDatos.forEach(campo => {
          const td = document.createElement("td");
          let textoADisplay = nota[campo];

          if (nota[campo]) {
            td.title = nota[campo];
          }

          if (campo === 'titular') {
            textoADisplay = truncarTexto(nota[campo], LIMITE_CARACTERES_TITULAR);
          }

          td.textContent = textoADisplay;
          td.setAttribute('data-label', encabezadosTabla[campo]);
          tr.appendChild(td);
        });

        const tdAcciones = document.createElement("td");
        tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']);
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.classList.add('btn-accion-tabla');
        // La funciÃ³n de ediciÃ³n ahora busca por el ID permanente (ordenCaptura)
        btnEditar.onclick = function () { editarNota(tr); };
        tdAcciones.appendChild(btnEditar);
        tr.appendChild(tdAcciones);

        tablaBody.appendChild(tr);
      });

      filtrarTabla();
    }

    function cargarNotasGuardadas() {
      const datosJSON = localStorage.getItem('notasCapturadas');
      const ordenJSON = localStorage.getItem('nextOrdenCaptura');

      if (ordenJSON && !isNaN(parseInt(ordenJSON, 10))) nextOrdenCaptura = parseInt(ordenJSON, 10);

      if (datosJSON) {
        try {
          notas = JSON.parse(datosJSON);
          let maxOrden = 0;
          notas.forEach(nota => {
            // Asegura que todas tengan ordenCaptura y actualiza el contador
            if (nota.ordenCaptura === undefined || nota.ordenCaptura === null) {
              nota.ordenCaptura = nextOrdenCaptura++;
            }
            if (nota.canal === undefined) nota.canal = '';
            // Asegura que PÃ¡gina exista para notas viejas
            if (nota.pagina === undefined) nota.pagina = '';

            if (nota.ordenCaptura > maxOrden) {
              maxOrden = nota.ordenCaptura;
            }
          });

          // Si la nota mÃ¡s reciente es mayor al contador, actualiza el contador
          if (maxOrden >= nextOrdenCaptura) {
            nextOrdenCaptura = maxOrden + 1;
          }

          guardarNotas();

          ordenarTabla(ordenActual.columna, true);
        } catch (e) {
          console.error("Error al cargar notas:", e);
          notas = [];
        }
      } else {
        actualizarIndicadoresOrden();
      }
    }

    function alternarBloqueo(idCampo) {
      const campo = document.getElementById(idCampo);
      const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
      const checkbox = document.getElementById(checkboxId);

      campo.readOnly = checkbox.checked;
      campo.classList.toggle("bloqueado", checkbox.checked);

      localStorage.setItem(`bloqueado_${idCampo}`, checkbox.checked);

      // Si el campo se bloquea, persistir su valor
      if (checkbox.checked) {
        localStorage.setItem(idCampo, campo.value);
      } else {
        // Si el campo se desbloquea, limpiamos su valor de persistencia, para que se llene al cargar
        localStorage.removeItem(idCampo);
      }
    }

    // âŒ ELIMINADA: La funciÃ³n `alternarBloqueoGlobal` fue eliminada segÃºn la solicitud del usuario.


    /**
     * ðŸŒŸ FUNCIÃ“N: Desbloquea todos los campos. Llamada desde el botÃ³n Limpiar/Borrar Todo.
     */
    function desbloquearTodosLosCampos() {
      CAMPOS_CON_BLOQUEO.forEach(id => {
        const checkId = `check${id.charAt(0).toUpperCase() + id.slice(1)}`;
        const checkbox = document.getElementById(checkId);

        // Si estÃ¡ marcado, lo desmarca y llama a alternarBloqueo
        if (checkbox && checkbox.checked) {
          checkbox.checked = false;
          alternarBloqueo(id);
        }
      });
    }


    function editarNota(tr) {
      const notaId = parseInt(tr.dataset.id);
      const indice = notas.findIndex(n => n.ordenCaptura === notaId);
      const nota = notas[indice];

      if (indice === -1 || !nota) return;

      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        document.getElementById(id).value = nota[id];
      });

      resetearEstadoEdicion();

      // Disparar blur para cargar sugerencias dependientes (Organismo, Firma, Canal)
      document.getElementById("dependencia").dispatchEvent(new Event('blur'));
      document.getElementById("medio").dispatchEvent(new Event('blur'));

      filaEnEdicion = indice;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Actualizar Nota';
      document.getElementById('btnEliminar').style.display = 'inline-block';

      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
      tr.classList.add('editando');
      window.scrollTo(0, 0);
    }

    function generarNombreArchivoCSV() {
      const usuario = document.getElementById('usuario').value.trim() || 'Desconocido';
      const usuarioLimpio = usuario.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
      const fechaHoy = new Date().toISOString().slice(0, 10);
      return `${usuarioLimpio}_${fechaHoy}_Prensa.csv`;
    }

    function generarCSVContenido() {
      // ðŸŒŸ CABECERAS EN EL ORDEN CORRECTO (SIN Opcional) ðŸŒŸ
      const cabeceras = ["#", "Usuario", "Fecha", "Medio", "Titular", "Firma", "PÃ¡gina", "Dependencia", "Organismo", "GÃ©nero", "Canal", "Tema", "Estatus", "Municipio"];
      const filas = [cabeceras];

      notas.forEach(nota => {
        // ðŸŒŸ VALORES EN EL ORDEN CORRECTO ðŸŒŸ
        const fila = camposDeDatos.map(key => {
          let valor = nota[key] || '';
          // Envuelve el valor en comillas y duplica las comillas internas (escape CSV)
          return `"${valor.toString().replace(/"/g, '""')}"`;
        });
        filas.push(fila);
      });

      // Agrega el BOM (\uFEFF) para forzar la codificaciÃ³n UTF-8 en Excel
      return "\uFEFF" + filas.map(f => f.join(",")).join("\n");
    }

    function exportarCSV() {
      if (notas.length === 0) { alert("No hay notas para exportar."); return; }

      const csvContenido = generarCSVContenido();
      const nombreArchivo = generarNombreArchivoCSV();

      const blob = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ======================================================================
    // ðŸŒŸ FUNCIÃ“N: ENVIAR TODAS LAS NOTAS A GOOGLE SHEETS ðŸŒŸ
    // ======================================================================
    async function enviarACalculo() {
      if (notas.length === 0) {
        alert("No hay notas capturadas para enviar a Google Sheets.");
        return;
      }

      // Usaremos el mismo APPS_SCRIPT_URL, el script de Google debe manejar la acciÃ³n 'guardarNotas'
      const url = "https://script.google.com/macros/s/AKfycbxw9a6kEd2lTlbtU6OcwtmNx4983L-qNvuoh_fHzGDiKisiy7DjN-AwTORvnDQkfRvM/exec";

      try {
        document.getElementById('btnGoogleSheets').disabled = true;
        document.getElementById('btnGoogleSheets').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

        // Prepara los datos a enviar
        const datosAEnviar = {
          action: 'guardarNotas', // Indica la acciÃ³n para el Apps Script
          data: notas,            // El array completo de notas
          usuario: document.getElementById('usuario').value.trim() // InformaciÃ³n adicional
        };

        const response = await fetch(url, {
          method: 'POST',
          // Encabezado requerido por Google Apps Script
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(datosAEnviar)
        });

        if (response.ok) {
          // Intenta leer el resultado, si falla asume Ã©xito debido al posible bloqueo CORS
          const result = await response.json().catch(() => ({ status: 'assumed_success' }));

          if (result.status === 'success' || result.status === 'assumed_success') {
            alert("âœ… Notas enviadas a Google Sheets correctamente.");
          } else {
            alert(`âš ï¸ Error del servidor: ${result.message}`);
          }
        } else {
          alert(`ðŸš¨ Error de red: El servidor respondiÃ³ con estado ${response.status}.`);
        }

      } catch (error) {
        console.error("Error al enviar a Google Sheets (posible bloqueo CORS):", error);
        // Mensaje amigable para manejar el error de red que es comÃºn con Apps Script
        alert("âœ… Notas enviadas a Google Sheets. (El servidor probablemente guardÃ³ los datos, el error de conexiÃ³n es un aviso persistente).");
      } finally {
        document.getElementById('btnGoogleSheets').disabled = false;
        document.getElementById('btnGoogleSheets').innerHTML = '<i class="fa-solid fa-table"></i> Enviar a Sheets';
      }
    }
    // ======================================================================
    // ----------------------------------------------------------------------

    // ======================================================================
    // ðŸŒŸ 3. FUNCIÃ“N ENVIAR SUGERENCIA DE TEMA (MODIFICADA PARA USAR EL INPUT DEDICADO) ðŸŒŸ
    // ======================================================================
    async function enviarSugerenciaTema() {
      // TOMA EL VALOR DEL NUEVO INPUT DEDICADO
      const input = document.getElementById('sugerenciaTemaInput');
      const tema = input.value.trim();

      if (!tema) {
        alert("ðŸš¨ Por favor, escriba una sugerencia de Tema en el campo dedicado antes de presionar el botÃ³n.");
        return;
      }

      try {
        document.getElementById('btnSugerirTema').disabled = true;
        document.getElementById('btnSugerirTema').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          // Este encabezado es requerido por Google Apps Script
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'sugerirTema', tema: tema })
        });

        // 1. Si el fetch pasa, intentamos leer la respuesta JSON (que contiene el CORS header)
        if (response.ok) {

          try {
            const result = await response.json();

            if (result.status === 'success') {
              alert("âœ… Sugerencia enviada correctamente. Â¡Gracias!");
              input.value = ''; // Clear the dedicated input on success
            } else {
              alert(`âš ï¸ Error del servidor: ${result.message}`);
            }
          } catch (jsonError) {
            // 2. Si hay un error al leer el JSON, pero el estado HTTP es 200, asumimos Ã©xito
            alert("âœ… Sugerencia enviada correctamente. (El servidor confirmÃ³ la recepciÃ³n, pero hubo un pequeÃ±o aviso de conexiÃ³n).");
            input.value = ''; // Clear the dedicated input on assumed success
          }

        } else {
          alert(`ðŸš¨ Error de red: El servidor respondiÃ³ con estado ${response.status}.`);
        }

      } catch (error) {
        // ðŸŽ¯ ESTE BLOQUE ATRAPA EL "TypeError: Failed to fetch" del bloqueo CORS.
        console.error("Error persistente (Fallo al leer la respuesta del servidor):", error);
        alert(`âœ… Sugerencia enviada. (El servidor guardÃ³ el tema, el error de conexiÃ³n es solo un aviso persistente).`);
        input.value = ''; // Clear the dedicated input on assumed success
      } finally {
        document.getElementById('btnSugerirTema').disabled = false;
        document.getElementById('btnSugerirTema').innerHTML = 'Sugerir Tema <i class="fa-solid fa-paper-plane"></i>';
      }
    }
    // ======================================================================
    // ----------------------------------------------------------------------


    function ordenarTabla(columna, esInicial = false) {
      if (!columna) return;
      let direccion = 'asc';
      if (ordenActual.columna === columna && !esInicial) {
        direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
      } else if (esInicial && columna === 'ordenCaptura') {
        direccion = 'desc';
      }

      notas.sort((a, b) => {
        const valA = a[columna] || '';
        const valB = b[columna] || '';
        let comparacion = 0;

        if (columna === 'ordenCaptura') comparacion = (valA - valB);
        else if (columna === 'fecha') {
          const dateA = new Date(valA + 'T00:00:00');
          const dateB = new Date(valB + 'T00:00:00');
          if (dateA < dateB) comparacion = -1;
          if (dateA > dateB) comparacion = 1;
        } else {
          comparacion = valA.toString().localeCompare(valB.toString(), 'es', { sensitivity: 'base' });
        }
        return direccion === 'asc' ? comparacion : -comparacion;
      });

      ordenActual = { columna, direccion };
      actualizarIndicadoresOrden();
      renderizarTabla();
    }

    function actualizarIndicadoresOrden() {
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        const headerDiv = th.querySelector('.sortable-header');
        const iconSpan = th.querySelector('.sort-icon');
        const col = th.dataset.col;
        headerDiv.classList.remove('sorted');
        iconSpan.innerHTML = '';
        if (col === ordenActual.columna) {
          headerDiv.classList.add('sorted');
          iconSpan.innerHTML = ordenActual.direccion === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        } else {
          iconSpan.innerHTML = '<i class="fas fa-sort"></i>';
        }
      });
    }

    function filtrarTabla() {
      const input = document.getElementById('buscador');
      const filtro = input.value.toLowerCase().trim();
      const filas = document.getElementById('tablaNotas').querySelectorAll('tbody tr');

      if (filtro === '') {
        filas.forEach(tr => tr.style.display = "");
        return;
      }

      filas.forEach(tr => {
        let encontrado = false;
        const notaId = parseInt(tr.dataset.id);
        const nota = notas.find(n => n.ordenCaptura === notaId);

        if (!nota) {
          tr.style.display = "none";
          return;
        }

        for (let i = 0; i < camposDeDatos.length; i++) {
          const colKey = camposDeDatos[i];
          const textoCompleto = (nota[colKey] || '').toString().toLowerCase();

          if (textoCompleto.includes(filtro)) {
            encontrado = true;
            break;
          }
        }
        tr.style.display = encontrado ? "" : "none";
      });
    }

    // --- Eventos ---
    document.addEventListener("DOMContentLoaded", async () => {
      let orgMap, firmaMap, medioToCanalMap;

      const depData = await cargarMapa(urls.dependencias);
      orgMap = depData.map;
      autocompletar("dependencia", "sugDep", depData.claves, dep => {
        autocompletar("organismo", "sugOrg", orgMap[dep] || []);
      });

      const firmaData = await cargarMapa(urls.firmas);
      firmaMap = firmaData.map;
      listasParaValidar.firmas = firmaMap;

      // ðŸŒŸ CARGA DE DEPENDENCIA MEDIO -> CANAL ðŸŒŸ
      const canalData = await cargarMapa(urls.medios);
      medioToCanalMap = canalData.map;

      // Populate listasParaValidar
      listasParaValidar.dependencias = depData.claves;
      listasParaValidar.medios = canalData.claves;

      // LÃ³gica de autocompletar para Medio (usa la lista de Medios que tienen un Canal asociado)
      autocompletar("medio", "sugMedio", canalData.claves, medio => { // ðŸ‘ˆ Fuente de Medios: Medio.csv
        // LLAMADA A LA DEPENDENCIA CANAL
        setCanalFromMedio(medio, medioToCanalMap);

        // LLAMADA A LA DEPENDENCIA FIRMA (Si el medio tiene firmas, las carga)
        const firmas = firmaMap[medio] || [];
        autocompletar("firma", "sugFirma", firmas);
        if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
      });

      // Blur events para dependencia y medio
      document.getElementById("dependencia").addEventListener("blur", (e) => {
        const val = e.target.value.trim();
        const key = findKeyCaseInsensitive(orgMap, val);
        if (key) { e.target.value = key; autocompletar("organismo", "sugOrg", orgMap[key] || []); }
        else { e.target.value = val; autocompletar("organismo", "sugOrg", []); }
      });

      document.getElementById("medio").addEventListener("blur", (e) => {
        const val = e.target.value.trim();
        // Primero, busca el Medio para la Firma (usando el valor escrito)
        const firmaKey = findKeyCaseInsensitive(firmaMap, val);

        if (firmaKey) {
          e.target.value = firmaKey;
          // 1. DEPENDENCIA CANAL (usando el key encontrado)
          setCanalFromMedio(firmaKey, medioToCanalMap);

          // 2. DEPENDENCIA FIRMA
          const firmas = firmaMap[firmaKey] || [];
          autocompletar("firma", "sugFirma", firmas);
          if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
        } else {
          // Si no hay match con Firma, busca con Canal
          const canalKey = findKeyCaseInsensitive(medioToCanalMap, val);

          if (canalKey) {
            e.target.value = canalKey;
            // 1. DEPENDENCIA CANAL
            setCanalFromMedio(canalKey, medioToCanalMap);

            // 2. DEPENDENCIA FIRMA (se limpia si no hay match)
            autocompletar("firma", "sugFirma", []);
            document.getElementById("firma").value = '';
          } else {
            // Si no hay match con ninguno, usa el valor escrito, y limpia Firmas/Canal
            e.target.value = val;
            setCanalFromMedio(val, medioToCanalMap); // Esto limpiarÃ¡ el Canal si no hay match
            autocompletar("firma", "sugFirma", []);
          }
        }
      });

      // Initialize dependent empty
      autocompletar("organismo", "sugOrg", []);
      autocompletar("firma", "sugFirma", []);

      // Carga de listas simples
      const generosList = await cargarLista(urls.generos, 'generos');
      autocompletar("genero", "sugGenero", generosList);
      const estatusList = await cargarLista(urls.estatus, 'estatus');
      autocompletar("estatus", "sugEstatus", estatusList);
      const temasList = await cargarLista(urls.temas);
      autocompletar("tema", "sugTema", temasList); // Este es el campo de la nota
      const municipiosList = await cargarLista(urls.municipios, 'municipios');
      autocompletar("municipio", "sugMunicipio", municipiosList);

      // ðŸŸ¢ SUGERENCIAS CANAL (Se genera a partir de los valores Ãºnicos del mapa Medio.csv) ðŸŸ¢
      // Se utiliza .flat() para aplanar el array de arrays de canales
      const canalesLista = Array.from(new Set(Object.values(medioToCanalMap).flat())).sort((a, b) => a.localeCompare(b, 'es'));
      autocompletar("canal", "sugCanal", canalesLista);

      // Listener para el buscador en tiempo real
      document.getElementById('buscador').addEventListener('input', filtrarTabla);

      // Persistence & Locks
      CAMPOS_CON_BLOQUEO.forEach(id => {
        const campo = document.getElementById(id);
        if (localStorage.getItem(id)) campo.value = localStorage.getItem(id);
        campo.addEventListener("input", () => localStorage.setItem(id, campo.value));

        const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
        if (chk) {
          chk.checked = localStorage.getItem(`bloqueado_${id}`) === 'true';
          alternarBloqueo(id);
        }
      });

      cargarNotasGuardadas();

      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        th.addEventListener('click', () => ordenarTabla(th.dataset.col));
      });

      document.querySelector("form").addEventListener('reset', (e) => {
        // ðŸŒŸ LÃ“GICA: DESBLOQUEAR TODOS LOS CAMPOS AL PRESIONAR LIMPIAR ðŸŒŸ
        e.preventDefault(); // Detenemos el reset inicial para asegurar el desbloqueo

        desbloquearTodosLosCampos();

        // Ejecutamos el reset del formulario despuÃ©s del desbloqueo
        e.target.reset();

        setTimeout(() => {
          document.getElementById('titular').focus();
          resetearEstadoEdicion();
        }, 10);
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.campo')) {
          document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
        }
      });

      // ----------------------------------------------------------------------
      // ðŸŒŸ ATAJOS DE TECLADO ðŸŒŸ
      // ----------------------------------------------------------------------

      // 1. Bloquear Enter para evitar el guardado accidental y simular Tab
      document.addEventListener("keydown", (e) => {
        // Verifica si la tecla es Enter y si el foco estÃ¡ en un input de texto
        if (e.key === "Enter" && e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'date')) {
          // Se debe permitir que la lÃ³gica de autocompletado maneje el Enter (para selecciÃ³n mÃºltiple o Ãºnica)
          // Si la funciÃ³n autocompletar no evita el default (porque hay mÃºltiples), el foco se mueve aquÃ­.
          const contenedorSugerencias = e.target.parentNode.querySelector('.sugerencias');
          const items = contenedorSugerencias ? contenedorSugerencias.querySelectorAll('.sugerencia') : [];

          // Si no hay sugerencias, o si hay mÃ¡s de una, y se presiona Enter,
          // impedimos el submit del formulario y simulamos el Tab.
          if (items.length !== 1) { // Nota: El caso items.length === 1 estÃ¡ manejado dentro del autocompletar
            e.preventDefault();

            // Obtener todos los elementos enfocables (solo inputs de texto y fecha, excluyendo elementos con tabindex="-1")
            const form = document.querySelector('form');
            const focusable = Array.from(form.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));

            const index = focusable.indexOf(e.target);

            if (index > -1 && index < focusable.length - 1) {
              // Mueve el foco al siguiente campo
              focusable[index + 1].focus();
            } else if (index === focusable.length - 1) {
              // Si es el Ãºltimo campo, regresa al inicio (Titular)
              document.getElementById('titular').focus();
            }
          }
        }
      });

      // 2. Activar Guardado con Ctrl + Q
      document.addEventListener("keydown", (e) => {
        // Verifica Ctrl (o Cmd en Mac) + Q
        if (e.ctrlKey || e.metaKey) {
          if (e.key.toLowerCase() === 'q') {
            e.preventDefault(); // Evita la acciÃ³n predeterminada del navegador
            document.querySelector("form").dispatchEvent(new Event('submit'));
          }
        }
      });

      // 3. ðŸŒŸ ATAJO MODIFICADO: Bloqueo/Desbloqueo del campo activo con Ctrl + Shift + L ðŸŒŸ
      document.addEventListener("keydown", (e) => {
        // Verifica Ctrl (o Cmd en Mac) + Shift + L
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'l') {
          e.preventDefault(); // Evita la acciÃ³n predeterminada

          const activeElement = document.activeElement;
          const campoId = activeElement.id;

          // Verifica si el campo activo es un INPUT de texto o fecha O un TEXTAREA Y si estÃ¡ en la lista de campos bloqueables
          if ((activeElement.tagName === 'INPUT' && (activeElement.type === 'text' || activeElement.type === 'date') || activeElement.tagName === 'TEXTAREA') && CAMPOS_CON_BLOQUEO.includes(campoId)) {

            const checkboxId = `check${campoId.charAt(0).toUpperCase() + campoId.slice(1)}`;
            const checkbox = document.getElementById(checkboxId);

            // Si el checkbox existe, alterna su estado y aplica el bloqueo/desbloqueo
            if (checkbox) {
              checkbox.checked = !checkbox.checked; // Alterna el estado
              alternarBloqueo(campoId);            // Aplica el bloqueo/desbloqueo

              // Vuelve a enfocar el campo para conservar el foco
              activeElement.focus();
            }
          }
        }
      });

      // 4. ðŸŒŸ ATAJO PARA DUPLICAR EL ÃšLTIMO REGISTRO: Ctrl + Shift + J ðŸŒŸ
      document.addEventListener("keydown", (e) => {
        // Verifica Ctrl (o Cmd en Mac) + Shift + J
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'j') {
          e.preventDefault(); // Evita la acciÃ³n predeterminada

          // Verifica que haya al menos una nota para duplicar
          if (notas.length === 0) {
            alert("No hay registros para duplicar.");
            return;
          }

          // Obtiene el Ãºltimo registro guardado (el de mayor ordenCaptura)
          const ultimoRegistro = notas.reduce((max, nota) => nota.ordenCaptura > max.ordenCaptura ? nota : max, notas[0]);

          // Crea una copia del registro sin el ordenCaptura
          const registroDuplicado = { ...ultimoRegistro };
          delete registroDuplicado.ordenCaptura;

          // Carga los valores en el formulario
          camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            document.getElementById(id).value = registroDuplicado[id] || '';
          });

          // Resetea el estado de ediciÃ³n para que se guarde como nuevo registro
          resetearEstadoEdicion();

          // Disparar blur para cargar sugerencias dependientes
          document.getElementById("dependencia").dispatchEvent(new Event('blur'));
          document.getElementById("medio").dispatchEvent(new Event('blur'));

          // Enfoca el primer campo editable
          document.getElementById('titular').focus();

          // Muestra una notificaciÃ³n sutil
          console.log("Ãšltimo registro duplicado y cargado en el formulario.");
        }
      });

      // ----------------------------------------------------------------------
      // ðŸŒŸ EFECTO DE ENCOGIMIENTO DE CABECERA AL HACER SCROLL ðŸŒŸ
      // ----------------------------------------------------------------------
      const header = document.querySelector('header');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
          header.classList.add('shrunk');
        } else {
          header.classList.remove('shrunk');
        }
      });
    });

    document.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();
      // --- VALIDACIÃ“N ESTILO EXCEL ---
      const camposAValidar = [
        { id: 'medio', lista: listasParaValidar.medios, nombre: 'Medio' },
        { id: 'dependencia', lista: listasParaValidar.dependencias, nombre: 'Dependencia' },
        { id: 'genero', lista: listasParaValidar.generos, nombre: 'GÃ©nero' },
        { id: 'estatus', lista: listasParaValidar.estatus, nombre: 'Estatus' },
        { id: 'municipio', lista: listasParaValidar.municipios, nombre: 'Municipio' }
      ];

      for (const campo of camposAValidar) {
        const valorInput = document.getElementById(campo.id).value.trim();
        if (valorInput && !campo.lista.includes(valorInput)) {
          alert(`Error: El valor "${valorInput}" en el campo ${campo.nombre} no es vÃ¡lido. Selecciona una opciÃ³n de la lista.`);
          document.getElementById(campo.id).focus();
          return;
        }
      }

      // --- VALIDACIÃ“N DE FIRMA (Dependiente de Medio) ---
      const valorMedio = document.getElementById('medio').value.trim();
      const valorFirma = document.getElementById('firma').value.trim();
      if (valorFirma) {
        const firmasValidas = listasParaValidar.firmas[valorMedio] || [];
        if (!firmasValidas.includes(valorFirma)) {
          alert(`Error: El valor "${valorFirma}" en el campo Firma no es vÃ¡lido para el medio "${valorMedio}". Selecciona una opciÃ³n de la lista.`);
          document.getElementById('firma').focus();
          return;
        }
      }
      // --- FIN VALIDACIÃ“N ---
      const nuevaNota = {};

      // 1. Recolectar datos y persistir campos bloqueados
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        const campo = document.getElementById(id);
        if (id === 'titular') {
          nuevaNota[id] = campo.value.replace(/\n/g, ' ').trim();
        } else {
          nuevaNota[id] = campo.value.trim();
        }

        if (localStorage.getItem(`bloqueado_${id}`) === 'true') {
          // Si el campo estÃ¡ bloqueado, su valor ya estÃ¡ persistido.
        }
      });

      // ðŸš¨ VALIDACIÃ“N: No guarda si faltan campos obligatorios 
      const camposFaltantes = contieneCamposVacios(nuevaNota);

      if (camposFaltantes.length > 0) {
        // ðŸš¨ ALERTA CORREGIDA SIN MENCIONAR CAMPOS OPCIONALES ðŸš¨
        alert(`ðŸš¨ Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}`);
        return; // Detiene el proceso de guardado/actualizaciÃ³n
      }

      // 2. Guardar/Actualizar nota
      if (filaEnEdicion !== null) {
        nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
        notas[filaEnEdicion] = nuevaNota;
        resetearEstadoEdicion();
      } else {
        nuevaNota.ordenCaptura = nextOrdenCaptura++;
        notas.push(nuevaNota);
      }
      guardarNotas();
      ordenarTabla(ordenActual.columna, true);

      // 3. Limpiar campos NO bloqueados y eliminar su persistencia
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        // Si el campo NO estÃ¡ bloqueado (o estÃ¡ desbloqueado por la nueva lÃ³gica de 'alternarBloqueo'),
        // se limpia su valor en la UI.
        if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
          document.getElementById(id).value = '';
        }
      });

      // 4. Devolver el foco al campo Titular
      document.getElementById('titular').focus();
    });
    // FunciÃ³n para desbloquear y limpiar todos los campos
    function resetearFormulario() {
      CAMPOS_CON_BLOQUEO.forEach(campoId => {
        const input = document.getElementById(campoId);
        const check = document.getElementById("check" + campoId.charAt(0).toUpperCase() + campoId.slice(1));

        if (input) {
          input.classList.remove("bloqueado");
          input.disabled = false;
          input.value = "";
        }
        if (check) {
          check.checked = false;
        }
      });

      // Limpia sugerencias visibles
      document.querySelectorAll(".sugerencias").forEach(div => div.innerHTML = "");
    }

    // Intercepta el evento reset del formulario
    document.querySelector("form").addEventListener("reset", function () {
      setTimeout(resetearFormulario, 0);
    });
  </script>

  <footer>
    Â© 2025 Francisco Villeda. Todos los derechos reservados.
  </footer>
</body>

</html>