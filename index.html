<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Sistema de Captura de Notas</title>
  <style>
    /* --- ESTILOS GENERALES Y MODERNOS --- */
    :root {
      --color-primary: #007bff;
      --color-secondary: #6c757d;
      --color-success: #28a745;
      --color-warning: #ffc107;
      --color-light: #f8f9fa;
      --color-dark: #343a40;
      --radius: 0.25rem;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-light);
      color: var(--color-dark);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-primary);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: white;
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header img {
      height: 50px; /* TamaÃ±o ligeramente ajustado */
    }
    /* --- FORMULARIO Y GRIDS --- */
    form {
      /* DiseÃ±o de 4 columnas para escritorio */
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 20px;
      background-color: white;
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    label {
        font-weight: 600;
        align-self: center; /* Centrar verticalmente la etiqueta */
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      border-radius: var(--radius);
      margin-right: 10px;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    /* Campos de span 4 (Titular y Usuario) */
    form > label:nth-child(1),
    form > div:nth-child(2),
    form > label:nth-child(7),
    form > div:nth-child(8) {
        grid-column: span 4;
    }
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid #ced4da;
      background: white;
      max-height: 180px;
      overflow-y: auto;
      z-index: 100; /* Asegurar que estÃ© por encima de todo */
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .sugerencia {
      padding: 8px 10px;
      cursor: pointer;
    }
    .sugerencia:hover,
    .sugerencia.resaltado {
      background-color: #e9ecef;
      color: var(--color-dark);
    }
    /* --- BLOQUEO Y VALIDACIÃ“N --- */
    .bloqueado {
      background-color: #e9ecef !important;
      border: 1px solid #adb5bd !important;
      cursor: not-allowed;
    }
    input:required:invalid {
      border-left: 5px solid #dc3545; /* Rojo */
    }
    input:required:valid {
      border-left: 5px solid var(--color-success); /* Verde */
    }
    /* --- BOTONES --- */
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease;
      margin-right: 5px;
      color: white;
      background-color: var(--color-primary);
    }
    button:hover {
      background-color: #0056b3;
    }
    #btnGuardar {
        background-color: var(--color-success);
    }
    #btnGuardar:hover {
        background-color: #1e7e34;
    }
    /* BotÃ³n desplegable (ðŸ”½) */
    .campo button[type="button"] {
        background-color: var(--color-secondary);
        padding: 8px;
    }
    .campo button[type="button"]:hover {
        background-color: #5a6268;
    }
    /* --- TABLA --- */
    h2 {
        margin-top: 40px;
        color: var(--color-dark);
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      margin-top: 20px;
      background-color: white;
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #dee2e6;
      text-align: left;
    }
    th {
      background-color: var(--color-primary);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    .editando {
        background-color: var(--color-warning);
    }
    .error-carga {
      color: #dc3545;
      font-weight: bold;
      margin-top: 15px;
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-secondary);
      text-align: center;
    }

    /* --- ESTILOS RESPONSIVE (MÃ“VIL) --- */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        header {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px;
        }
        /* Ajustar formulario a una sola columna */
        form {
            grid-template-columns: 1fr; /* Una sola columna */
            gap: 10px;
            padding: 15px;
        }
        /* Ajustar todos los elementos de span 4 a span 1 */
        form > label,
        form > div {
            grid-column: span 1 !important;
        }
        
        /* Ocultar encabezados de tabla en mÃ³vil y usar data attributes para mostrar el dato */
        table, thead, tbody, th, td, tr { 
            display: block; 
        }
        
        thead tr { 
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        tr { border: 1px solid #ccc; margin-bottom: 10px; }
        
        td { 
            border: none;
            border-bottom: 1px solid #eee; 
            position: relative;
            padding-left: 50%; /* Espacio para el label simulado */
            text-align: right;
            font-size: 0.9em;
        }
        
        /* Simular los encabezados de tabla como labels */
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        /* La Ãºltima celda (acciones) no necesita el padding */
        td:last-child {
            text-align: center;
            padding-left: 10px;
        }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://thelonious9.github.io/capturanotas/logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas</h1>
  </header>

  <form>
    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')">
      <label for="checkUsuario">ðŸ”’</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')">
      <label for="checkFecha">ðŸ”’</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')">ðŸ”½</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')">
      <label for="checkMedio">ðŸ”’</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>

    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')">
      <label for="checkTitular">ðŸ”’</label>
    </div>

    <label for="firma">Firma:</label>
    <div class="campo">
      <input type="text" id="firma" name="firma">
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')">
      <label for="checkFirma">ðŸ”’</label>
    </div>

    <label for="pagina">PÃ¡gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina">
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')">
      <label for="checkPagina">ðŸ”’</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')">ðŸ”½</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')">
      <label for="checkDependencia">ðŸ”’</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>

    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')">ðŸ”½</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')">
      <label for="checkOrganismo">ðŸ”’</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>

    <label for="genero">GÃ©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')">ðŸ”½</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')">
      <label for="checkGenero">ðŸ”’</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>

    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')">ðŸ”½</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')">
      <label for="checkCanal">ðŸ”’</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>

    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')">ðŸ”½</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')">
      <label for="checkTema">ðŸ”’</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>

    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')">ðŸ”½</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')">
      <label for="checkEstatus">ðŸ”’</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')">ðŸ”½</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')">
      <label for="checkMunicipio">ðŸ”’</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>

    <div style="grid-column: span 4; margin-top: 10px;">
      <button type="submit" id="btnGuardar">Guardar</button>
    </div>
  </form>

  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th>Usuario</th><th>Fecha</th><th>Medio</th><th>Titular</th><th>Firma</th><th>PÃ¡gina</th>
        <th>Dependencia</th><th>Organismo</th><th>GÃ©nero</th><th>Canal</th>
        <th>Tema</th><th>Estatus</th><th>Municipio</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>
  <button onclick="exportarCSV()">Exportar a hoja de cÃ¡lculo</button>
  <div id="erroresCarga" class="error-carga"></div>

  <script>
    let notas = [];
    let filaEnEdicion = null;
    const camposDeDatos = ["usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];
    // Mapeo de encabezados para el modo mÃ³vil
    const encabezadosTabla = {
        "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma", 
        "pagina": "PÃ¡gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "GÃ©nero", 
        "canal": "Canal", "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };
    
    const urls = {
      dependencias: "https://thelonious9.github.io/capturanotas/Dependencia.csv",
      medios: "https://thelonious9.github.io/capturanotas/Medio.csv",
      generos: "https://thelonious9.github.io/capturanotas/Genero.csv",
      estatus: "https://thelonious9.github.io/capturanotas/Estatus.csv",
      temas: "https://thelonious9.github.io/capturanotas/Tema.csv",
      municipios: "https://thelonious9.github.io/capturanotas/Municipio.csv"
    };
    
    function findKeyCaseInsensitive(map, value) {
        if (!value) return null;
        const lowerValue = value.toLowerCase();
        for (const key in map) {
            if (key.toLowerCase() === lowerValue) {
                return key; 
            }
        }
        return null;
    }

    async function cargarCSV(url) {
      try {
        const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
        const res = await fetch(urlConCacheBuster);
        const buffer = await res.arrayBuffer(); 
        const decoder = new TextDecoder('utf-8'); 
        const texto = decoder.decode(buffer); 
        return texto.split('\n').map(linea => linea.split(','));
      } catch (e) {
        document.getElementById("erroresCarga").innerText += `Error al cargar ${url} (problema de codificaciÃ³n o red).\n`;
        return [];
      }
    }
    
    function limpiarFilasCSV(filas) {
      if (!filas || filas.length === 0) return [];
      filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      const encabezado = filas[0].map(c => (c || "").toLowerCase()).join(",");
      const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("medio") || encabezado.includes("gÃ©nero");
      if (tieneEncabezado) filas = filas.slice(1);
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }

    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([clave, valor]) => {
        if (!clave) return;
        map[clave] = map[clave] || new Set();
        if (valor) map[clave].add(valor);
      });
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
      return { claves, map: mapArrays };
    }

    async function cargarLista(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      return Array.from(new Set(filas.map(r => r[0]))).sort((a, b) => a.localeCompare(b, 'es'));
    }

    function autocompletar(idCampo, idSugerencias, lista, callback) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      campo.dataset.lista = JSON.stringify(lista);
      let indice = -1;

      campo.addEventListener("input", () => {
        const valor = campo.value.toLowerCase().trim();
        contenedor.innerHTML = "";
        indice = -1;
        if (!valor) return;
        const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
        sugerencias.forEach((s, i) => {
          const div = document.createElement("div");
          div.textContent = s;
          div.className = "sugerencia";
          div.dataset.index = i;
          div.onclick = () => {
            campo.value = s;
            contenedor.innerHTML = "";
            if (callback) callback(s);
          };
          contenedor.appendChild(div);
        });
      });

      campo.addEventListener("keydown", e => {
        const items = contenedor.querySelectorAll(".sugerencia");
        if (items.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          indice = (indice + 1) % items.length;
          resaltar(items, indice);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          indice = (indice - 1 + items.length) % items.length;
          resaltar(items, indice);
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (indice >= 0 && items[indice]) {
            campo.value = items[indice].textContent;
            contenedor.innerHTML = "";
            if (callback) callback(campo.value);
          }
        }
      });

      campo.addEventListener("focus", () => {
        document.querySelectorAll('.sugerencias').forEach(sug => {
            if (sug.id !== idSugerencias) {
                sug.innerHTML = "";
            }
        });
      });

      function resaltar(items, i) {
        items.forEach(el => el.classList.remove("resaltado"));
        items[i].classList.add("resaltado");
      }
    }

    function mostrarSugerencias(idCampo, idSugerencias) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");

      const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
      contenedor.innerHTML = "";
      lista.forEach((s, i) => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.dataset.index = i;
        div.onclick = () => {
          campo.value = s;
          contenedor.innerHTML = "";
        };
        contenedor.appendChild(div);
      });
    }

    function guardarNotas() {
        localStorage.setItem('notasCapturadas', JSON.stringify(notas));
    }

    function renderizarTabla() {
        const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
        tablaBody.innerHTML = '';
        
        notas.forEach((nota, indice) => {
            const tr = document.createElement("tr");
            tr.dataset.index = indice;

            camposDeDatos.forEach(campo => {
                const td = document.createElement("td");
                td.textContent = nota[campo];
                td.setAttribute('data-label', encabezadosTabla[campo]); // Atributo para mÃ³vil
                tr.appendChild(td);
            });
            
            const tdAcciones = document.createElement("td");
            tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']); // Atributo para mÃ³vil
            const btnEditar = document.createElement("button");
            btnEditar.textContent = "Editar";
            btnEditar.onclick = function() { editarNota(tr); };
            tdAcciones.appendChild(btnEditar);
            tr.appendChild(tdAcciones);

            tablaBody.appendChild(tr);
        });
    }

    function cargarNotasGuardadas() {
        const datosJSON = localStorage.getItem('notasCapturadas');
        if (datosJSON) {
            try {
                notas = JSON.parse(datosJSON);
                renderizarTabla();
            } catch (e) {
                console.error("Error al cargar notas de localStorage:", e);
                notas = [];
            }
        }
    }

    function alternarBloqueo(idCampo) {
        const campo = document.getElementById(idCampo);
        const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
        const checkbox = document.getElementById(checkboxId);
        
        campo.readOnly = checkbox.checked;
        campo.classList.toggle("bloqueado", checkbox.checked);
        
        localStorage.setItem(`bloqueado_${idCampo}`, checkbox.checked);
    }

    function editarNota(tr) {
        const indice = parseInt(tr.dataset.index);
        const nota = notas[indice];

        camposDeDatos.forEach(id => {
            document.getElementById(id).value = nota[id];
        });

        filaEnEdicion = null; 
        
        document.getElementById("dependencia").dispatchEvent(new Event('blur'));
        document.getElementById("medio").dispatchEvent(new Event('blur'));
        
        filaEnEdicion = indice; 
        document.getElementById('btnGuardar').textContent = 'Actualizar Nota';
        
        document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
        tr.classList.add('editando');
        
        window.scrollTo(0, 0);
    }

    function exportarCSV() {
      const cabeceras = ["Usuario", "Fecha", "Medio", "Titular", "Firma", "PÃ¡gina", "Dependencia", "Organismo", "GÃ©nero", "Canal", "Tema", "Estatus", "Municipio"];
      const filas = [cabeceras];
      
      notas.forEach(nota => {
        const fila = camposDeDatos.map(key => {
            let valor = nota[key] || '';
            return `"${valor.replace(/"/g, '""')}"`; 
        });
        filas.push(fila);
      });
      
      const contenido = "\uFEFF" + filas.map(f => f.join(",")).join("\n");
      const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "notas_capturadas.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- Eventos ---

    document.addEventListener("DOMContentLoaded", async () => {
      let orgMap, canalMap;

      const depData = await cargarMapa(urls.dependencias);
      orgMap = depData.map;
      autocompletar("dependencia", "sugDep", depData.claves, dep => {
        autocompletar("organismo", "sugOrg", orgMap[dep] || []);
      });

      const medioData = await cargarMapa(urls.medios);
      canalMap = medioData.map;
      autocompletar("medio", "sugMedio", medioData.claves, medio => {
        const canales = canalMap[medio] || [];
        autocompletar("canal", "sugCanal", canales);
        if (canales.length === 1) {
          document.getElementById("canal").value = canales[0];
        }
      });
      
      // ðŸš¨ CASCADA DEPENDENCIAS/ORGANISMO: BÃºsqueda insensible y correcciÃ³n de case
      document.getElementById("dependencia").addEventListener("blur", (e) => {
          const campo = e.target;
          const depValue = campo.value.trim();
          const foundKey = findKeyCaseInsensitive(orgMap, depValue);

          if (foundKey) {
              campo.value = foundKey; // Auto-correcciÃ³n de mayÃºsculas/minÃºsculas
              autocompletar("organismo", "sugOrg", orgMap[foundKey] || []);
          } else {
              autocompletar("organismo", "sugOrg", []);
          }
      });
      
      // ðŸš¨ CASCADA MEDIO/CANAL: BÃºsqueda insensible y correcciÃ³n de case
      document.getElementById("medio").addEventListener("blur", (e) => {
          const campo = e.target;
          const medioValue = campo.value.trim();
          const foundKey = findKeyCaseInsensitive(canalMap, medioValue);

          if (foundKey) {
              campo.value = foundKey; // Auto-correcciÃ³n de mayÃºsculas/minÃºsculas
              const canales = canalMap[foundKey] || [];
              autocompletar("canal", "sugCanal", canales);
              if (canales.length === 1) {
                document.getElementById("canal").value = canales[0];
              }
          } else {
              autocompletar("canal", "sugCanal", []);
          }
      });
      
      autocompletar("organismo", "sugOrg", []); 
      autocompletar("canal", "sugCanal", []);


      autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
      autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
      autocompletar("tema", "sugTema", await cargarLista(urls.temas));
      autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));

      // Persistencia
      camposDeDatos.forEach(id => {
        const campo = document.getElementById(id);
        
        if (localStorage.getItem(id)) campo.value = localStorage.getItem(id);
        
        campo.addEventListener("input", () => {
          localStorage.setItem(id, campo.value);
        });

        const checkboxId = `check${id.charAt(0).toUpperCase() + id.slice(1)}`;
        const checkbox = document.getElementById(checkboxId);
        const isBlocked = localStorage.getItem(`bloqueado_${id}`) === 'true';

        if (checkbox) {
            checkbox.checked = isBlocked;
            alternarBloqueo(id);
        }
      });
      
      cargarNotasGuardadas();

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.campo')) {
            document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");
        }
      });
    });

    document.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();
      
      const nuevaNota = {};
      camposDeDatos.forEach(id => {
        nuevaNota[id] = document.getElementById(id).value.trim();
      });

      if (filaEnEdicion !== null) {
          notas[filaEnEdicion] = nuevaNota;
          
          document.querySelector(`tr[data-index="${filaEnEdicion}"]`).classList.remove('editando');
          filaEnEdicion = null;
          document.getElementById('btnGuardar').textContent = 'Guardar';
          
      } else {
          notas.push(nuevaNota);
      }
      
      guardarNotas();
      renderizarTabla();
      
      camposDeDatos.forEach(id => {
          const campo = document.getElementById(id);
          const isBlocked = localStorage.getItem(`bloqueado_${id}`) === 'true';
          
          if (!isBlocked) {
              campo.value = '';
              localStorage.removeItem(id); 
          } else {
              localStorage.setItem(id, campo.value);
          }
      });
    });
  </script>

  <footer>
    Â© 2025 InstituciÃ³n PÃºblica. Todos los derechos reservados.
  </footer>
</body>
</html>