<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    /* Importaci√≥n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;       /* Oscuro Suave */
      --color-fondo-form: #52504E;         /* Gris C√°lido (Fondo del Formulario) */
      --color-primary: #6F0909;            /* Rojo Intenso (Guardar/Borrar Todo) */
      --color-primary-hover: #792929;      /* Rojo Suave */
      --color-secondary: #792929;          /* Rojo Suave (Bot√≥n Limpiar/Hover) */
      --color-secondary-hover: #6F0909;    /* Rojo Intenso */
      --color-danger: #dc3545;             /* Rojo est√°ndar para peligro */
      --color-danger-hover: #c82333;       /* Rojo oscuro */
      --color-telegram: #0088cc;           
      --color-telegram-hover: #0077b3;     
      --color-dark-text: #31302F;          /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;         /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;           /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;       
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    
    /* --- FORMULARIO (MODIFICACI√ìN DE LAYOUT) --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
        outline: none;
    }
    
    /* üåü REGLAS PARA CAMPOS DE ANCHO COMPLETO üåü */
    form > label:nth-child(2), 
    form > div:nth-child(3) { grid-column: 1 / span 4; } /* Usuario */
    
    form > label:nth-child(8), 
    form > div:nth-child(9) { grid-column: 1 / span 4; } /* Titular */
    
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    
    /* --- BLOQUEO --- */
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    
    /* --- BOTONES --- */
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    button i { margin-right: 8px; font-size: 1.1em; }
    
    /* --- TABLA --- */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      table-layout: fixed; 
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
      max-width: none !important; 
    }

    /* Definici√≥n de anchos */
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 3%; }    
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 7%; }    
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }    
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 8%; }    
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 15%; }   
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 6%; }    
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 5%; }    
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 7%; }    
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 7%; }    
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }  
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }  
    #tablaNotas th:nth-child(12), #tablaNotas td:nth-child(12) { width: 7%; }  
    #tablaNotas th:nth-child(13), #tablaNotas td:nth-child(13) { width: 5%; }  
    #tablaNotas th:nth-child(14), #tablaNotas td:nth-child(14) { width: 6%; }  
    #tablaNotas th:nth-child(15), #tablaNotas td:nth-child(15) { width: 6%; }  

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #5D5C5A; } 
    tbody tr:hover { 
      background-color: #6C6B69; 
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    
    /* --- GRUPO DE ACCIONES --- */
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 25px; 
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap;
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    
    #btnGoogleSheets { background-color: #0A66C2; }
    #btnGoogleSheets:hover { background-color: #0959A8; }
    
    #btnTelegram { background-color: #0088cc; }
    #btnTelegram:hover { background-color: #0077b3; }
    
    #btnSugerirTema { background-color: #096F4B; }
    #btnSugerirTema:hover { background-color: #0A7E56; }
    #btnSugerirTema i { margin-right: 0; }

    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }

    .suggestion-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        background-color: #4A4A4A; 
        padding: 8px; 
        border-radius: var(--radius);
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #sugerenciaTemaInput {
        padding: 10px 15px;
        border: 1px solid var(--color-primary-hover);
        border-radius: var(--radius);
        background-color: var(--color-input-bg);
        color: var(--color-dark-text);
        flex-grow: 1; 
        width: 250px; 
    }
    .suggestion-input-group #btnSugerirTema {
        margin-right: 0;
        padding: 10px 15px; 
    }

    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    /* --- BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }
    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }
    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        .actions-group { flex-direction: column; align-items: stretch; }
        .actions-group button { width: 100%; margin-bottom: 10px; }
        
        .suggestion-input-group {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            padding: 15px 10px; 
        }
        #sugerenciaTemaInput {
            max-width: none;
            width: 100%;
            margin-bottom: 5px;
        }
        .suggestion-input-group #btnSugerirTema { width: 100%; }

        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #7D7C79; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #8D8C8A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            width: auto;
            max-width: 100%; 
            white-space: normal;
            text-overflow: clip; 
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Prensa</h1>
  </header>

  <form>
    <div class="form-logo-container">
        <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">üîí</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">üîí</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
      <label for="checkMedio">üîí</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>
    
    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">üîí</label>
    </div>

    <label for="firma">Firma:</label>
    <div class="campo">
      <input type="text" id="firma" name="firma" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
      <label for="checkFirma">üîí</label>
      <div id="sugFirma" class="sugerencias"></div>
    </div>
    
    <label for="pagina">P√°gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina" required> 
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
      <label for="checkPagina">üîí</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">üîí</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">üîí</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>
    
    <label for="genero">G√©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">üîí</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>
    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">üîí</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>
    
    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">üîí</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>
    
    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">üîí</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">üîí</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>
    
    <div class="button-group-form">
      <button type="button" id="btnGuardar" onclick="agregarNota()"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
      <button type="reset" id="btnLimpiar"><i class="fa-solid fa-eraser"></i> Limpiar</button>
      <button type="button" id="btnEliminar" style="display:none;" onclick="confirmarEliminar()"><i class="fa-solid fa-trash"></i> Eliminar</button>
    </div>
  </form>

  <h2>Notas Capturadas</h2>

  <div class="buscador-container">
    <i class="fa-solid fa-magnifying-glass buscador-icon"></i>
    <input type="text" id="buscador" onkeyup="filtrarTabla()" placeholder="Buscar en todas las columnas...">
  </div>

  <div class="actions-group">
      <button id="btnExportar" onclick="exportarCSV()"><i class="fa-solid fa-file-csv"></i> Exportar a Excel (CSV)</button>
      <button id="btnGoogleSheets" onclick="enviarACalculo()"><i class="fa-solid fa-table"></i> Enviar a Sheets</button>
      <button id="btnTelegram" onclick="enviarTelegram()"><i class="fa-brands fa-telegram"></i> Enviar por Telegram</button>
      <button id="btnBorrarTodo" onclick="borrarTodo()"><i class="fa-solid fa-dumpster-fire"></i> BORRAR TODO</button>
      
      <div class="suggestion-input-group">
        <input type="text" id="sugerenciaTemaInput" placeholder="Sugerir nuevo tema...">
        <button id="btnSugerirTema" onclick="sugerirTema()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
  </div>

  <table id="tablaNotas">
    <thead>
      <tr>
        <th class="sortable-header" data-col="ordenCaptura" onclick="ordenarTabla('ordenCaptura')"># <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="usuario" onclick="ordenarTabla('usuario')">Usuario <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="fecha" onclick="ordenarTabla('fecha')">Fecha <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="medio" onclick="ordenarTabla('medio')">Medio <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="titular" onclick="ordenarTabla('titular')">Titular <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="firma" onclick="ordenarTabla('firma')">Firma <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="pagina" onclick="ordenarTabla('pagina')">P√°gina <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="dependencia" onclick="ordenarTabla('dependencia')">Dependencia <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="organismo" onclick="ordenarTabla('organismo')">Organismo <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="genero" onclick="ordenarTabla('genero')">G√©nero <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="canal" onclick="ordenarTabla('canal')">Canal <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="tema" onclick="ordenarTabla('tema')">Tema <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="estatus" onclick="ordenarTabla('estatus')">Estatus <i class="fa-solid fa-sort sort-icon"></i></th>
        <th class="sortable-header" data-col="municipio" onclick="ordenarTabla('municipio')">Municipio <i class="fa-solid fa-sort sort-icon"></i></th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>

  <footer>
    <p>&copy; 2024 - Sistema de Captura de Notas</p>
  </footer>

  <script>
    // Variables globales
    let notas = [];
    let filaEnEdicion = null; 
    let nextOrdenCaptura = 1;

    // Configuraci√≥n
    const LIMITE_CARACTERES_TITULAR = 50; 
    
    // Telegram Config
    const TELEGRAM_BOT_TOKEN = "7290632367:AAF1vK_eJgG_ePRe5J5GjEqd5v_d_T5rRko"; 
    const TELEGRAM_CHAT_ID = "-4266133092"; 

    // Mapeos y datos cargados de CSV
    let dependenciaMap = {};
    let medioToCanalMap = {};
    let firmaMap = {};
    let dependenciaToOrganismoMap = {};
    
    let canalData = { claves: [], map: {} }; 
    let generoData = { claves: [], map: {} };
    let estatusData = { claves: [], map: {} };
    let municipioData = { claves: [], map: {} };
    let temaData = { claves: [], map: {} };
    
    const CAMPOS_CON_BLOQUEO = ['usuario', 'fecha', 'medio', 'titular', 'firma', 'pagina', 'dependencia', 'organismo', 'genero', 'canal', 'tema', 'estatus', 'municipio'];
    
    const encabezadosTabla = {
      "ordenCaptura": "#",
      "usuario": "Usuario",
      "fecha": "Fecha",
      "medio": "Medio",
      "titular": "Titular",
      "firma": "Firma",
      "pagina": "P√°gina",
      "dependencia": "Dependencia",
      "organismo": "Organismo",
      "genero": "G√©nero",
      "canal": "Canal",
      "tema": "Tema",
      "estatus": "Estatus",
      "municipio": "Municipio",
      "acciones": "Acciones"
    };

    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

    // RUTAS RELATIVAS (Aseg√∫rese de que estos archivos est√©n en la misma carpeta)
    const urls = {
        dependencias: "./Dependencia.csv",
        medios: "./Medio.csv", 
        generos: "./Genero.csv",
        estatus: "./Estatus.csv",
        municipios: "./Municipio.csv",
        temas: "./Tema.csv",
        firmas: "./Firma.csv" 
    };

    // --- CARGA DE DATOS (CSV) ---
    async function cargarCSV(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        return text;
      } catch (e) {
        console.error("Error cargando CSV:", url, e);
        return "";
      }
    }
    
    function limpiarFilasCSV(textoCSV) {
        const lineas = textoCSV.split('\n');
        return lineas.map(linea => {
            // Usa una expresi√≥n regular para dividir por comas, respetando comillas
            const columnas = linea.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (!columnas) return [];
            return columnas.map(col => col.replace(/^"|"$/g, '').trim()); // Quita comillas
        }).filter(cols => cols.length > 0 && cols[0] !== "");
    }

    async function cargarMapa(url) {
        const filas = limpiarFilasCSV(await cargarCSV(url));
        const map = {};
        filas.forEach(([clave, valor]) => {
             if (!clave) return;
             clave = clave.trim();
             valor = valor ? valor.trim() : '';
             map[clave] = map[clave] || new Set();
             if (valor) map[clave].add(valor);
        });
        
        // Convierte los Sets a Arrays ordenados
        const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
        const mapArrays = {};
        claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
        
        return { claves, map: mapArrays };
    }
    
    async function inicializar() {
        // 1. Cargar Dependencia -> Organismo
        const depData = await cargarMapa(urls.dependencias);
        dependenciaToOrganismoMap = depData.map;
        dependenciaMap = depData.claves; // Solo claves para autocompletar dependencia
        
        // 2. Cargar Medio -> Canal
        const medioData = await cargarMapa(urls.medios);
        medioToCanalMap = {}; // Aplanamos para acceso r√°pido O(1)
        medioData.claves.forEach(medio => {
            const canales = medioData.map[medio];
            if (canales && canales.length > 0) {
                medioToCanalMap[medio] = canales[0]; // Asumimos 1 canal por medio
            }
        });

        // 3. Cargar Firmas (Medio -> Firma)
        const firmaData = await cargarMapa(urls.firmas);
        firmaMap = firmaData.map; // Objeto { "Medio": ["Firma1", "Firma2"] }

        // 4. Cargar Listas Simples
        canalData = await cargarMapa(urls.medios); // Reusamos para sacar lista √∫nica de canales si fuera necesario, o cargamos aparte
        // Correcci√≥n: El CSV de Medios tiene la estructura Medio,Canal. 
        // Para autocompletar 'Canal' independientemente, extraemos todos los valores √∫nicos del mapa de medios
        const todosCanales = new Set();
        Object.values(medioToCanalMap).forEach(c => todosCanales.add(c));
        canalData = { claves: Array.from(todosCanales).sort(), map: {} };

        generoData = await cargarMapa(urls.generos);
        estatusData = await cargarMapa(urls.estatus);
        municipioData = await cargarMapa(urls.municipios);
        temaData = await cargarMapa(urls.temas);

        configurarAutocompletado();
    }
    
    function configurarAutocompletado() {
        autocompletar("dependencia", "sugDep", dependenciaMap, (dep) => {
             // Al seleccionar dependencia, llenar organismo autom√°ticamente
             const organismos = dependenciaToOrganismoMap[dep];
             const orgInput = document.getElementById("organismo");
             if (organismos && organismos.length > 0) {
                 orgInput.value = organismos[0]; // Tomamos el primero por defecto
                 // Efecto visual de actualizaci√≥n
                 orgInput.style.backgroundColor = "#e8f0fe";
                 setTimeout(() => orgInput.style.backgroundColor = "var(--color-input-bg)", 500);
             } else {
                 orgInput.value = "";
             }
        });

        autocompletar("organismo", "sugOrg", []); // Organismo suele ser auto-llenado, pero dejamos opci√≥n
        autocompletar("genero", "sugGenero", generoData.claves);
        autocompletar("canal", "sugCanal", canalData.claves);
        autocompletar("tema", "sugTema", temaData.claves);
        autocompletar("estatus", "sugEstatus", estatusData.claves);
        autocompletar("municipio", "sugMunicipio", municipioData.claves);
        
        // MEDIO (Dispara Canal y Firma)
        autocompletar("medio", "sugMedio", Object.keys(medioToCanalMap).sort(), medio => {
             // Llenar Canal
             setCanalFromMedio(medio, medioToCanalMap);
             
             // Llenar Firmas sugeridas para ese medio
             const firmas = firmaMap[medio] || [];
             autocompletar("firma", "sugFirma", firmas);
        });

        // FIRMA (Inicialmente vac√≠a o gen√©rica, se actualiza al elegir medio)
        autocompletar("firma", "sugFirma", []);
        
        // Eventos blur para validaci√≥n/limpieza
        document.getElementById("dependencia").addEventListener("blur", (e) => {
             if (!dependenciaMap.includes(e.target.value.trim())) {
                 // Opci√≥n: Limpiar si no es v√°lido o dejar libre. Dejamos libre por flexibilidad,
                 // pero podr√≠amos limpiar organismo si la dependencia cambia a algo desconocido.
             }
        });
    }

    function setCanalFromMedio(medio, map) {
        const canalInput = document.getElementById("canal");
        const canal = map[medio];
        if (canal) {
            canalInput.value = canal;
            canalInput.style.backgroundColor = "#e8f0fe";
            setTimeout(() => canalInput.style.backgroundColor = "var(--color-input-bg)", 500);
        } else {
             canalInput.value = '';
        }
    }

    // --- L√ìGICA AUTOCOMPLETADO (Gen√©rica) ---
    function autocompletar(inputId, sugerenciasId, listaOpciones, callbackSeleccion = null) {
      const input = document.getElementById(inputId);
      const sugerenciasDiv = document.getElementById(sugerenciasId);
      let currentFocus = -1;

      input.addEventListener("input", function() {
        const val = this.value;
        cerrarSugerencias();
        if (!val) return;
        
        currentFocus = -1;
        const items = listaOpciones.filter(item => item.toLowerCase().includes(val.toLowerCase()));
        
        // üåü MEJORA: Si hay coincidencia exacta √∫nica, no mostrar lista gigante, pero s√≠ permitir verla
        if (items.length === 0) return;

        items.forEach(item => {
           const div = document.createElement("div");
           div.classList.add("sugerencia");
           // Resaltar coincidencia
           const regex = new RegExp(`(${val})`, "gi");
           div.innerHTML = item.replace(regex, "<strong>$1</strong>");
           div.addEventListener("click", function() {
             input.value = item;
             cerrarSugerencias();
             if (callbackSeleccion) callbackSeleccion(item);
           });
           sugerenciasDiv.appendChild(div);
        });
      });

      input.addEventListener("keydown", function(e) {
          let x = sugerenciasDiv.getElementsByTagName("div");
          if (e.keyCode == 40) { // Abajo
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) { // Arriba
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) { // Enter
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            } else if (x.length === 1) {
               // Si solo hay una sugerencia y damos enter, seleccionarla
               x[0].click();
            }
          }
      });
      
      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("resaltado");
        x[currentFocus].scrollIntoView({ block: 'nearest' });
      }
      
      function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
          x[i].classList.remove("resaltado");
        }
      }
    }
    
    function cerrarSugerencias() {
        document.querySelectorAll(".sugerencias").forEach(x => x.innerHTML = "");
    }
    
    function mostrarSugerencias(inputId, divId) {
        const input = document.getElementById(inputId);
        // Simular evento input para mostrar todo o filtrar
        const event = new Event('input');
        input.dispatchEvent(event);
        // Si est√° vac√≠o, mostrar todos (truco: pasar un filtro vac√≠o a la l√≥gica de autocompletar si se quisiera, 
        // pero nuestra l√≥gica actual requiere texto. Modificamos brevemente para 'Show All' si el input est√° vac√≠o)
        /* Nota: Para 'Show All' necesitar√≠amos refactorizar autocompletar. 
           Por ahora, el bot√≥n üîΩ solo funciona si hay texto o focusea. 
           Vamos a hacer que focusee y dispare input vac√≠o.
        */
        input.focus();
    }

    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener("click", function (e) {
        if (!e.target.matches(".campo > input") && !e.target.matches(".campo > button")) {
            cerrarSugerencias();
        }
    });


    // --- CRUD NOTAS ---
    function agregarNota() {
      const form = document.querySelector("form");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const nuevaNota = {
        ordenCaptura: filaEnEdicion ? filaEnEdicion.ordenCaptura : nextOrdenCaptura++,
        usuario: document.getElementById("usuario").value.trim(),
        fecha: document.getElementById("fecha").value,
        medio: document.getElementById("medio").value.trim(),
        titular: document.getElementById("titular").value.trim(),
        firma: document.getElementById("firma").value.trim(),
        pagina: document.getElementById("pagina").value.trim(),
        dependencia: document.getElementById("dependencia").value.trim(),
        organismo: document.getElementById("organismo").value.trim(),
        genero: document.getElementById("genero").value.trim(),
        canal: document.getElementById("canal").value.trim(),
        tema: document.getElementById("tema").value.trim(),
        estatus: document.getElementById("estatus").value.trim(),
        municipio: document.getElementById("municipio").value.trim()
      };

      if (filaEnEdicion) {
        const index = notas.findIndex(n => n.ordenCaptura === filaEnEdicion.ordenCaptura);
        if (index !== -1) notas[index] = nuevaNota;
        resetearEstadoEdicion();
      } else {
        notas.push(nuevaNota);
      }

      guardarNotas();
      renderizarTabla();
      
      // üåü NUEVO: Guardado Autom√°tico en la Nube (Silencioso)
      enviarACalculo(true); 
      
      // Limpiar campos NO bloqueados
      const campos = document.querySelectorAll("form input[type='text'], form input[type='date']");
      campos.forEach(input => {
          const id = input.id;
          const isLocked = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`)?.checked;
          if (!isLocked) {
              input.value = "";
          }
      });
      // Devolver foco
      document.getElementById('titular').focus();
    }

    function editarNota(tr) {
      const id = parseInt(tr.cells[0].textContent);
      const nota = notas.find(n => n.ordenCaptura === id);
      if (!nota) return;

      filaEnEdicion = nota;

      // Rellenar formulario
      Object.keys(nota).forEach(key => {
          if (key === 'ordenCaptura') return;
          const input = document.getElementById(key);
          if (input) input.value = nota[key];
      });

      // UI Estado Edici√≥n
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-rotate"></i> Actualizar';
      document.getElementById('btnEliminar').style.display = 'inline-block';
      
      // Resaltar fila
      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
      tr.classList.add('editando');
      
      // Scroll al formulario
      document.querySelector("header").scrollIntoView({ behavior: 'smooth' });
    }

    function confirmarEliminar() {
        if (!filaEnEdicion) return;
        if (confirm("¬øEliminar esta nota?")) {
            notas = notas.filter(n => n.ordenCaptura !== filaEnEdicion.ordenCaptura);
            guardarNotas();
            renderizarTabla();
            resetearEstadoEdicion();
            document.querySelector("form").reset();
        }
    }

    function resetearEstadoEdicion() {
        filaEnEdicion = null;
        document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
        document.getElementById('btnEliminar').style.display = 'none';
        document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
    }

    function guardarNotas() {
        localStorage.setItem('notasCapturadas', JSON.stringify(notas));
        localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura);
    }
    
    function borrarTodo() {
        if (confirm("¬øEst√°s seguro de que quieres BORRAR TODAS las notas capturadas? Esta acci√≥n es irreversible en tu equipo local.")) {
            notas = [];
            nextOrdenCaptura = 1;
            guardarNotas();
            renderizarTabla();
            resetearEstadoEdicion();
        }
    }

    function renderizarTabla() {
      const tbody = document.querySelector("#tablaNotas tbody");
      tbody.innerHTML = "";
      
      const filtro = document.getElementById('buscador').value.toLowerCase();

      // Filtrado y Ordenado
      let notasDisplay = notas.filter(nota => {
          return Object.values(nota).some(val => String(val).toLowerCase().includes(filtro));
      });
      
      // L√≥gica de ordenaci√≥n
      notasDisplay.sort((a, b) => {
          let valA = a[ordenActual.columna];
          let valB = b[ordenActual.columna];
          
          if (typeof valA === 'string') valA = valA.toLowerCase();
          if (typeof valB === 'string') valB = valB.toLowerCase();

          if (valA < valB) return ordenActual.direccion === 'asc' ? -1 : 1;
          if (valA > valB) return ordenActual.direccion === 'asc' ? 1 : -1;
          return 0;
      });

      notasDisplay.forEach(nota => {
        const tr = document.createElement("tr");
        if (Object.values(nota).some(val => val === "")) tr.classList.add("alerta-vacio");
        
        Object.keys(encabezadosTabla).forEach(key => {
            if (key === 'acciones') return;
            const td = document.createElement("td");
            td.setAttribute('data-label', encabezadosTabla[key]);
            
            let texto = nota[key];
            if (key === 'titular' && texto.length > LIMITE_CARACTERES_TITULAR) {
                texto = texto.substring(0, LIMITE_CARACTERES_TITULAR) + "...";
            }
            td.textContent = texto;
            tr.appendChild(td);
        });

        // Bot√≥n Editar
        const tdAcciones = document.createElement("td");
        tdAcciones.setAttribute('data-label', "Acciones");
        const btn = document.createElement("button");
        btn.textContent = "Editar";
        btn.className = "btn-accion-tabla";
        btn.onclick = () => editarNota(tr);
        tdAcciones.appendChild(btn);
        tr.appendChild(tdAcciones);

        tbody.appendChild(tr);
      });
      
      actualizarIconosOrden();
    }
    
    function filtrarTabla() {
        renderizarTabla();
    }
    
    function ordenarTabla(columna) {
        if (ordenActual.columna === columna) {
            ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
            ordenActual.columna = columna;
            ordenActual.direccion = 'asc';
        }
        renderizarTabla();
    }
    
    function actualizarIconosOrden() {
        document.querySelectorAll('.sortable-header').forEach(th => {
            th.classList.remove('sorted');
            const icon = th.querySelector('.sort-icon');
            icon.className = 'fa-solid fa-sort sort-icon'; // Reset
            
            if (th.dataset.col === ordenActual.columna) {
                th.classList.add('sorted');
                icon.className = ordenActual.direccion === 'asc' ? 'fa-solid fa-sort-up sort-icon' : 'fa-solid fa-sort-down sort-icon';
            }
        });
    }

    function truncarTexto(texto, longitud) {
        return texto.length > longitud ? texto.substring(0, longitud) + "..." : texto;
    }

    // --- INTEGRACIONES ---
    function exportarCSV() {
        if (notas.length === 0) { alert("No hay datos para exportar."); return; }
        let csv = '\uFEFF'; // BOM para Excel
        // Header
        const keys = Object.keys(encabezadosTabla).filter(k => k !== 'acciones');
        csv += keys.map(k => encabezadosTabla[k]).join(",") + "\n";
        
        notas.forEach(nota => {
            const fila = keys.map(k => {
                let val = String(nota[k] || "").replace(/"/g, '""');
                return `"${val}"`;
            });
            csv += fila.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Notas_Prensa_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }

    // üåü FUNCI√ìN ENVIAR A SHEETS (MODIFICADA: FILTRO POR USUARIO) üåü
    async function enviarACalculo(silencioso = false) {
        const usuarioActual = document.getElementById('usuario').value.trim();

        // 1. Validaci√≥n de Usuario
        if (!usuarioActual) {
            if (!silencioso) alert("‚ö†Ô∏è Campo de usuario vac√≠o. Ingresa un usuario para sincronizar.");
            return;
        }

        // 2. Filtrar notas SOLO del usuario actual
        const notasDelUsuario = notas.filter(nota => nota.usuario === usuarioActual);

        if (notasDelUsuario.length === 0) {
            if (!silencioso) alert("‚ö†Ô∏è No hay notas capturadas para el usuario: " + usuarioActual);
            return;
        }

        const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbzVnapqEEmekALj6HyPWdO_BI0foCPPIkAuE-16Jl8jK5_Pxfa5_ZUGTwh80BAlQVb5/exec";

        try {
            if (!silencioso) {
                const btn = document.getElementById('btnGoogleSheets');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            }

            // 3. Enviar arreglo filtrado
            const response = await fetch(URL_APPS_SCRIPT, {
                method: 'POST',
                body: JSON.stringify(notasDelUsuario)
            });

            if (response.ok) {
                if (!silencioso) alert("‚úÖ Notas de " + usuarioActual + " sincronizadas correctamente.");
                console.log("Sincronizaci√≥n exitosa.");
            } else {
                throw new Error(`Error del servidor: ${response.status}`);
            }

        } catch (error) {
            console.error("Error al enviar a Google Sheets:", error);
            if (!silencioso) alert("‚ö†Ô∏è Hubo un problema al conectar con la hoja de c√°lculo. Revisa tu conexi√≥n.");
        } finally {
            if (!silencioso) {
                const btn = document.getElementById('btnGoogleSheets');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-table"></i> Enviar a Sheets';
            }
        }
    }

    async function enviarTelegram() {
        if (notas.length === 0) { alert("No hay notas para enviar."); return; }
        
        // Generar archivo temporal para enviar (reutiliza l√≥gica CSV)
        let csv = '\uFEFF' + Object.keys(encabezadosTabla).filter(k => k !== 'acciones').map(k => encabezadosTabla[k]).join(",") + "\n";
        notas.forEach(nota => {
            csv += Object.keys(encabezadosTabla).filter(k => k !== 'acciones').map(k => `"${String(nota[k] || "").replace(/"/g, '""')}"`).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const formData = new FormData();
        formData.append("chat_id", TELEGRAM_CHAT_ID);
        formData.append("document", blob, `Reporte_Notas_${new Date().toLocaleDateString('es-MX').replace(/\//g,'-')}.csv`);

        const URL_TELEGRAM = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`;
        
        try {
            const btn = document.getElementById('btnTelegram');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
            btn.disabled = true;
            
            const response = await fetch(URL_TELEGRAM, { method: 'POST', body: formData });
            if (response.ok) alert("‚úÖ Reporte enviado a Telegram exitosamente.");
            else alert("‚ùå Error al enviar a Telegram.");
        } catch (e) {
            console.error(e);
            alert("‚ùå Error de conexi√≥n con Telegram.");
        } finally {
            const btn = document.getElementById('btnTelegram');
            btn.innerHTML = '<i class="fa-brands fa-telegram"></i> Enviar por Telegram';
            btn.disabled = false;
        }
    }
    
    function sugerirTema() {
        const input = document.getElementById('sugerenciaTemaInput');
        const tema = input.value.trim();
        if (tema) {
            // L√≥gica ficticia de sugerencia, aqu√≠ podr√≠as enviarlo a otro endpoint o agregarlo localmente
            alert(`Gracias! Tu sugerencia "${tema}" ha sido registrada.`);
            input.value = "";
        }
    }

    // --- BLOQUEO DE CAMPOS ---
    function alternarBloqueo(idCampo) {
        const checkbox = document.getElementById(`check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`);
        const campo = document.getElementById(idCampo);
        
        if (checkbox.checked) {
            campo.classList.add("bloqueado");
            campo.readOnly = true; // Usamos readOnly en lugar de disabled para que se env√≠e en forms si fuera submit tradicional
            localStorage.setItem(idCampo, campo.value); // Persistencia
        } else {
            campo.classList.remove("bloqueado");
            campo.readOnly = false;
            localStorage.removeItem(idCampo);
        }
        localStorage.setItem(`bloqueado_${idCampo}`, checkbox.checked);
    }
    
    function desbloquearTodos() {
        CAMPOS_CON_BLOQUEO.forEach(id => {
             const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
             if (chk) {
                 chk.checked = false;
                 alternarBloqueo(id); // Esto limpia el localStorage y quita clases
             }
        });
        document.querySelectorAll("form input[type='text'], form input[type='date']").forEach(i => i.value = "");
    }

    document.getElementById('btnLimpiar').addEventListener('click', (e) => {
        // El comportamiento por defecto de reset limpia los inputs visualmente,
        // nosotros necesitamos asegurar el estado de bloqueo tambi√©n.
        setTimeout(() => {
            desbloquearTodos();
            renderizarTabla(); // Por si queremos limpiar selecci√≥n de edici√≥n
            resetearEstadoEdicion();
        }, 10);
    });

    // --- INICIALIZACI√ìN ---
    window.onload = function() {
        inicializar();
        
        // Cargar notas locales
        const guardado = localStorage.getItem('notasCapturadas');
        if (guardado) notas = JSON.parse(guardado);
        
        const nextOrden = localStorage.getItem('nextOrdenCaptura');
        if (nextOrden) nextOrdenCaptura = parseInt(nextOrden);

        renderizarTabla();
        
        // Restaurar estado de bloqueos
        CAMPOS_CON_BLOQUEO.forEach(id => {
            const isLocked = localStorage.getItem(`bloqueado_${id}`) === 'true';
            const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (chk) chk.checked = isLocked;
            
            // Restaurar valor si estaba bloqueado
            if (isLocked) {
                const val = localStorage.getItem(id);
                if (val) document.getElementById(id).value = val;
                alternarBloqueo(id);
            }
        });
    };
  </script>
</body>
</html>