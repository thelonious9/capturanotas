<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    :root {
      --color-fondo-pagina: #31302F;       
      --color-fondo-form: #52504E;         
      --color-primary: #6F0909;            
      --color-primary-hover: #792929;      
      --color-secondary: #792929;          
      --color-secondary-hover: #6F0909;    
      --color-danger: #dc3545;             
      --color-light-text: #F0EAD1;         
      --color-dark-text: #31302F;          
      --color-input-bg: #FFFFFF;           
      --radius: 0.25rem;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding: 10px 20px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
    }

    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 1000px;
      margin: 0 auto 30px;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
    }

    .campo { position: relative; display: flex; align-items: center; }
    input[type="text"], input[type="date"] {
      flex-grow: 1;
      padding: 8px;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      margin-right: 5px;
    }

    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: white;
      color: black;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      border: 1px solid #ccc;
    }

    .sugerencia { padding: 8px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background: #eee; }

    .bloqueado { background-color: #d1d1d1 !important; cursor: not-allowed; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-fondo-form);
      table-layout: fixed;
    }

    th, td {
      padding: 10px;
      border: 1px solid #777;
      font-size: 0.8rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Ajuste de anchos para incluir Timestamp */
    #tablaNotas th:nth-child(1) { width: 30px; }  /* # */
    #tablaNotas th:nth-child(5) { width: 150px; } /* Titular */
    #tablaNotas th:nth-child(15) { width: 120px; } /* Timestamp */

    th { background: var(--color-primary); color: white; cursor: pointer; }
    
    .button-group-form { grid-column: span 4; display: flex; justify-content: flex-end; gap: 10px; }
    button { padding: 10px 15px; border-radius: var(--radius); border: none; cursor: pointer; font-weight: bold; color: white; }
    #btnGuardar { background: var(--color-primary); }
    #btnLimpiar { background: var(--color-secondary); }
  </style>
</head>
<body>

  <header>
    <h1>Sistema de Captura</h1>
  </header>

  <form id="formCaptura">
    <label>Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')">
    </div>

    <label>Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')">
    </div>

    <label>Medio:</label>
    <div class="campo">
      <input type="text" id="medio" autocomplete="off" required>
      <div id="sugMedio" class="sugerencias"></div>
    </div>

    <label>Titular:</label>
    <div class="campo">
      <input type="text" id="titular" required>
    </div>

    <label>Firma:</label>
    <div class="campo">
      <input type="text" id="firma" autocomplete="off">
      <div id="sugFirma" class="sugerencias"></div>
    </div>

    <label>Página:</label>
    <div class="campo">
      <input type="text" id="pagina" required>
    </div>

    <label>Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" autocomplete="off" required>
      <div id="sugDep" class="sugerencias"></div>
    </div>

    <label>Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" autocomplete="off" required>
      <div id="sugOrg" class="sugerencias"></div>
    </div>

    <label>Género:</label>
    <div class="campo">
      <input type="text" id="genero" autocomplete="off" required>
      <div id="sugGenero" class="sugerencias"></div>
    </div>

    <label>Canal:</label>
    <div class="campo">
      <input type="text" id="canal" autocomplete="off" required>
      <div id="sugCanal" class="sugerencias"></div>
    </div>

    <label>Tema:</label>
    <div class="campo">
      <input type="text" id="tema" autocomplete="off">
      <div id="sugTema" class="sugerencias"></div>
    </div>

    <label>Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" autocomplete="off" required>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label>Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" autocomplete="off" required>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>

    <div class="button-group-form">
      <button type="submit" id="btnGuardar">Guardar</button>
      <button type="reset" id="btnLimpiar">Limpiar</button>
    </div>
  </form>

  <div style="margin: 20px 0;">
    <button onclick="exportarCSV()" style="background: #444;">Exportar CSV</button>
    <input type="text" id="buscador" placeholder="Buscar..." style="padding: 8px; width: 200px;">
  </div>

  <table id="tablaNotas">
    <thead>
      <tr>
        <th>#</th><th>Usuario</th><th>Fecha</th><th>Medio</th><th>Titular</th>
        <th>Firma</th><th>Pág</th><th>Dep</th><th>Org</th><th>Gen</th>
        <th>Canal</th><th>Tema</th><th>Est</th><th>Mun</th><th>Timestamp</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let notas = [];
    let nextOrden = 1;
    let filaEnEdicion = null;

    // Campos de datos incluyendo el nuevo Timestamp
    const CAMPOS = ["orden", "usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio", "timestamp"];

    const urls = {
      dependencias: "./Dependencia.csv",
      medios: "./Medio.csv",
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      firmas: "./Firma.csv"
    };

    // --- FUNCIONES DE AUTOCOMPLETADO (RESTABLECIDAS) ---
    function configurarAutocompletado(idInput, idSug, lista, callback) {
      const input = document.getElementById(idInput);
      const sugDiv = document.getElementById(idSug);
      let indiceResaltado = -1;

      input.addEventListener("input", () => {
        const val = input.value.toLowerCase();
        sugDiv.innerHTML = "";
        indiceResaltado = -1;
        if (!val) return;

        const filtrados = lista.filter(item => item.toLowerCase().includes(val));
        filtrados.forEach((item, i) => {
          const div = document.createElement("div");
          div.textContent = item;
          div.className = "sugerencia";
          div.onclick = () => {
            input.value = item;
            sugDiv.innerHTML = "";
            if (callback) callback(item);
          };
          sugDiv.appendChild(div);
        });
      });

      input.addEventListener("keydown", (e) => {
        const items = sugDiv.querySelectorAll(".sugerencia");
        if (e.key === "ArrowDown") {
          indiceResaltado = (indiceResaltado + 1) % items.length;
          actualizarResaltado(items);
        } else if (e.key === "ArrowUp") {
          indiceResaltado = (indiceResaltado - 1 + items.length) % items.length;
          actualizarResaltado(items);
        } else if (e.key === "Enter" && indiceResaltado > -1) {
          e.preventDefault();
          items[indiceResaltado].click();
        }
      });

      function actualizarResaltado(items) {
        items.forEach((it, i) => it.classList.toggle("resaltado", i === indiceResaltado));
      }
    }

    // --- LÓGICA DE DATOS ---
    async function cargarCSV(url) {
      try {
        const res = await fetch(`${url}?t=${Date.now()}`);
        const texto = await res.text();
        return texto.split("\n").map(l => l.split(",")).slice(1).map(c => c[0]?.trim()).filter(Boolean);
      } catch (e) { return []; }
    }

    function renderizarTabla() {
      const tbody = document.querySelector("#tablaNotas tbody");
      tbody.innerHTML = "";
      notas.forEach((n, index) => {
        const tr = document.createElement("tr");
        CAMPOS.forEach(campo => {
          const td = document.createElement("td");
          td.textContent = n[campo] || "";
          tr.appendChild(td);
        });
        const tdAcciones = document.createElement("td");
        tdAcciones.innerHTML = `<button onclick="editarNota(${index})" style="background:orange; padding:2px 5px;">Ed</button>`;
        tr.appendChild(tdAcciones);
        tbody.appendChild(tr);
      });
    }

    document.getElementById("formCaptura").onsubmit = (e) => {
      e.preventDefault();
      const ahora = new Date();
      const timestampStr = ahora.toLocaleDateString() + " " + ahora.toLocaleTimeString();

      const nuevaNota = {};
      CAMPOS.filter(c => c !== 'orden' && c !== 'timestamp').forEach(c => {
        nuevaNota[c] = document.getElementById(c).value;
      });

      if (filaEnEdicion !== null) {
        nuevaNota.orden = notas[filaEnEdicion].orden;
        nuevaNota.timestamp = timestampStr; // Actualiza hora al editar
        notas[filaEnEdicion] = nuevaNota;
        filaEnEdicion = null;
        document.getElementById("btnGuardar").textContent = "Guardar";
      } else {
        nuevaNota.orden = nextOrden++;
        nuevaNota.timestamp = timestampStr;
        notas.push(nuevaNota);
      }

      localStorage.setItem("notas", JSON.stringify(notas));
      localStorage.setItem("nextOrden", nextOrden);
      renderizarTabla();
      limpiarNoBloqueados();
    };

    function limpiarNoBloqueados() {
      CAMPOS.filter(c => c !== 'orden' && c !== 'timestamp').forEach(c => {
        const input = document.getElementById(c);
        if (!input.classList.contains("bloqueado")) input.value = "";
      });
      document.getElementById("titular").focus();
    }

    function alternarBloqueo(id) {
      const input = document.getElementById(id);
      const isChecked = document.getElementById("check" + id.charAt(0).toUpperCase() + id.slice(1)).checked;
      input.classList.toggle("bloqueado", isChecked);
      input.readOnly = isChecked;
    }

    function editarNota(i) {
      filaEnEdicion = i;
      const n = notas[i];
      CAMPOS.filter(c => c !== 'orden' && c !== 'timestamp').forEach(c => {
        document.getElementById(c).value = n[c];
      });
      document.getElementById("btnGuardar").textContent = "Actualizar";
      window.scrollTo(0, 0);
    }

    function exportarCSV() {
      let csv = "\uFEFF" + CAMPOS.join(",") + "\n";
      notas.forEach(n => {
        csv += CAMPOS.map(c => `"${n[c]}"`).join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "notas.csv";
      link.click();
    }

    // --- INICIO ---
    document.addEventListener("DOMContentLoaded", async () => {
      const [medios, generos, estatus, temas, municipios, firmas] = await Promise.all([
        cargarCSV(urls.medios), cargarCSV(urls.generos), cargarCSV(urls.estatus),
        cargarCSV(urls.temas), cargarCSV(urls.municipios), cargarCSV(urls.firmas)
      ]);

      configurarAutocompletado("medio", "sugMedio", medios);
      configurarAutocompletado("genero", "sugGenero", generos);
      configurarAutocompletado("estatus", "sugEstatus", estatus);
      configurarAutocompletado("tema", "sugTema", temas);
      configurarAutocompletado("municipio", "sugMunicipio", municipios);
      configurarAutocompletado("firma", "sugFirma", firmas);

      const saved = localStorage.getItem("notas");
      if (saved) {
        notas = JSON.parse(saved);
        nextOrden = parseInt(localStorage.getItem("nextOrden") || 1);
        renderizarTabla();
      }
    });
  </script>
</body>
</html>