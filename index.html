<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Tus estilos completos aquÃ­ (NO MODIFICADOS) -->
  <!-- â¬‡ï¸ Pega aquÃ­ exactamente el mismo bloque CSS que ya tienes â¬‡ï¸ -->
  <!-- (No lo repito para no saturar el mensaje, pero no cambia nada) -->
  <style>
    /* ImportaciÃ³n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;       /* Oscuro Suave */
      --color-fondo-form: #52504E;         /* Gris CÃ¡lido (Fondo del Formulario) */
      --color-primary: #6F0909;            /* Rojo Intenso (Guardar/Borrar Todo) */
      --color-primary-hover: #792929;      /* Rojo Suave */
      --color-secondary: #792929;          /* Rojo Suave (BotÃ³n Limpiar/Hover) */
      --color-secondary-hover: #6F0909;    /* Rojo Intenso */
      --color-danger: #dc3545;             /* Rojo estÃ¡ndar para peligro */
      --color-danger-hover: #c82333;       /* Rojo oscuro */
      --color-telegram: #0088cc;           
      --color-telegram-hover: #0077b3;     
      --color-dark-text: #31302F;          /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;         /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;           /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;       
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    
    /* --- FORMULARIO (MODIFICACIÃ“N DE LAYOUT) --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
        outline: none;
    }
    
    /* ğŸŒŸ REGLAS PARA CAMPOS DE ANCHO COMPLETO ğŸŒŸ */
    /* Usuario (Label: 2do elemento, Input: 3er elemento) -> Ocupan 4 columnas */
    form > label:nth-child(2), 
    form > div:nth-child(3) {
        grid-column: 1 / span 4; 
    }
    
    /* Titular (Label: 8vo elemento, Input: 9no elemento) -> Ocupan 4 columnas */
    form > label:nth-child(8), 
    form > div:nth-child(9) {
        grid-column: 1 / span 4; 
    }
    
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    
    /* --- BLOQUEO --- */
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    
    /* --- BOTONES --- */
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    button i { margin-right: 8px; font-size: 1.1em; }
    
    /* --- TABLA (CORRECCIÃ“N DE DEFORMACIÃ“N Y TRUNCAMIENTO) --- */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      /* ğŸŒŸ CORRECCIÃ“N CLAVE: Fija el layout de la tabla para evitar deformaciÃ³n */
      table-layout: fixed; 
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      /* Asegura que el contenido se ajuste al ancho fijo y se trunque */
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
      /* Eliminamos max-width conflictivos */
      max-width: none !important; 
    }

    /* ğŸŒŸ DEFINICIÃ“N DE ANCHOS PROPORCIONALES (15 columnas: Total 100%) - ORDEN ACTUALIZADO ğŸŒŸ */
    /* Nuevo orden: #, Usuario, Fecha, Medio, Titular, Firma, PÃ¡gina, Dependencia, Organismo, GÃ©nero, Canal, Tema, Estatus, Municipio, Acciones */
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 3%; }    /* # (ordenCaptura) */
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 7%; }    /* Usuario */
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }    /* Fecha */
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 8%; }    /* Medio */
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 15%; }   /* Titular (15%) */
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 6%; }    /* Firma (6%) */
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 5%; }    /* PÃ¡gina (5%) */
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 7%; }    /* Dependencia (7%) */
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 7%; }    /* Organismo (7%) */
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }  /* GÃ©nero (5%) */
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }  /* Canal (5%) */
    #tablaNotas th:nth-child(12), #tablaNotas td:nth-child(12) { width: 7%; }  /* Tema (7%) */
    #tablaNotas th:nth-child(13), #tablaNotas td:nth-child(13) { width: 5%; }  /* Estatus (5%) */
    #tablaNotas th:nth-child(14), #tablaNotas td:nth-child(14) { width: 6%; }  /* Municipio (6%) */
    #tablaNotas th:nth-child(15), #tablaNotas td:nth-child(15) { width: 6%; }  /* Acciones (6%) */

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #5D5C5A; } 
    /* ğŸŒŸ MEJORA: Resaltar fila al pasar el cursor */
    tbody tr:hover { 
      background-color: #6C6B69; 
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    .sorted.alerta-vacio .sort-icon { color: var(--color-dark-text); }
    
    /* --- GRUPO DE ACCIONES (Globales) --- */
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 25px; 
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan */
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    
    /* ğŸŒŸ NUEVO ESTILO: Enviar a Sheets ğŸŒŸ */
    #btnGoogleSheets { background-color: #0A66C2; }
    #btnGoogleSheets:hover { background-color: #0959A8; }
    
    #btnTelegram { background-color: #0088cc; }
    #btnTelegram:hover { background-color: #0077b3; }
    
    /* BotÃ³n Sugerir Tema - Nuevo Estilo */
    #btnSugerirTema { background-color: #096F4B; }
    #btnSugerirTema:hover { background-color: #0A7E56; }
    #btnSugerirTema i { margin-right: 0; } /* Quitar margen del icono en botÃ³n Sugerir Tema (ya que estÃ¡ al final) */


    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }

    /* --- NUEVOS ESTILOS PARA CAMPO DE SUGERENCIA DE TEMA DEDICADO --- */
    .suggestion-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        /* Estilo para que se distinga como un grupo funcional */
        background-color: #4A4A4A; 
        padding: 8px; 
        border-radius: var(--radius);
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #sugerenciaTemaInput {
        padding: 10px 15px;
        border: 1px solid var(--color-primary-hover);
        border-radius: var(--radius);
        background-color: var(--color-input-bg);
        color: var(--color-dark-text);
        flex-grow: 1; 
        width: 250px; /* Ancho base */
    }
    /* El botÃ³n sugerir tema ahora va dentro del grupo de sugerencia */
    .suggestion-input-group #btnSugerirTema {
        margin-right: 0;
        padding: 10px 15px; 
    }
    /* --- FIN NUEVOS ESTILOS --- */


    /* BotÃ³n Editar en Tabla */
    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }
    
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        .actions-group { flex-direction: column; align-items: stretch; }
        .actions-group button { width: 100%; margin-bottom: 10px; }
        
        /* Responsive para el grupo de sugerencia */
        .suggestion-input-group {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            padding: 15px 10px; /* MÃ¡s padding para que se vea mejor */
        }
        #sugerenciaTemaInput {
            max-width: none;
            width: 100%;
            margin-bottom: 5px;
        }
        .suggestion-input-group #btnSugerirTema {
             width: 100%;
        }

        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #7D7C79; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #8D8C8A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            /* Resetear para responsive */
            width: auto;
            max-width: 100%; 
            white-space: normal;
            text-overflow: clip; 
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
        .alerta-vacio td { color: var(--color-dark-text) !important; }
    }
    /* â­ ESTILO DEL BOTÃ“N NUEVO â­ */
#btnRecuperar {
    background-color: #4A4A4A;
}
#btnRecuperar:hover {
    background-color: #616161;
}
</style>
</head>
<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Prensa</h1>
  </header>

  <form>
    <div class="form-logo-container">
        <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">ğŸ”’</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">ğŸ”’</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
      <label for="checkMedio">ğŸ”’</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>
    
    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">ğŸ”’</label>
    </div>

    <label for="firma">Firma:</label>
    <div class="campo">
      <input type="text" id="firma" name="firma" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
      <label for="checkFirma">ğŸ”’</label>
      <div id="sugFirma" class="sugerencias"></div>
    </div>
    
    <label for="pagina">PÃ¡gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina" required> 
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
      <label for="checkPagina">ğŸ”’</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">ğŸ”’</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">ğŸ”’</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>
    
    <label for="genero">GÃ©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">ğŸ”’</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>
    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">ğŸ”’</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>
    
    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">ğŸ”’</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>
    
    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">ğŸ”’</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">ğŸ”½</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">ğŸ”’</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>
    <label></label>
    <div class="campo"></div>


    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="actions-group">

    <div class="suggestion-input-group">
        <input type="text" id="sugerenciaTemaInput" placeholder="Escribe aquÃ­ tu sugerencia de tema" required>
        <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
            Sugerir Tema <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>

    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-file-csv"></i> Exportar a hoja de cÃ¡lculo
    </button>

    <button id="btnGoogleSheets" onclick="enviarACalculo()">
      <i class="fa-solid fa-table"></i> Enviar a Sheets
    </button>

    <button id="btnTelegram" onclick="enviarTelegram()">
      <i class="fa-brands fa-telegram"></i> Enviar por Telegram
    </button>

    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-trash-can"></i> Borrar Todas
    </button>
    <!-- â­ NUEVO BOTÃ“N â­ -->
    <button id="btnRecuperar" onclick="abrirRecuperacion()">
      <i class="fa-solid fa-cloud-arrow-down"></i> Recuperar mis notas
    </button>
</div>
  <div id="erroresCarga" class="error-carga"></div>
    <div class="buscador-container">
      <i class="fas fa-search buscador-icon"></i>
      <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Medio, etc.)">
       </div>
  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th data-col="ordenCaptura"><div class="sortable-header"># <span class="sort-icon"></span></div></th>
        <th data-col="usuario"><div class="sortable-header">Usuario <span class="sort-icon"></span></div></th>
        <th data-col="fecha"><div class="sortable-header">Fecha <span class="sort-icon"></span></div></th>
        <th data-col="medio"><div class="sortable-header">Medio <span class="sort-icon"></span></div></th>
        <th data-col="titular"><div class="sortable-header">Titular <span class="sort-icon"></span></div></th>
        <th data-col="firma"><div class="sortable-header">Firma <span class="sort-icon"></span></div></th>
        <th data-col="pagina"><div class="sortable-header">PÃ¡gina <span class="sort-icon"></span></div></th>
        <th data-col="dependencia"><div class="sortable-header">Dependencia <span class="sort-icon"></span></div></th>
        <th data-col="organismo"><div class="sortable-header">Organismo <span class="sort-icon"></span></div></th>
        <th data-col="genero"><div class="sortable-header">GÃ©nero <span class="sort-icon"></span></div></th>
        <th data-col="canal"><div class="sortable-header">Canal <span class="sort-icon"></span></div></th>
        <th data-col="tema"><div class="sortable-header">Tema <span class="sort-icon"></span></div></th>
        <th data-col="estatus"><div class="sortable-header">Estatus <span class="sort-icon"></span></div></th>
        <th data-col="municipio"><div class="sortable-header">Municipio <span class="sort-icon"></span></div></th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>
<!-- â­ MODAL PARA RECUPERAR NOTAS â­ -->
<div id="modalRecuperar" style="
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); backdrop-filter:blur(3px);
    justify-content:center; align-items:center; z-index:9999;">
    
    <div style="
        background:#52504E; padding:25px; border-radius:8px; width:350px;
        box-shadow:0 0 10px rgba(0,0,0,0.3); color:#F0EAD1;">
        
        <h3>Recuperar notas</h3>

        <label>Usuario:</label>
        <input id="recUser" type="text" style="width:100%; margin-bottom:10px;">

        <label>ContraseÃ±a:</label>
        <input id="recPass" type="password" style="width:100%; margin-bottom:10px;">

        <label>Fecha (opcional):</label>
        <input id="recFecha" type="date" style="width:100%; margin-bottom:15px;">

        <button onclick="ejecutarRecuperacion()" style="background:#6F0909; color:white; padding:8px 12px; border:none; border-radius:4px;">Buscar</button>
        <button onclick="cerrarRecuperacion()" style="background:#4A4A4A; color:white; padding:8px 12px; border:none; border-radius:4px;">Cerrar</button>
    </div>
</div>
  <script>
/* ============================================================
   ğŸ”´ PARTE 1 â€” CONSTANTES, VARIABLES Y CARGA DE CSV
   ============================================================ */

let notas = [];
let filaEnEdicion = null;
let nextOrdenCaptura = 1;

const camposDeDatos = [
  "ordenCaptura", "usuario", "fecha", "medio", "titular", "firma",
  "pagina", "dependencia", "organismo", "genero", "canal",
  "tema", "estatus", "municipio"
];

const CAMPOS_CON_BLOQUEO = [
  "usuario", "fecha", "medio", "titular", "firma", "pagina",
  "dependencia", "organismo", "genero", "canal", "tema",
  "estatus", "municipio"
];

const encabezadosTabla = {
  "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha",
  "medio": "Medio", "titular": "Titular", "firma": "Firma",
  "pagina": "PÃ¡gina", "dependencia": "Dependencia",
  "organismo": "Organismo", "genero": "GÃ©nero", "canal": "Canal",
  "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio",
  "acciones": "Acciones"
};

let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

// RUTAS RELATIVAS (GitHub / misma carpeta)
const urls = {
  dependencias: "./Dependencia.csv",
  medios: "./Medio.csv",    // Medio â†’ Canal
  generos: "./Genero.csv",
  estatus: "./Estatus.csv",
  temas: "./Tema.csv",
  municipios: "./Municipio.csv",
  firmas: "./Firma.csv"     // Medio â†’ Firmas
};

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxxdxuNpakiN9JzrdovTLTWYAwMpQNx6-PVSRh8_HvRiJFZa3WIyAUNQ3azWmm3bG3y/exec";

const TELEGRAM_BOT_TOKEN = "8428524335:AAFeKrvKrUxrI9NAkL_G1-X6LdL4F5fkV4";
const TELEGRAM_CHAT_ID = "-1003492273306";

function findKeyCaseInsensitive(map, value) {
  if (!value) return null;
  const lowerValue = value.toLowerCase();
  for (const key in map) {
    if (key.toLowerCase() === lowerValue) return key;
  }
  return null;
}

async function cargarCSV(url) {
  try {
    const res = await fetch(`${url}?t=${Date.now()}`);
    const buffer = await res.arrayBuffer();
    const texto = new TextDecoder('utf-8').decode(buffer);
    return texto.split('\n').map(linea => linea.split(','));
  } catch (e) {
    const divErrores = document.getElementById("erroresCarga");
    if (divErrores) {
      divErrores.innerText += `Error al cargar ${url}: ${e.message}\n`;
    }
    return [];
  }
}

function limpiarFilasCSV(filas) {
  if (!filas || filas.length === 0) return [];
  if (filas[0] && filas[0][0]) filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
  const encabezado = filas[0].map(c => (c || "").toLowerCase()).join(",");
  const tieneEncabezado =
    encabezado.includes("dependencia") ||
    encabezado.includes("medio") ||
    encabezado.includes("firm") ||
    encabezado.includes("canal");
  if (tieneEncabezado) filas = filas.slice(1);
  return filas
    .map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim()))
    .filter(r => r[0]);
}

async function cargarLista(url) {
  const filas = limpiarFilasCSV(await cargarCSV(url));
  return Array.from(new Set(filas.map(r => r[0])))
    .sort((a, b) => a.localeCompare(b, 'es'));
}

/* ============================================================
   ğŸ”´ PARTE 1B â€” MAPAS DINÃMICOS (Dependencia/Medio)
   ============================================================ */

let mapaDependenciaOrganismos = {};
let mapaMedioFirmas = {};
let mapaMedioCanal = {};

/* Dependencia.csv â†’ Dependencia â†’ Organismos */
async function cargarDependenciasYOrganismos() {
  const filas = await cargarCSV(urls.dependencias);
  const limpias = limpiarFilasCSV(filas);

  mapaDependenciaOrganismos = {};

  limpias.forEach(([dependencia, organismo]) => {
    if (!dependencia) return;

    dependencia = dependencia.trim();
    organismo = organismo ? organismo.trim() : "";

    if (!mapaDependenciaOrganismos[dependencia]) {
      mapaDependenciaOrganismos[dependencia] = [];
    }

    if (organismo && !mapaDependenciaOrganismos[dependencia].includes(organismo)) {
      mapaDependenciaOrganismos[dependencia].push(organismo);
    }
  });

  Object.keys(mapaDependenciaOrganismos).forEach(dep => {
    mapaDependenciaOrganismos[dep].sort((a, b) => a.localeCompare(b, "es"));
  });

  datosSugerencias.dependencia = Object.keys(mapaDependenciaOrganismos)
    .sort((a, b) => a.localeCompare(b, "es"));
}

/* Medio.csv â†’ Medio â†’ Canal */
async function cargarMediosYCanales() {
  const filas = await cargarCSV(urls.medios);
  const limpias = limpiarFilasCSV(filas);

  mapaMedioCanal = {};

  limpias.forEach(([medio, canal]) => {
    if (!medio) return;
    medio = medio.trim();
    canal = canal ? canal.trim() : "";
    if (!mapaMedioCanal[medio]) {
      mapaMedioCanal[medio] = canal;
    }
  });

  datosSugerencias.medio = Object.keys(mapaMedioCanal)
    .sort((a, b) => a.localeCompare(b, "es"));
}

/* Firma.csv â†’ Medio â†’ Firmas */
async function cargarMediosYFirmas() {
  const filas = await cargarCSV(urls.firmas);
  const limpias = limpiarFilasCSV(filas);

  mapaMedioFirmas = {};

  limpias.forEach(([medio, firma]) => {
    if (!medio) return;

    medio = medio.trim();
    firma = firma ? firma.trim() : "";

    if (!mapaMedioFirmas[medio]) {
      mapaMedioFirmas[medio] = [];
    }

    if (firma && !mapaMedioFirmas[medio].includes(firma)) {
      mapaMedioFirmas[medio].push(firma);
    }
  });

  Object.keys(mapaMedioFirmas).forEach(m => {
    mapaMedioFirmas[m].sort((a, b) => a.localeCompare(b, "es"));
  });

  // Nota: datosSugerencias.medio ya se llenÃ³ con Medio.csv
}

/* ============================================================
   ğŸ”´ PARTE 2 â€” FORMULARIO (GUARDAR, EDITAR, TABLA)
   ============================================================ */

function agregarFilaATabla(nota) {
  const tbody = document.querySelector("#tablaNotas tbody");
  const tr = document.createElement("tr");

  camposDeDatos.forEach(campo => {
    const td = document.createElement("td");
    td.setAttribute("data-label", encabezadosTabla[campo]);
    td.textContent = nota[campo] || "";
    tr.appendChild(td);
  });

  const tdAcciones = document.createElement("td");
  tdAcciones.setAttribute("data-label", "Acciones");
  tdAcciones.innerHTML = `
    <button class="btn-accion-tabla" onclick="editarNota(this)">Editar</button>
  `;
  tr.appendChild(tdAcciones);

  tbody.appendChild(tr);
}

function guardarNota(event) {
  event.preventDefault();

  const nota = {};
  camposDeDatos.forEach(campo => {
    if (campo === "ordenCaptura") {
      nota[campo] = nextOrdenCaptura++;
    } else {
      const el = document.getElementById(campo);
      nota[campo] = el ? el.value.trim() : "";
    }
  });

  notas.push(nota);
  agregarFilaATabla(nota);

  guardarEnSheets(nota);

  document.querySelector("form").reset();
  document.getElementById("btnEliminar").style.display = "none";
  filaEnEdicion = null;
}

function editarNota(btn) {
  const tr = btn.closest("tr");
  filaEnEdicion = tr;

  const tds = tr.querySelectorAll("td");

  camposDeDatos.forEach((campo, i) => {
    const el = document.getElementById(campo);
    if (el) el.value = tds[i].textContent;
  });

  document.getElementById("btnEliminar").style.display = "inline-block";
}

function borrarNota() {
  if (!filaEnEdicion) return;

  const index = Array.from(filaEnEdicion.parentNode.children).indexOf(filaEnEdicion);
  if (index >= 0) {
    notas.splice(index, 1);
  }
  filaEnEdicion.remove();
  filaEnEdicion = null;

  document.getElementById("btnEliminar").style.display = "none";
}

function borrarTodo() {
  notas = [];
  document.querySelector("#tablaNotas tbody").innerHTML = "";
  nextOrdenCaptura = 1;
}

/* ============================================================
   ğŸ”´ PARTE 3 â€” GOOGLE SHEETS
   ============================================================ */

async function guardarEnSheets(nota) {
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nota)
    });

    const data = await res.json();

    if (data.result !== "success") {
      console.error("âŒ Error al guardar en Sheets:", data.message);
    }

  } catch (err) {
    console.error("âŒ Error de conexiÃ³n con Google Sheets:", err);
  }
}

async function recuperarNotas(usuario, password, fecha = "") {
  const url = `${APPS_SCRIPT_URL}?usuario=${encodeURIComponent(usuario)}&password=${encodeURIComponent(password)}&fecha=${encodeURIComponent(fecha)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.error) {
      alert("âš  " + data.error);
      return [];
    }

    return data;

  } catch (err) {
    alert("âŒ Error al conectar con Google Sheets");
    return [];
  }
}

/* ============================================================
   ğŸ”´ PARTE 4 â€” MODAL DE RECUPERACIÃ“N
   ============================================================ */

function abrirRecuperacion() {
  document.getElementById("modalRecuperar").style.display = "flex";
}

function cerrarRecuperacion() {
  document.getElementById("modalRecuperar").style.display = "none";
}

async function ejecutarRecuperacion() {
  const usuario = document.getElementById("recUser").value.trim();
  const password = document.getElementById("recPass").value.trim();
  const fecha = document.getElementById("recFecha").value.trim();

  if (!usuario || !password) {
    alert("âš  Usuario y contraseÃ±a son obligatorios");
    return;
  }

  const notasRecuperadas = await recuperarNotas(usuario, password, fecha);

  if (!notasRecuperadas || notasRecuperadas.length === 0) {
    alert("No se encontraron notas");
    return;
  }

  notas = [];
  document.querySelector("#tablaNotas tbody").innerHTML = "";
  nextOrdenCaptura = 1;

  notasRecuperadas.forEach(nota => {
    if (!nota.ordenCaptura) nota.ordenCaptura = nextOrdenCaptura++;
    notas.push(nota);
    agregarFilaATabla(nota);
  });

  cerrarRecuperacion();
  alert("âœ” Notas recuperadas correctamente");
}

/* ============================================================
   ğŸ”´ PARTE 5 â€” SUGERENCIAS, BLOQUEO, BUSCADOR, SORTING
   ============================================================ */

let datosSugerencias = {
  medio: [],
  firma: [],
  dependencia: [],
  organismo: [],
  genero: [],
  canal: [],
  tema: [],
  estatus: [],
  municipio: []
};

function alternarBloqueo(campo) {
  const input = document.getElementById(campo);
  const check = document.getElementById("check" + campo.charAt(0).toUpperCase() + campo.slice(1));

  if (!input || !check) return;

  if (check.checked) {
    input.classList.add("bloqueado");
    input.setAttribute("readonly", true);
  } else {
    input.classList.remove("bloqueado");
    input.removeAttribute("readonly");
  }
}

function mostrarSugerencias(campo, contenedorId) {
  const contenedor = document.getElementById(contenedorId);
  const input = document.getElementById(campo);
  if (!contenedor || !input) return;

  const valor = input.value.toLowerCase();
  contenedor.innerHTML = "";

  const lista = datosSugerencias[campo] || [];

  const filtradas = lista.filter(item =>
    item.toLowerCase().includes(valor)
  );

  filtradas.forEach(item => {
    const div = document.createElement("div");
    div.classList.add("sugerencia");
    div.textContent = item;
    div.onclick = () => {
      input.value = item;
      contenedor.innerHTML = "";
      // Disparar lÃ³gica asociada a cambios (por ejemplo Canal/Firma/Organismo)
      input.dispatchEvent(new Event("input"));
    };
    contenedor.appendChild(div);
  });
}

const inputBuscador = document.getElementById("buscador");
if (inputBuscador) {
  inputBuscador.addEventListener("input", function () {
    const texto = this.value.toLowerCase();
    const filas = document.querySelectorAll("#tablaNotas tbody tr");

    filas.forEach(fila => {
      const contenido = fila.textContent.toLowerCase();
      fila.style.display = contenido.includes(texto) ? "" : "none";
    });
  });
}

document.querySelectorAll("#tablaNotas th[data-col]").forEach(th => {
  th.addEventListener("click", () => {
    const columna = th.getAttribute("data-col");

    if (ordenActual.columna === columna) {
      ordenActual.direccion = ordenActual.direccion === "asc" ? "desc" : "asc";
    } else {
      ordenActual.columna = columna;
      ordenActual.direccion = "asc";
    }

    ordenarTabla();
  });
});

function ordenarTabla() {
  notas.sort((a, b) => {
    const valA = (a[ordenActual.columna] || "").toString().toLowerCase();
    const valB = (b[ordenActual.columna] || "").toString().toLowerCase();

    if (ordenActual.direccion === "asc") {
      return valA > valB ? 1 : valA < valB ? -1 : 0;
    } else {
      return valA < valB ? 1 : valA > valB ? -1 : 0;
    }
  });

  document.querySelector("#tablaNotas tbody").innerHTML = "";
  notas.forEach(nota => agregarFilaATabla(nota));
}

/* ============================================================
   ğŸ”´ PARTE 5B â€” LISTAS DEPENDIENTES
   ============================================================ */

/* Dependencia â†’ Organismo */
const inputDependencia = document.getElementById("dependencia");
if (inputDependencia) {
  inputDependencia.addEventListener("input", function () {
    const dep = this.value.trim();
    if (mapaDependenciaOrganismos[dep]) {
      datosSugerencias.organismo = mapaDependenciaOrganismos[dep];
    } else {
      datosSugerencias.organismo = [];
    }
  });
}

/* Medio â†’ Canal + Firmas */
const inputMedio = document.getElementById("medio");
if (inputMedio) {
  inputMedio.addEventListener("input", function () {
    const medio = this.value.trim();

    // Medio â†’ Canal
    const canalInput = document.getElementById("canal");
    if (canalInput) {
      if (mapaMedioCanal[medio]) {
        canalInput.value = mapaMedioCanal[medio];
      } else {
        // Si no se encuentra, no forzamos valor
        // canalInput.value = "";
      }
    }

    // Medio â†’ Firmas
    if (mapaMedioFirmas[medio]) {
      datosSugerencias.firma = mapaMedioFirmas[medio];
    } else {
      datosSugerencias.firma = [];
    }
  });
}

/* ============================================================
   ğŸ”´ CARGA INICIAL
   ============================================================ */

async function cargarDatosIniciales() {
  await cargarDependenciasYOrganismos(); // Dependencia â†’ Organismos
  await cargarMediosYCanales();         // Medio â†’ Canal
  await cargarMediosYFirmas();          // Medio â†’ Firmas

  datosSugerencias.genero = await cargarLista(urls.generos);
  datosSugerencias.canal = ["Impresos locales", "Impresos nacionales", "Portales locales",
                            "Portales nacionales", "Radio nacional", "TV nacional"];
  datosSugerencias.tema = await cargarLista(urls.temas);
  datosSugerencias.estatus = await cargarLista(urls.estatus);
  datosSugerencias.municipio = await cargarLista(urls.municipios);
}

document.querySelector("form").addEventListener("submit", guardarNota);

window.onload = () => {
  cargarDatosIniciales();
};
</script>
  <footer>
    Â© 2025 Francisco Villeda. Todos los derechos reservados.
  </footer>
</body>
</html>