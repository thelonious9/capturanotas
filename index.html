<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    /* Importaci√≥n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;       /* Oscuro Suave */
      --color-fondo-form: #52504E;         /* Gris C√°lido (Fondo del Formulario) */
      --color-primary: #6F0909;            /* Rojo Intenso (Guardar/Borrar Todo) */
      --color-primary-hover: #792929;      /* Rojo Suave */
      --color-secondary: #792929;          /* Rojo Suave (Bot√≥n Limpiar/Hover) */
      --color-secondary-hover: #6F0909;    /* Rojo Intenso */
      --color-danger: #dc3545;             /* Rojo est√°ndar para peligro */
      --color-danger-hover: #c82333;       /* Rojo oscuro */
      --color-telegram: #0088cc;           
      --color-telegram-hover: #0077b3;     
      --color-dark-text: #31302F;          /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;         /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;           /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;       
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    
    /* --- FORMULARIO (MODIFICACI√ìN DE LAYOUT) --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
        outline: none;
    }
    
    /* üåü REGLAS PARA CAMPOS DE ANCHO COMPLETO üåü */
    /* Usuario (Label: 2do elemento, Input: 3er elemento) -> Ocupan 4 columnas */
    form > label:nth-child(2), 
    form > div:nth-child(3) {
        grid-column: 1 / span 4; 
    }
    
    /* Titular (Label: 8vo elemento, Input: 9no elemento) -> Ocupan 4 columnas */
    form > label:nth-child(8), 
    form > div:nth-child(9) {
        grid-column: 1 / span 4; 
    }
    
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    
    /* --- BLOQUEO --- */
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    
    /* --- BOTONES --- */
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    button i { margin-right: 8px; font-size: 1.1em; }
    
    /* --- TABLA (CORRECCI√ìN DE DEFORMACI√ìN Y TRUNCAMIENTO) --- */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      /* üåü CORRECCI√ìN CLAVE: Fija el layout de la tabla para evitar deformaci√≥n */
      table-layout: fixed; 
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      /* Asegura que el contenido se ajuste al ancho fijo y se trunque */
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
      /* Eliminamos max-width conflictivos */
      max-width: none !important; 
    }

    /* üåü DEFINICI√ìN DE ANCHOS PROPORCIONALES (15 columnas: Total 100%) - ORDEN ACTUALIZADO üåü */
    /* Nuevo orden: #, Usuario, Fecha, Medio, Titular, Firma, P√°gina, Dependencia, Organismo, G√©nero, Canal, Tema, Estatus, Municipio, Acciones */
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 3%; }    /* # (ordenCaptura) */
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 7%; }    /* Usuario */
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }    /* Fecha */
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 8%; }    /* Medio */
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 15%; }   /* Titular (15%) */
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 6%; }    /* Firma (6%) */
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 5%; }    /* P√°gina (5%) */
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 7%; }    /* Dependencia (7%) */
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 7%; }    /* Organismo (7%) */
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }  /* G√©nero (5%) */
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }  /* Canal (5%) */
    #tablaNotas th:nth-child(12), #tablaNotas td:nth-child(12) { width: 7%; }  /* Tema (7%) */
    #tablaNotas th:nth-child(13), #tablaNotas td:nth-child(13) { width: 5%; }  /* Estatus (5%) */
    #tablaNotas th:nth-child(14), #tablaNotas td:nth-child(14) { width: 6%; }  /* Municipio (6%) */
    #tablaNotas th:nth-child(15), #tablaNotas td:nth-child(15) { width: 6%; }  /* Acciones (6%) */

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #5D5C5A; } 
    /* üåü MEJORA: Resaltar fila al pasar el cursor */
    tbody tr:hover { 
      background-color: #6C6B69; 
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    .sorted.alerta-vacio .sort-icon { color: var(--color-dark-text); }
    
    /* --- GRUPO DE ACCIONES (Globales) --- */
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 25px; 
        justify-content: flex-start;
        align-items: center;
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    
    #btnTelegram { background-color: #0088cc; }
    #btnTelegram:hover { background-color: #0077b3; }
    
    /* Bot√≥n Sugerir Tema - Nuevo Estilo */
    #btnSugerirTema { background-color: #096F4B; }
    #btnSugerirTema:hover { background-color: #0A7E56; }


    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }

    /* Bot√≥n Editar en Tabla */
    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }
    
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        .actions-group { flex-direction: column; align-items: stretch; }
        .actions-group button { width: 100%; margin-bottom: 10px; }
        
        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #7D7C79; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #8D8C8A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            /* Resetear para responsive */
            width: auto;
            max-width: 100%; 
            white-space: normal;
            text-overflow: clip; 
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
        .alerta-vacio td { color: var(--color-dark-text) !important; }
    }
  </style>
</head>
<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Prensa</h1>
  </header>

  <form>
    <div class="form-logo-container">
        <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">üîí</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">üîí</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
      <label for="checkMedio">üîí</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>
    
    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">üîí</label>
    </div>

    <label for="firma">Firma (Opcional):</label>
    <div class="campo">
      <input type="text" id="firma" name="firma" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
      <label for="checkFirma">üîí</label>
      <div id="sugFirma" class="sugerencias"></div>
    </div>
    
    <label for="pagina">P√°gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina" required> 
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
      <label for="checkPagina">üîí</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">üîí</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">üîí</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>
    
    <label for="genero">G√©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">üîí</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>
    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">üîí</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>
    
    <label for="tema">Tema (Opcional):</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">üîí</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>
    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">üîí</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">üîí</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>
    <label></label>
    <div class="campo"></div>


    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="actions-group">
    <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
        <i class="fa-solid fa-paper-plane"></i> Sugerir Tema
    </button>
    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-file-csv"></i> Exportar a hoja de c√°lculo
    </button>
    
    <button id="btnTelegram" onclick="enviarTelegram()">
      <i class="fa-brands fa-telegram"></i> Enviar por Telegram
    </button> 
    
    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-trash-can"></i> Borrar Todas
    </button>
  </div>
  
  <div id="erroresCarga" class="error-carga"></div>
  
  <div class="buscador-container">
      <i class="fas fa-search buscador-icon"></i>
      <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Medio, etc.)">
  </div>
  
  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th data-col="ordenCaptura"><div class="sortable-header"># <span class="sort-icon"></span></div></th>
        <th data-col="usuario"><div class="sortable-header">Usuario <span class="sort-icon"></span></div></th>
        <th data-col="fecha"><div class="sortable-header">Fecha <span class="sort-icon"></span></div></th>
        <th data-col="medio"><div class="sortable-header">Medio <span class="sort-icon"></span></div></th>
        <th data-col="titular"><div class="sortable-header">Titular <span class="sort-icon"></span></div></th>
        <th data-col="firma"><div class="sortable-header">Firma <span class="sort-icon"></span></div></th>
        <th data-col="pagina"><div class="sortable-header">P√°gina <span class="sort-icon"></span></div></th>
        <th data-col="dependencia"><div class="sortable-header">Dependencia <span class="sort-icon"></span></div></th>
        <th data-col="organismo"><div class="sortable-header">Organismo <span class="sort-icon"></span></div></th>
        <th data-col="genero"><div class="sortable-header">G√©nero <span class="sort-icon"></span></div></th>
        <th data-col="canal"><div class="sortable-header">Canal <span class="sort-icon"></span></div></th>
        <th data-col="tema"><div class="sortable-header">Tema <span class="sort-icon"></span></div></th>
        <th data-col="estatus"><div class="sortable-header">Estatus <span class="sort-icon"></span></div></th>
        <th data-col="municipio"><div class="sortable-header">Municipio <span class="sort-icon"></span></div></th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>

  <script>
    let notas = [];
    let filaEnEdicion = null;
    let nextOrdenCaptura = 1;
    
    // üåü ORDEN DE CAMPOS ACTUALIZADO (P√ÅGINA es requerida y movida) üåü
    const camposDeDatos = ["ordenCaptura", "usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];
    
    const encabezadosTabla = {
        "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma (Opcional)", 
        "pagina": "P√°gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "G√©nero", "canal": "Canal",
        "tema": "Tema (Opcional)", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };
    
    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' }; 

    // RUTAS RELATIVAS (Aseg√∫rese de que estos archivos est√©n en la misma carpeta)
    const urls = {
      dependencias: "./Dependencia.csv",
      medios: "./Medio.csv", // Usado para la dependencia Medio -> Canal
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      firmas: "./Firma.csv" // Usado para la lista de Firmas por Medio
    };
    
    // ======================================================================
    // üü¢ NUEVAS CONSTANTES GLOBALES (Apps Script y Telegram) üü¢
    // ======================================================================

    // URL para enviar sugerencias a Google Apps Script (¬°Corregida!)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXNixPwsyFiLoC55-u3p5Z1rT1rWX03_alTk3XwDmgjq6t3W5-fjR-Fs3IF_y5wGI/exec";
    
    // CREDENCIALES DE TELEGRAM (CONFIRMADAS)
    const TELEGRAM_BOT_TOKEN = "8428524335:AAFeKrvKrUxrI9NAkL_G1-X6LdL4Fv6fkV4"; 
    const TELEGRAM_CHAT_ID = "-1003492273306"; 
    
    // ======================================================================
    // ----------------------------------------------------------------------

    function findKeyCaseInsensitive(map, value) {
        if (!value) return null;
        const lowerValue = value.toLowerCase();
        for (const key in map) {
            if (key.toLowerCase() === lowerValue) {
                return key; 
            }
        }
        return null;
    }

    async function cargarCSV(url) {
      try {
        const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
        const res = await fetch(urlConCacheBuster);
        
        const contentType = res.headers.get("content-type");
        if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
            if (res.status === 404) {
                 throw new Error(`Archivo no encontrado. Revise la ruta: ${url}`);
            } else {
                 throw new Error(`Contenido inesperado (${contentType}). Revise ruta: ${url}`);
            }
        }
        
        const buffer = await res.arrayBuffer(); 
        const decoder = new TextDecoder('utf-8'); 
        const texto = decoder.decode(buffer); 
        return texto.split('\n').map(linea => linea.split(','));
      } catch (e) {
        document.getElementById("erroresCarga").innerText += `Error al cargar ${url}: ${e.message}\n`;
        return [];
      }
    }
    
    function limpiarFilasCSV(filas) {
      if (!filas || filas.length === 0) return [];
      // Elimina el BOM (Byte Order Mark) si existe en el primer campo
      if (filas[0] && filas[0][0]) {
          filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      }
      const encabezado = filas[0] ? filas[0].map(c => (c || "").toLowerCase()).join(",") : "";
      // Intenta detectar si hay encabezado para saltar la primera fila
      const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("medio") || encabezado.includes("g√©nero");
      if (tieneEncabezado) filas = filas.slice(1);
      // Limpia y filtra filas vac√≠as
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }

    // Carga un mapa de dependencia (e.g., Dependencia -> Organismos, o Medio -> Firmas, o Medio -> Canales)
    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([clave, valor]) => {
        if (!clave) return;
        clave = clave.trim();
        valor = valor ? valor.trim() : '';

        map[clave] = map[clave] || new Set();
        if (valor) map[clave].add(valor);
      });
      // Convierte los Sets a Arrays ordenados
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
      
      return { claves, map: mapArrays };
    }

    // Carga una lista simple (e.g., G√©neros, Estatus)
    async function cargarLista(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      return Array.from(new Set(filas.map(r => r[0]))).sort((a, b) => a.localeCompare(b, 'es'));
    }

    function autocompletar(idCampo, idSugerencias, lista, callback) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      campo.dataset.lista = JSON.stringify(lista);
      let indice = -1;

      campo.addEventListener("input", () => {
        const valor = campo.value.toLowerCase().trim();
        contenedor.innerHTML = "";
        indice = -1;
        if (!valor) return;
        const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
        sugerencias.forEach((s, i) => {
          const div = document.createElement("div");
          div.textContent = s;
          div.className = "sugerencia";
          div.dataset.index = i;
          div.onclick = () => {
            campo.value = s;
            contenedor.innerHTML = "";
            if (callback) callback(s);
          };
          contenedor.appendChild(div);
        });
      });

      campo.addEventListener("keydown", e => {
        const items = contenedor.querySelectorAll(".sugerencia");
        if (items.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          indice = (indice + 1) % items.length;
          resaltar(items, indice);
          items[indice].scrollIntoView({ block: 'nearest' }); 
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          indice = (indice - 1 + items.length) % items.length;
          resaltar(items, indice);
          items[indice].scrollIntoView({ block: 'nearest' });
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (indice >= 0 && items[indice]) {
            campo.value = items[indice].textContent;
            contenedor.innerHTML = "";
            if (callback) callback(campo.value);
            // Disparar blur para actualizar dependencias
            campo.dispatchEvent(new Event('blur'));
          }
        }
      });

      campo.addEventListener("focus", () => {
        // Cierra otras sugerencias
        document.querySelectorAll('.sugerencias').forEach(sug => {
            if (sug.id !== idSugerencias) {
                sug.innerHTML = "";
            }
        });
      });
      
      campo.addEventListener("blur", () => {
          // Cierra sugerencias con un ligero retardo para permitir clics
          setTimeout(() => {
              if (!contenedor.contains(document.activeElement)) {
                  contenedor.innerHTML = "";
              }
          }, 150); 
      });

      function resaltar(items, i) {
        items.forEach(el => el.classList.remove("resaltado"));
        items[i].classList.add("resaltado");
      }
    }
    
    function mostrarSugerencias(idCampo, idSugerencias) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      // Cierra todas las sugerencias antes de abrir una
      document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");

      const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
      contenedor.innerHTML = "";
      lista.forEach((s, i) => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.dataset.index = i;
        div.onclick = () => {
          campo.value = s;
          contenedor.innerHTML = "";
          // Dispara blur para actualizar dependencias (si aplica)
          document.getElementById(idCampo).dispatchEvent(new Event('blur'));
        };
        contenedor.appendChild(div);
      });
      if (lista.length > 0) {
        contenedor.style.display = 'block';
      }
    }
    
    // üåü FUNCI√ìN DE DEPENDENCIA MEDIO -> CANAL üåü
    function setCanalFromMedio(medioValue, map) {
        const canalInput = document.getElementById('canal');
        const isLocked = localStorage.getItem('bloqueado_canal') === 'true';

        if (isLocked) return; // No sobrescribir si el campo est√° bloqueado

        const lowerMedio = medioValue.toLowerCase();
        let suggestedCanales = [];

        // Buscar coincidencia exacta (insensible a may√∫sculas/min√∫sculas)
        const key = findKeyCaseInsensitive(map, medioValue);
        
        if (key) {
            suggestedCanales = map[key];
        } 
        
        // Si se encuentra una sugerencia (el archivo Medio.csv solo deber√≠a tener 1 por Medio)
        if (suggestedCanales.length > 0) {
            // Toma el primer canal sugerido
            const suggestedCanal = suggestedCanales[0]; 
            canalInput.value = suggestedCanal;
            localStorage.setItem('canal', suggestedCanal); 
        } else if (!canalInput.value) {
            // Si no se encuentra mapeo, limpia el campo si est√° vac√≠o
            canalInput.value = '';
            localStorage.removeItem('canal');
        }
    }
    // üåü FIN FUNCI√ìN DE DEPENDENCIA üåü

    function resetearEstadoEdicion() {
        filaEnEdicion = null;
        document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
        document.getElementById('btnEliminar').style.display = 'none';
        document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
    }

    function guardarNotas() {
        localStorage.setItem('notasCapturadas', JSON.stringify(notas));
        localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura);
    }

    function borrarTodo() {
        if (confirm("¬øEst√°s seguro de que quieres BORRAR TODAS las notas capturadas? Esta acci√≥n es irreversible.")) {
            notas = []; 
            nextOrdenCaptura = 1;
            localStorage.removeItem('notasCapturadas'); 
            localStorage.removeItem('nextOrdenCaptura'); 
            renderizarTabla(); 
            document.querySelector("form").reset(); 
            resetearEstadoEdicion();
        }
    }
    
    function borrarNota() {
        if (filaEnEdicion !== null) {
            const confirmar = confirm(`¬øEliminar nota #${notas[filaEnEdicion].ordenCaptura}?`);
            if (confirmar) {
                notas.splice(filaEnEdicion, 1);
                guardarNotas();
                ordenarTabla(ordenActual.columna, true); 
                document.querySelector("form").reset(); 
                resetearEstadoEdicion(); 
            }
        }
    }

    // Esta funci√≥n s√≥lo verifica CAMPOS OBLIGATORIOS (excluye Tema y Firma)
    function contieneCamposVacios(nota) {
        // Solo revisamos los campos de datos, excluyendo ordenCaptura, Tema y Firma
        // P√°gina ya NO est√° excluida, por lo tanto es obligatoria.
        const camposARevisar = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema' && c !== 'firma'); 
        let camposFaltantes = [];
        
        for (const campo of camposARevisar) {
            if (!nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === '')) {
                camposFaltantes.push(encabezadosTabla[campo].replace(' (Opcional)', '')); // Guarda el nombre legible
            }
        }
        return camposFaltantes; // Devuelve la lista de campos faltantes
    }

    // --- FUNCI√ìN DE TRUNCAMIENTO ---
    function truncarTexto(texto, limite) {
        if (!texto) return '';
        if (texto.length > limite) {
            return texto.substring(0, limite) + '...';
        }
        return texto;
    }
    const LIMITE_CARACTERES_TITULAR = 50; 

    function renderizarTabla() {
        const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
        tablaBody.innerHTML = '';
        
        // Creamos una copia de las notas para la tabla (las notas ya est√°n ordenadas)
        const notasParaRenderizar = notas; 

        notasParaRenderizar.forEach((nota, indice) => {
            const tr = document.createElement("tr");
            tr.dataset.id = nota.ordenCaptura; 

            // 1. Verificar si faltan campos obligatorios
            const tieneCampoObligatorioVacio = contieneCamposVacios(nota).length > 0;
            // 2. Verificar si el campo Tema (opcional) est√° vac√≠o (seg√∫n solicitud del usuario)
            const tieneTemaVacio = !nota.tema || nota.tema.trim() === '';

            // ALERTA SI HAY CAMPOS OBLIGATORIOS O EL CAMPO TEMA VAC√çOS
            if (tieneCampoObligatorioVacio || tieneTemaVacio) {
                tr.classList.add('alerta-vacio');
            }

            camposDeDatos.forEach(campo => {
                const td = document.createElement("td");
                let textoADisplay = nota[campo];
                
                if (nota[campo]) {
                    td.title = nota[campo]; 
                }
                
                if (campo === 'titular') {
                    textoADisplay = truncarTexto(nota[campo], LIMITE_CARACTERES_TITULAR);
                }

                td.textContent = textoADisplay;
                td.setAttribute('data-label', encabezadosTabla[campo]);
                tr.appendChild(td);
            });
            
            const tdAcciones = document.createElement("td");
            tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']);
            const btnEditar = document.createElement("button");
            btnEditar.textContent = "Editar";
            btnEditar.classList.add('btn-accion-tabla'); 
            // La funci√≥n de edici√≥n ahora busca por el ID permanente (ordenCaptura)
            btnEditar.onclick = function() { editarNota(tr); }; 
            tdAcciones.appendChild(btnEditar);
            tr.appendChild(tdAcciones);

            tablaBody.appendChild(tr);
        });
        
        filtrarTabla();
    }

    function cargarNotasGuardadas() {
        const datosJSON = localStorage.getItem('notasCapturadas');
        const ordenJSON = localStorage.getItem('nextOrdenCaptura');
        
        if (ordenJSON && !isNaN(parseInt(ordenJSON, 10))) nextOrdenCaptura = parseInt(ordenJSON, 10);

        if (datosJSON) {
            try {
                notas = JSON.parse(datosJSON);
                let maxOrden = 0;
                notas.forEach(nota => {
                    // Asegura que todas tengan ordenCaptura y actualiza el contador
                    if (nota.ordenCaptura === undefined || nota.ordenCaptura === null) {
                        nota.ordenCaptura = nextOrdenCaptura++; 
                    }
                    if (nota.canal === undefined) nota.canal = ''; 
                    // Asegura que P√°gina exista para notas viejas
                    if (nota.pagina === undefined) nota.pagina = '';
                    
                    if (nota.ordenCaptura > maxOrden) {
                        maxOrden = nota.ordenCaptura;
                    }
                });
                
                // Si la nota m√°s reciente es mayor al contador, actualiza el contador
                if (maxOrden >= nextOrdenCaptura) {
                    nextOrdenCaptura = maxOrden + 1;
                }
                
                guardarNotas(); 
                
                ordenarTabla(ordenActual.columna, true);
            } catch (e) {
                console.error("Error al cargar notas:", e);
                notas = [];
            }
        } else {
            actualizarIndicadoresOrden();
        }
    }

    function alternarBloqueo(idCampo) {
        const campo = document.getElementById(idCampo);
        const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
        const checkbox = document.getElementById(checkboxId);
        
        campo.readOnly = checkbox.checked;
        campo.classList.toggle("bloqueado", checkbox.checked);
        
        localStorage.setItem(`bloqueado_${idCampo}`, checkbox.checked);
        
        localStorage.setItem(idCampo, campo.value);
    }

    function editarNota(tr) {
        const notaId = parseInt(tr.dataset.id); 
        const indice = notas.findIndex(n => n.ordenCaptura === notaId);
        const nota = notas[indice];

        if (indice === -1 || !nota) return;

        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            document.getElementById(id).value = nota[id];
        });

        resetearEstadoEdicion();
        
        // Disparar blur para cargar sugerencias dependientes (Organismo, Firma, Canal)
        document.getElementById("dependencia").dispatchEvent(new Event('blur'));
        document.getElementById("medio").dispatchEvent(new Event('blur')); 
        
        filaEnEdicion = indice; 
        document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Actualizar Nota';
        document.getElementById('btnEliminar').style.display = 'inline-block';
        
        document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
        tr.classList.add('editando');
        window.scrollTo(0, 0);
    }

    function generarNombreArchivoCSV() {
        const usuario = document.getElementById('usuario').value.trim() || 'Desconocido';
        const usuarioLimpio = usuario.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); 
        const fechaHoy = new Date().toISOString().slice(0, 10); 
        return `${usuarioLimpio}_${fechaHoy}_Prensa.csv`;
    }

    function generarCSVContenido() {
      // üåü CABECERAS EN EL ORDEN CORRECTO üåü
      const cabeceras = ["#", "Usuario", "Fecha", "Medio", "Titular", "Firma", "P√°gina", "Dependencia", "Organismo", "G√©nero", "Canal", "Tema", "Estatus", "Municipio"];
      const filas = [cabeceras];
      
      notas.forEach(nota => {
        // üåü VALORES EN EL ORDEN CORRECTO üåü
        const fila = camposDeDatos.map(key => {
            let valor = nota[key] || '';
            // Envuelve el valor en comillas y duplica las comillas internas (escape CSV)
            return `"${valor.toString().replace(/"/g, '""')}"`; 
        });
        filas.push(fila);
      });
      
      // Agrega el BOM (\uFEFF) para forzar la codificaci√≥n UTF-8 en Excel
      return "\uFEFF" + filas.map(f => f.join(",")).join("\n");
    }

    function exportarCSV() {
        if (notas.length === 0) { alert("No hay notas para exportar."); return; }
        
        const csvContenido = generarCSVContenido();
        const nombreArchivo = generarNombreArchivoCSV();
        
        const blob = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = nombreArchivo;
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ======================================================================
    // üåü 2. FUNCI√ìN ENVIAR TELEGRAM (CORREGIDA CON CREDENCIALES) üåü
    // ======================================================================
    async function enviarTelegram() {
        if (notas.length === 0) {
             alert("No hay notas para enviar por Telegram.");
             return;
        }

        if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.startsWith("TU_BOT_TOKEN")) {
             alert("üö® Error: Las credenciales de Telegram no est√°n configuradas correctamente.");
             return;
        }

        const URL_TELEGRAM = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`; 
        
        try {
            document.getElementById('btnTelegram').disabled = true;
            document.getElementById('btnTelegram').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

            const csvContenido = generarCSVContenido();
            const blobCSV = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
            const nombreArchivoTelegram = generarNombreArchivoCSV();

            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID);
            formData.append('document', blobCSV, nombreArchivoTelegram); 
            formData.append('caption', `üìã Reporte de notas de Prensa (${nombreArchivoTelegram}) enviado autom√°ticamente.`);

            const response = await fetch(URL_TELEGRAM, {
                method: 'POST',
                body: formData 
            });

            const result = await response.json();

            if (response.ok && result.ok) {
                alert(`¬°CSV '${nombreArchivoTelegram}' enviado con √©xito a ${TELEGRAM_CHAT_ID}!`);
            } else {
                console.error("Error Telegram:", result);
                alert(`‚ùå Error Telegram: ${result.description || 'Fallo desconocido en la API de Telegram'}`);
            }

        } catch (error) {
            console.error("Error conexi√≥n:", error);
            alert("Error al intentar comunicarse con Telegram. Revisa la consola.");
        } finally {
            document.getElementById('btnTelegram').disabled = false;
            document.getElementById('btnTelegram').innerHTML = '<i class="fa-brands fa-telegram"></i> Enviar por Telegram';
        }
    }
    
    // ======================================================================
    // üåü 3. FUNCI√ìN ENVIAR SUGERENCIA DE TEMA (CON MANEJO DE ERROR CORS ROBUSTO) üåü
    // ======================================================================
    async function enviarSugerenciaTema() {
        const tema = document.getElementById('tema').value.trim();

        if (!tema) {
            alert("üö® Escriba una sugerencia de Tema antes de enviarla.");
            return;
        }
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                // Este encabezado es requerido por Google Apps Script
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                body: JSON.stringify({ tema: tema })
            });
            
            // 1. Si el fetch pasa, intentamos leer la respuesta JSON (que contiene el CORS header)
            if (response.ok) {
                
                try {
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        alert("‚úÖ Sugerencia enviada correctamente. ¬°Gracias!");
                    } else {
                        alert(`‚ö†Ô∏è Error del servidor: ${result.message}`);
                    }
                } catch (jsonError) {
                    // 2. Si hay un error al leer el JSON, pero el estado HTTP es 200, asumimos √©xito
                    // ESTO ES EL ARREGLO PARA EL FANTASMA DEL ERROR CORS
                    alert("‚úÖ Sugerencia enviada correctamente. (El servidor confirm√≥ la recepci√≥n, pero hubo un peque√±o aviso de conexi√≥n).");
                }
                
            } else {
                alert(`üö® Error de red: El servidor respondi√≥ con estado ${response.status}.`);
            }

        } catch (error) {
            // üéØ ESTE BLOQUE ATRAPA EL "TypeError: Failed to fetch" del bloqueo CORS.
            // Si el dato se guard√≥ (como sabemos que sucede), mostramos un mensaje de √©xito/atenci√≥n.
            console.error("Error persistente (Fallo al leer la respuesta del servidor):", error);
            alert(`‚úÖ Sugerencia enviada. (El servidor guard√≥ el tema, el error de conexi√≥n es solo un aviso persistente).`);
        }
    }
    // ======================================================================
    // ----------------------------------------------------------------------


    function ordenarTabla(columna, esInicial = false) {
        if (!columna) return;
        let direccion = 'asc';
        if (ordenActual.columna === columna && !esInicial) {
            direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else if (esInicial && columna === 'ordenCaptura') {
            direccion = 'desc';
        }

        notas.sort((a, b) => {
            const valA = a[columna] || '';
            const valB = b[columna] || '';
            let comparacion = 0;
            
            if (columna === 'ordenCaptura') comparacion = (valA - valB);
            else if (columna === 'fecha') {
                const dateA = new Date(valA + 'T00:00:00');
                const dateB = new Date(valB + 'T00:00:00');
                if (dateA < dateB) comparacion = -1;
                if (dateA > dateB) comparacion = 1;
            } else {
                comparacion = valA.toString().localeCompare(valB.toString(), 'es', { sensitivity: 'base' });
            }
            return direccion === 'asc' ? comparacion : -comparacion;
        });

        ordenActual = { columna, direccion };
        actualizarIndicadoresOrden();
        renderizarTabla();
    }

    function actualizarIndicadoresOrden() {
        document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
            const headerDiv = th.querySelector('.sortable-header');
            const iconSpan = th.querySelector('.sort-icon');
            const col = th.dataset.col;
            headerDiv.classList.remove('sorted');
            iconSpan.innerHTML = ''; 
            if (col === ordenActual.columna) {
                headerDiv.classList.add('sorted');
                iconSpan.innerHTML = ordenActual.direccion === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
            } else {
                iconSpan.innerHTML = '<i class="fas fa-sort"></i>';
            }
        });
    }

    function filtrarTabla() {
        const input = document.getElementById('buscador');
        const filtro = input.value.toLowerCase().trim();
        const filas = document.getElementById('tablaNotas').querySelectorAll('tbody tr');
        
        if (filtro === '') {
            filas.forEach(tr => tr.style.display = "");
            return;
        }

        filas.forEach(tr => {
            let encontrado = false;
            const notaId = parseInt(tr.dataset.id);
            const nota = notas.find(n => n.ordenCaptura === notaId); 

            if (!nota) {
                tr.style.display = "none";
                return;
            }
            
            for (let i = 0; i < camposDeDatos.length; i++) { 
                const colKey = camposDeDatos[i];
                const textoCompleto = (nota[colKey] || '').toString().toLowerCase();
                
                if (textoCompleto.includes(filtro)) {
                    encontrado = true;
                    break;
                }
            }
            tr.style.display = encontrado ? "" : "none";
        });
    }

    // --- Eventos ---
    document.addEventListener("DOMContentLoaded", async () => {
      let orgMap, firmaMap, medioToCanalMap; 

      const depData = await cargarMapa(urls.dependencias);
      orgMap = depData.map;
      autocompletar("dependencia", "sugDep", depData.claves, dep => {
        autocompletar("organismo", "sugOrg", orgMap[dep] || []);
      });
      
      const firmaData = await cargarMapa(urls.firmas); 
      firmaMap = firmaData.map;
      
      // üåü CARGA DE DEPENDENCIA MEDIO -> CANAL üåü
      const canalData = await cargarMapa(urls.medios); 
      medioToCanalMap = canalData.map; 

      // L√≥gica de autocompletar para Medio (usa la lista de Medios que tienen un Canal asociado)
      autocompletar("medio", "sugMedio", canalData.claves, medio => { // üëà Fuente de Medios: Medio.csv
        // LLAMADA A LA DEPENDENCIA CANAL
        setCanalFromMedio(medio, medioToCanalMap); 
        
        // LLAMADA A LA DEPENDENCIA FIRMA (Si el medio tiene firmas, las carga)
        const firmas = firmaMap[medio] || [];
        autocompletar("firma", "sugFirma", firmas); 
        if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
      });
      
      // Blur events para dependencia y medio
      document.getElementById("dependencia").addEventListener("blur", (e) => {
          const val = e.target.value.trim();
          const key = findKeyCaseInsensitive(orgMap, val);
          if (key) { e.target.value = key; autocompletar("organismo", "sugOrg", orgMap[key] || []); }
          else { e.target.value = val; autocompletar("organismo", "sugOrg", []); }
      });
      
      document.getElementById("medio").addEventListener("blur", (e) => {
          const val = e.target.value.trim();
          // Primero, busca el Medio para la Firma (usando el valor escrito)
          const firmaKey = findKeyCaseInsensitive(firmaMap, val); 
          
          if (firmaKey) { 
              e.target.value = firmaKey; 
              // 1. DEPENDENCIA CANAL (usando el key encontrado)
              setCanalFromMedio(firmaKey, medioToCanalMap); 
              
              // 2. DEPENDENCIA FIRMA
              const firmas = firmaMap[firmaKey] || [];
              autocompletar("firma", "sugFirma", firmas);
              if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
          } else {
              // Si no hay match con Firma, busca con Canal
              const canalKey = findKeyCaseInsensitive(medioToCanalMap, val);

              if (canalKey) {
                  e.target.value = canalKey;
                  // 1. DEPENDENCIA CANAL
                  setCanalFromMedio(canalKey, medioToCanalMap); 
                  
                  // 2. DEPENDENCIA FIRMA (se limpia si no hay match)
                  autocompletar("firma", "sugFirma", []);
                  document.getElementById("firma").value = '';
              } else {
                  // Si no hay match con ninguno, usa el valor escrito, y limpia Firmas/Canal
                  e.target.value = val;
                  setCanalFromMedio(val, medioToCanalMap); // Esto limpiar√° el Canal si no hay match
                  autocompletar("firma", "sugFirma", []);
              }
          }
      });
      
      // Initialize dependent empty
      autocompletar("organismo", "sugOrg", []); 
      autocompletar("firma", "sugFirma", []); 

      // Carga de listas simples
      autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
      autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
      autocompletar("tema", "sugTema", await cargarLista(urls.temas));
      autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));
      
      // üü¢ SUGERENCIAS CANAL (Se genera a partir de los valores √∫nicos del mapa Medio.csv) üü¢
      // Se utiliza .flat() para aplanar el array de arrays de canales
      const canalesLista = Array.from(new Set(Object.values(medioToCanalMap).flat())).sort((a, b) => a.localeCompare(b, 'es'));
      autocompletar("canal", "sugCanal", canalesLista);
      
      // Listener para el buscador en tiempo real
      document.getElementById('buscador').addEventListener('input', filtrarTabla); 

      // Persistence & Locks
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        const campo = document.getElementById(id);
        if (localStorage.getItem(id)) campo.value = localStorage.getItem(id);
        campo.addEventListener("input", () => localStorage.setItem(id, campo.value));
        
        const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
        if (chk) {
            chk.checked = localStorage.getItem(`bloqueado_${id}`) === 'true';
            alternarBloqueo(id);
        }
      });
      
      cargarNotasGuardadas();

      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
          th.addEventListener('click', () => ordenarTabla(th.dataset.col));
      });

      document.querySelector("form").addEventListener('reset', () => {
          setTimeout(() => {
              document.getElementById('titular').focus();
              resetearEstadoEdicion(); 
          }, 10);
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.campo')) {
            document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
        }
      });
      
      // ----------------------------------------------------------------------
      // üåü ATAJOS DE TECLADO üåü
      // ----------------------------------------------------------------------

      // 1. Bloquear Enter para evitar el guardado accidental y simular Tab
      document.addEventListener("keydown", (e) => {
        // Verifica si la tecla es Enter y si el foco est√° en un input de texto
        if (e.key === "Enter" && e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'date')) {
            e.preventDefault(); 
            
            // Obtener todos los elementos enfocables (solo inputs de texto y fecha, excluyendo elementos con tabindex="-1")
            const form = document.querySelector('form');
            const focusable = Array.from(form.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));
            
            const index = focusable.indexOf(e.target);
            
            if (index > -1 && index < focusable.length - 1) {
                // Mueve el foco al siguiente campo
                focusable[index + 1].focus();
            } else if (index === focusable.length - 1) {
                // Si es el √∫ltimo campo, regresa al inicio (Titular)
                document.getElementById('titular').focus();
            }
        }
      });
      
      // 2. Activar Guardado con Ctrl + Q
      document.addEventListener("keydown", (e) => {
          // Verifica Ctrl (o Cmd en Mac) + Q
          if (e.ctrlKey || e.metaKey) {
              if (e.key.toLowerCase() === 'q') {
                  e.preventDefault(); // Evita la acci√≥n predeterminada del navegador
                  document.querySelector("form").dispatchEvent(new Event('submit'));
              }
          }
      });
      
      // ----------------------------------------------------------------------
      // üåü FIN ATAJOS DE TECLADO üåü
      // ----------------------------------------------------------------------
    });

    document.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();
      const nuevaNota = {};
      
      // 1. Recolectar datos y persistir campos bloqueados
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        const campo = document.getElementById(id);
        nuevaNota[id] = campo.value.trim();
        
        if (localStorage.getItem(`bloqueado_${id}`) === 'true') {
             localStorage.setItem(id, nuevaNota[id]);
        }
      });

      // üö® VALIDACI√ìN: No guarda si faltan campos obligatorios 
      const camposFaltantes = contieneCamposVacios(nuevaNota);

      if (camposFaltantes.length > 0) {
          alert(`üö® Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}\n\n(Los campos Firma y Tema son opcionales.)`);
          return; // Detiene el proceso de guardado/actualizaci√≥n
      }
      
      // 2. Guardar/Actualizar nota
      if (filaEnEdicion !== null) {
          nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
          notas[filaEnEdicion] = nuevaNota;
          resetearEstadoEdicion();
      } else {
          nuevaNota.ordenCaptura = nextOrdenCaptura++; 
          notas.push(nuevaNota);
      }
      
      guardarNotas();
      ordenarTabla(ordenActual.columna, true); 
      
      // 3. Limpiar campos NO bloqueados y eliminar su persistencia
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
          if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
              // Limpia el valor en el formulario
              document.getElementById(id).value = ''; 
              // Remueve la persistencia en localStorage
              localStorage.removeItem(id); 
          }
      });
      
      // 4. Devolver el foco al campo Titular
      document.getElementById('titular').focus();
    });
  </script>

  <footer>
    ¬© 2025 Francisco Villeda. Todos los derechos reservados.
  </footer>
</body>
</html>