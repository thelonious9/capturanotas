<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plataforma de Captura</title>
  <style>
    .sugerencias {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 10;
      width: 300px;
    }
    .sugerencia {
      padding: 5px;
      cursor: pointer;
    }
    .sugerencia:hover,
    .sugerencia.resaltado {
      background-color: #cce5ff;
    }
  </style>
</head>
<body>
<h1>Formulario de Captura</h1>

<form>
  <label for="fecha">Fecha:</label><br>
  <input type="date" id="fecha" name="fecha"><br><br>

  <label for="medio">Medio:</label><br>
  <input type="text" id="medio" name="medio" autocomplete="off"><br>
  <div id="sugMedio" class="sugerencias"></div><br>

  <label for="titular">Titular:</label><br>
  <input type="text" id="titular" name="titular"><br><br>

  <label for="firma">Firma:</label><br>
  <input type="text" id="firma" name="firma"><br><br>

  <label for="pagina">Página:</label><br>
  <input type="text" id="pagina" name="pagina"><br><br>

  <label for="dependencia">Dependencia:</label><br>
  <input type="text" id="dependencia" name="dependencia" autocomplete="off"><br>
  <div id="sugDep" class="sugerencias"></div><br>

  <label for="organismo">Organismo:</label><br>
  <input type="text" id="organismo" name="organismo" autocomplete="off"><br>
  <div id="sugOrg" class="sugerencias"></div><br>

  <label for="genero">Género:</label><br>
  <input type="text" id="genero" name="genero" autocomplete="off"><br>
  <div id="sugGenero" class="sugerencias"></div><br>

  <label for="canal">Canal:</label><br>
  <input type="text" id="canal" name="canal" autocomplete="off"><br>
  <div id="sugCanal" class="sugerencias"></div><br>

  <label for="tema">Tema:</label><br>
  <input type="text" id="tema" name="tema" autocomplete="off"><br>
  <div id="sugTema" class="sugerencias"></div><br>

  <label for="estatus">Estatus:</label><br>
  <input type="text" id="estatus" name="estatus" autocomplete="off"><br>
  <div id="sugEstatus" class="sugerencias"></div><br>

  <label for="municipio">Municipio:</label><br>
  <input type="text" id="municipio" name="municipio" autocomplete="off"><br>
  <div id="sugMunicipio" class="sugerencias"></div><br>

  <button type="submit">Guardar</button>
</form>

<h2>Notas capturadas</h2>
<table id="tablaNotas" border="1">
  <thead>
    <tr>
      <th>Fecha</th><th>Medio</th><th>Titular</th><th>Firma</th><th>Página</th>
      <th>Dependencia</th><th>Organismo</th><th>Género</th><th>Canal</th>
      <th>Tema</th><th>Estatus</th><th>Municipio</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<br>
<button onclick="exportarCSV()">Exportar a hoja de cálculo</button>

<script>
  const urls = {
    dependencias: "https://thelonious9.github.io/capturanotas/Dependencia.csv",
    medios: "https://thelonious9.github.io/capturanotas/Medio.csv",
    generos: "https://thelonious9.github.io/capturanotas/Genero.csv",
    estatus: "https://thelonious9.github.io/capturanotas/Estatus.csv",
    temas: "https://thelonious9.github.io/capturanotas/Tema.csv",
    municipios: "https://thelonious9.github.io/capturanotas/Municipio.csv"
  };

  async function cargarCSV(url) {
    const res = await fetch(url);
    const texto = await res.text();
    return texto.split('\n').map(linea => linea.split(','));
  }

  function limpiarFilasCSV(filas) {
    if (!filas || filas.length === 0) return [];
    filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
    const encabezado = filas[0].map(c => (c||"").toLowerCase()).join(",");
    const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("medio") || encabezado.includes("género");
    if (tieneEncabezado) filas = filas.slice(1);
    return filas.map(r => r.map(c => (c||"").replace(/<[^>]+>/g,"").trim())).filter(r => r[0]);
  }

  async function cargarMapa(url) {
    const filas = limpiarFilasCSV(await cargarCSV(url));
    const map = {};
    filas.forEach(([clave, valor]) => {
      if (!clave) return;
      map[clave] = map[clave] || new Set();
      if (valor) map[clave].add(valor);
    });
    const claves = Object.keys(map).sort((a,b) => a.localeCompare(b,'es'));
    const mapArrays = {};
    claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a,b) => a.localeCompare(b,'es')));
    return { claves, map: mapArrays };
  }

  async function cargarLista(url) {
    const filas = limpiarFilasCSV(await cargarCSV(url));
    return Array.from(new Set(filas.map(r => r[0]))).sort((a,b) => a.localeCompare(b,'es'));
  }

  function autocompletar(idCampo, idSugerencias, lista, callback) {
    const campo = document.getElementById(idCampo);
    const contenedor = document.getElementById(idSugerencias);
    let indice = -1;

    campo.addEventListener("input", () => {
      const valor = campo.value.toLowerCase().trim();
      contenedor.innerHTML = "";
      indice = -1;
      if (!valor) return;
      const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
      sugerencias.forEach((s, i) => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.dataset.index = i;
        div.onclick = () => {
          campo.value = s;
          contenedor.innerHTML = "";
          if (callback) callback(s);
        };
        contenedor.appendChild(div);
      });
    });

    campo.addEventListener("keydown", e => {
      const items = contenedor.querySelectorAll(".sugerencia");
      if (items.length === 0) return;

      if (e.key === "ArrowDown") {
        e.preventDefault();
        indice = (indice + 1) % items.length;
        resaltar(items, indice);
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        indice = (indice - 1 + items.length) % items.length;
        resaltar(items, indice);
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (indice >= 0 && items[indice]) {
          campo.value = items[indice].textContent;
          contenedor.innerHTML = "";
          if (callback) callback(campo.value);
        }
      }
    });

    function resaltar(items, i) {
      items.forEach(el => el.classList.remove("resaltado"));
      items[i].classList.add("resaltado");
    }
  }