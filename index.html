<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* === Tus estilos originales (sin cambios) === */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    :root {
      --color-fondo-pagina: #31302F;
      --color-fondo-form: #52504E;
      --color-primary: #6F0909;
      --color-primary-hover: #792929;
      --color-secondary: #792929;
      --color-secondary-hover: #6F0909;
      --color-danger: #dc3545;
      --color-danger-hover: #c82333;
      --color-telegram: #0088cc;
      --color-telegram-hover: #0077b3;
      --color-dark-text: #31302F;
      --color-light-text: #F0EAD1;
      --color-input-bg: #FFFFFF;
      --color-alerta-vacio: #FFD700;
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
        outline: none;
    }
    form > label:nth-child(2), 
    form > div:nth-child(3) {
        grid-column: 1 / span 4; 
    }
    form > label:nth-child(8), 
    form > div:nth-child(9) {
        grid-column: 1 / span 4; 
    }
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    button i { margin-right: 8px; font-size: 1.1em; }
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      table-layout: fixed; 
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
      max-width: none !important; 
    }
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 3%; }
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 7%; }
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 8%; }
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 15%; }
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 6%; }
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 5%; }
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 7%; }
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 7%; }
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }
    #tablaNotas th:nth-child(12), #tablaNotas td:nth-child(12) { width: 7%; }
    #tablaNotas th:nth-child(13), #tablaNotas td:nth-child(13) { width: 5%; }
    #tablaNotas th:nth-child(14), #tablaNotas td:nth-child(14) { width: 6%; }
    #tablaNotas th:nth-child(15), #tablaNotas td:nth-child(15) { width: 6%; }
    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #5D5C5A; } 
    tbody tr:hover { 
      background-color: #6C6B69; 
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    .sorted.alerta-vacio .sort-icon { color: var(--color-dark-text); }
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 25px; 
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap;
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    #btnGoogleSheets { background-color: #0A66C2; }
    #btnGoogleSheets:hover { background-color: #0959A8; }
    #btnTelegram { background-color: #0088cc; }
    #btnTelegram:hover { background-color: #0077b3; }
    #btnSugerirTema { background-color: #096F4B; }
    #btnSugerirTema:hover { background-color: #0A7E56; }
    #btnSugerirTema i { margin-right: 0; }
    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    .suggestion-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        background-color: #4A4A4A; 
        padding: 8px; 
        border-radius: var(--radius);
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #sugerenciaTemaInput {
        padding: 10px 15px;
        border: 1px solid var(--color-primary-hover);
        border-radius: var(--radius);
        background-color: var(--color-input-bg);
        color: var(--color-dark-text);
        flex-grow: 1; 
        width: 250px;
    }
    .suggestion-input-group #btnSugerirTema {
        margin-right: 0;
        padding: 10px 15px; 
    }
    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }
    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }
    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        .actions-group { flex-direction: column; align-items: stretch; }
        .actions-group button { width: 100%; margin-bottom: 10px; }
        .suggestion-input-group {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            padding: 15px 10px;
        }
        #sugerenciaTemaInput {
            max-width: none;
            width: 100%;
            margin-bottom: 5px;
        }
        .suggestion-input-group #btnSugerirTema {
             width: 100%;
        }
        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #7D7C79; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #8D8C8A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            width: auto;
            max-width: 100%; 
            white-space: normal;
            text-overflow: clip; 
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
        .alerta-vacio td { color: var(--color-dark-text) !important; }
    }
    /* === LOGIN STYLES === */
    #loginContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: var(--color-fondo-pagina);
      padding: 20px;
    }
    #loginForm {
      background-color: var(--color-fondo-form);
      padding: 30px;
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #loginForm h2 {
      color: var(--color-light-text);
      text-align: center;
      margin-bottom: 20px;
    }
    #loginForm input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
    }
    #btnLogin {
      width: 100%;
      padding: 10px;
      background-color: var(--color-primary);
      color: var(--color-light-text);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
    }
    #btnLogin:hover {
      background-color: var(--color-primary-hover);
    }
    #loginError {
      color: var(--color-danger);
      text-align: center;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- ‚úÖ LOGIN -->
  <div id="loginContainer">
    <div id="loginForm">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="text" id="loginUsuario" placeholder="Usuario">
      <input type="password" id="loginContrasena" placeholder="Contrase√±a">
      <button id="btnLogin">Iniciar Sesi√≥n</button>
      <p id="loginError"></p>
    </div>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL -->
  <div id="mainContent" style="display: none;">
    <header>
      <img src="./logo.png" alt="Logotipo institucional">
      <h1>Sistema de Captura de Notas de Prensa</h1>
    </header>
    <form>
      <div class="form-logo-container">
          <img src="./logo.png" alt="Logotipo del Formulario">
      </div>
      <label for="usuario">Usuario:</label>
      <div class="campo">
        <input type="text" id="usuario" name="usuario" required readonly>
        <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
        <label for="checkUsuario">üîí</label>
      </div>
      <label for="fecha">Fecha:</label>
      <div class="campo">
        <input type="date" id="fecha" name="fecha" required>
        <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
        <label for="checkFecha">üîí</label>
      </div>
      <label for="medio">Medio:</label>
      <div class="campo">
        <input type="text" id="medio" name="medio" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
        <label for="checkMedio">üîí</label>
        <div id="sugMedio" class="sugerencias"></div>
      </div>
      <label for="titular">Titular:</label>
      <div class="campo">
        <input type="text" id="titular" name="titular" required>
        <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
        <label for="checkTitular">üîí</label>
      </div>
      <label for="firma">Firma:</label>
      <div class="campo">
        <input type="text" id="firma" name="firma" autocomplete="off">
        <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
        <label for="checkFirma">üîí</label>
        <div id="sugFirma" class="sugerencias"></div>
      </div>
      <label for="pagina">P√°gina:</label>
      <div class="campo">
        <input type="text" id="pagina" name="pagina" required> 
        <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
        <label for="checkPagina">üîí</label>
      </div>
      <label for="dependencia">Dependencia:</label>
      <div class="campo">
        <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
        <label for="checkDependencia">üîí</label>
        <div id="sugDep" class="sugerencias"></div>
      </div>
      <label for="organismo">Organismo:</label>
      <div class="campo">
        <input type="text" id="organismo" name="organismo" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
        <label for="checkOrganismo">üîí</label>
        <div id="sugOrg" class="sugerencias"></div>
      </div>
      <label for="genero">G√©nero:</label>
      <div class="campo">
        <input type="text" id="genero" name="genero" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
        <label for="checkGenero">üîí</label>
        <div id="sugGenero" class="sugerencias"></div>
      </div>
      <label for="canal">Canal:</label>
      <div class="campo">
        <input type="text" id="canal" name="canal" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
        <label for="checkCanal">üîí</label>
        <div id="sugCanal" class="sugerencias"></div>
      </div>
      <label for="tema">Tema:</label>
      <div class="campo">
        <input type="text" id="tema" name="tema" autocomplete="off">
        <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
        <label for="checkTema">üîí</label>
        <div id="sugTema" class="sugerencias"></div>
      </div>
      <label for="estatus">Estatus:</label>
      <div class="campo">
        <input type="text" id="estatus" name="estatus" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
        <label for="checkEstatus">üîí</label>
        <div id="sugEstatus" class="sugerencias"></div>
      </div>
      <label for="municipio">Municipio:</label>
      <div class="campo">
        <input type="text" id="municipio" name="municipio" autocomplete="off" required>
        <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">üîΩ</button>
        <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
        <label for="checkMunicipio">üîí</label>
        <div id="sugMunicipio" class="sugerencias"></div>
      </div>
      <label></label>
      <div class="campo"></div>
      <div class="button-group-form">
        <button type="submit" id="btnGuardar">
          <i class="fa-solid fa-floppy-disk"></i> Guardar
        </button>
        <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
          <i class="fa-solid fa-trash-can"></i> Borrar Nota
        </button>
        <button type="reset" id="btnLimpiar">
          <i class="fa-solid fa-broom"></i> Limpiar
        </button>
      </div>
    </form>
    <div class="actions-group">
      <div class="suggestion-input-group">
          <input type="text" id="sugerenciaTemaInput" placeholder="Escribe aqu√≠ tu sugerencia de tema" required>
          <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
              Sugerir Tema <i class="fa-solid fa-paper-plane"></i>
          </button>
      </div>
      <button id="btnExportar" onclick="exportarCSV()">
        <i class="fa-solid fa-file-csv"></i> Exportar a hoja de c√°lculo
      </button>
      <button id="btnGoogleSheets" onclick="enviarTodas()">
        <i class="fa-solid fa-table"></i> Enviar a Sheets
      </button>
      <button id="btnTelegram" onclick="enviarTelegram()">
        <i class="fa-brands fa-telegram"></i> Enviar por Telegram
      </button> 
      <button id="btnBorrarTodo" onclick="borrarTodo()">
        <i class="fa-solid fa-trash-can"></i> Borrar Todas
      </button>
    </div>
    <div id="erroresCarga" class="error-carga"></div>
    <div class="buscador-container">
        <i class="fas fa-search buscador-icon"></i>
        <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Medio, etc.)">
    </div>
    <h2>Notas capturadas</h2>
    <table id="tablaNotas">
      <thead>
        <tr>
          <th data-col="ordenCaptura"><div class="sortable-header"># <span class="sort-icon"></span></div></th>
          <th data-col="usuario"><div class="sortable-header">Usuario <span class="sort-icon"></span></div></th>
          <th data-col="fecha"><div class="sortable-header">Fecha <span class="sort-icon"></span></div></th>
          <th data-col="medio"><div class="sortable-header">Medio <span class="sort-icon"></span></div></th>
          <th data-col="titular"><div class="sortable-header">Titular <span class="sort-icon"></span></div></th>
          <th data-col="firma"><div class="sortable-header">Firma <span class="sort-icon"></span></div></th>
          <th data-col="pagina"><div class="sortable-header">P√°gina <span class="sort-icon"></span></div></th>
          <th data-col="dependencia"><div class="sortable-header">Dependencia <span class="sort-icon"></span></div></th>
          <th data-col="organismo"><div class="sortable-header">Organismo <span class="sort-icon"></span></div></th>
          <th data-col="genero"><div class="sortable-header">G√©nero <span class="sort-icon"></span></div></th>
          <th data-col="canal"><div class="sortable-header">Canal <span class="sort-icon"></span></div></th>
          <th data-col="tema"><div class="sortable-header">Tema <span class="sort-icon"></span></div></th>
          <th data-col="estatus"><div class="sortable-header">Estatus <span class="sort-icon"></span></div></th>
          <th data-col="municipio"><div class="sortable-header">Municipio <span class="sort-icon"></span></div></th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <br>
  </div>

  <footer>
    ¬© 2025 Francisco Villeda. Todos los derechos reservados.
  </footer>

  <script>
    // === CONFIG ===
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw9a6kEd2lTlbtU6OcwtmNx4983L-qNvuoh_fHzGDiKisiy7DjN-AwTORvnDQkfRvM/exec";
    let sesionActiva = null; // { usuario, contrasena }
    let notas = [];
    let filaEnEdicion = null;
    let nextOrdenCaptura = 1;
    const camposDeDatos = ["ordenCaptura", "usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];
    const CAMPOS_CON_BLOQUEO = ["usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];
    const encabezadosTabla = {
        "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma", 
        "pagina": "P√°gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "G√©nero", "canal": "Canal",
        "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };
    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };
    const urls = {
      dependencias: "./Dependencia.csv",
      medios: "./Medio.csv",
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      firmas: "./Firma.csv"
    };

    // === LOGIN ===
    async function iniciarSesion(usuario, contrasena) {
      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: "login", usuario, contrasena })
        });
        const data = await res.json();
        if (data.status === "success") {
          sesionActiva = { usuario, contrasena };
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
          document.getElementById("usuario").value = usuario;
          await cargarNotasDeSheets(usuario);
        } else {
          document.getElementById("loginError").innerText = data.message;
          document.getElementById("loginError").style.display = "block";
        }
      } catch (e) {
        alert("Error de conexi√≥n con el servidor.");
        console.error(e);
      }
    }

    // === CARGAR NOTAS DE SHEETS ===
    async function cargarNotasDeSheets(usuario) {
      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: "listarNotasPorUsuario", usuario })
        });
        const result = await res.json();
        if (result.status === "success") {
          notas = (result.data || []).map(row => ({
            ordenCaptura: row.ordenCaptura || nextOrdenCaptura++,
            usuario: row.Usuario || usuario,
            fecha: row.Fecha || "",
            medio: row.Medio || "",
            titular: row.Titular || "",
            firma: row.Firma || "",
            pagina: row.P√°gina || "",
            dependencia: row.Dependencia || "",
            organismo: row.Organismo || "",
            genero: row.G√©nero || "",
            canal: row.Canal || "",
            tema: row.Tema || "",
            estatus: row.Estatus || "",
            municipio: row.Municipio || ""
          }));
          if (notas.length > 0) {
            nextOrdenCaptura = Math.max(...notas.map(n => n.ordenCaptura)) + 1;
          }
          renderizarTabla();
        }
        // Guardar en localStorage como respaldo
        guardarNotas();
      } catch (e) {
        console.error("Error al cargar notas de Sheets:", e);
        cargarNotasGuardadas(); // fallback a localStorage
      }
    }

    // === GUARDAR NOTA EN SHEETS (individual) ===
    async function guardarNotaEnSheets(nota) {
      if (!sesionActiva) return;
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: "guardarNota",
            usuario: sesionActiva.usuario,
            contrasena: sesionActiva.contrasena,
            nota
          })
        });
      } catch (e) {
        console.error("Error al guardar en Sheets:", e);
      }
    }

    // === BTN: Enviar todas las notas ===
    async function enviarTodas() {
      if (!sesionActiva) { alert("Inicia sesi√≥n."); return; }
      if (notas.length === 0) { alert("No hay notas."); return; }
      try {
        document.getElementById('btnGoogleSheets').disabled = true;
        document.getElementById('btnGoogleSheets').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
        for (const nota of notas) {
          await guardarNotaEnSheets(nota);
        }
        alert("‚úÖ Todas las notas se enviaron a Sheets.");
      } catch (e) {
        alert("‚ö†Ô∏è Error de conexi√≥n.");
      } finally {
        document.getElementById('btnGoogleSheets').disabled = false;
        document.getElementById('btnGoogleSheets').innerHTML = '<i class="fa-solid fa-table"></i> Enviar a Sheets';
      }
    }

    // === FUNCIONES AUXILIARES (copiadas de tu index.txt) ===
    function resetearEstadoEdicion() {
      filaEnEdicion = null;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
      document.getElementById('btnEliminar').style.display = 'none';
      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
    }
    function borrarTodo() {
      if (confirm("¬øBorrar todas las notas?")) {
        notas = [];
        nextOrdenCaptura = 1;
        localStorage.removeItem('notasCapturadas');
        renderizarTabla();
        desbloquearTodosLosCampos();
        document.querySelector("form").reset();
        resetearEstadoEdicion();
        document.getElementById("usuario").value = sesionActiva?.usuario || "";
      }
    }
    function borrarNota() {
      if (filaEnEdicion !== null && confirm(`¬øEliminar nota #${notas[filaEnEdicion].ordenCaptura}?`)) {
        notas.splice(filaEnEdicion, 1);
        guardarNotas();
        renderizarTabla();
        desbloquearTodosLosCampos();
        document.querySelector("form").reset();
        resetearEstadoEdicion();
      }
    }
    function contieneCamposVacios(nota) {
      const campos = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema' && c !== 'firma');
      return campos.filter(c => !nota[c] || nota[c].trim() === '');
    }
    function truncarTexto(texto, limite) {
      if (!texto) return '';
      return texto.length > limite ? texto.substring(0, limite) + '...' : texto;
    }
    const LIMITE_CARACTERES_TITULAR = 50;
    function renderizarTabla() {
      const tbody = document.querySelector("#tablaNotas tbody");
      tbody.innerHTML = "";
      notas.forEach((nota, i) => {
        const tr = document.createElement("tr");
        tr.dataset.id = nota.ordenCaptura;
        if (contieneCamposVacios(nota).length > 0 || (!nota.tema || nota.tema.trim() === '')) {
          tr.classList.add("alerta-vacio");
        }
        camposDeDatos.forEach(campo => {
          const td = document.createElement("td");
          td.textContent = campo === "titular" ? truncarTexto(nota[campo], LIMITE_CARACTERES_TITULAR) : (nota[campo] || "");
          td.setAttribute("data-label", encabezadosTabla[campo]);
          tr.appendChild(td);
        });
        const tdAcc = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn-accion-tabla";
        btn.textContent = "Editar";
        btn.onclick = () => editarNota(tr);
        tdAcc.appendChild(btn);
        tr.appendChild(tdAcc);
        tbody.appendChild(tr);
      });
      filtrarTabla();
    }
    function desbloquearTodosLosCampos() {
      CAMPOS_CON_BLOQUEO.forEach(id => {
        const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
        if (chk && chk.checked) {
          chk.checked = false;
          alternarBloqueo(id);
        }
      });
    }
    function editarNota(tr) {
      const id = parseInt(tr.dataset.id);
      const idx = notas.findIndex(n => n.ordenCaptura === id);
      if (idx === -1) return;
      const nota = notas[idx];
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        document.getElementById(id).value = nota[id] || "";
      });
      resetearEstadoEdicion();
      filaEnEdicion = idx;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Actualizar Nota';
      document.getElementById('btnEliminar').style.display = 'inline-block';
      document.querySelectorAll('#tablaNotas tbody tr').forEach(r => r.classList.remove('editando'));
      tr.classList.add('editando');
      window.scrollTo(0, 0);
    }
    function alternarBloqueo(id) {
      const campo = document.getElementById(id);
      const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
      campo.readOnly = chk.checked;
      campo.classList.toggle("bloqueado", chk.checked);
    }
    function ordenarTabla(col, inicial = false) {
      let dir = 'asc';
      if (ordenActual.columna === col && !inicial) dir = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
      else if (inicial && col === 'ordenCaptura') dir = 'desc';
      notas.sort((a, b) => {
        let A = a[col] || "", B = b[col] || "";
        let cmp = 0;
        if (col === 'ordenCaptura') cmp = A - B;
        else if (col === 'fecha') {
          const dA = new Date(A + 'T00:00:00');
          const dB = new Date(B + 'T00:00:00');
          cmp = dA < dB ? -1 : dA > dB ? 1 : 0;
        } else {
          cmp = A.toString().localeCompare(B.toString(), 'es', { sensitivity: 'base' });
        }
        return dir === 'asc' ? cmp : -cmp;
      });
      ordenActual = { columna: col, direccion: dir };
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        const icon = th.querySelector('.sort-icon');
        icon.innerHTML = '';
        if (th.dataset.col === col) {
          th.querySelector('.sortable-header').classList.add('sorted');
          icon.innerHTML = dir === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        } else {
          th.querySelector('.sortable-header').classList.remove('sorted');
          icon.innerHTML = '<i class="fas fa-sort"></i>';
        }
      });
      renderizarTabla();
    }
    function filtrarTabla() {
      const filtro = document.getElementById('buscador').value.toLowerCase().trim();
      const filas = document.querySelectorAll('#tablaNotas tbody tr');
      filas.forEach(tr => {
        const id = parseInt(tr.dataset.id);
        const nota = notas.find(n => n.ordenCaptura === id);
        const mostrar = nota && camposDeDatos.some(c => (nota[c] || '').toString().toLowerCase().includes(filtro));
        tr.style.display = mostrar ? "" : "none";
      });
    }
    function guardarNotas() {
      localStorage.setItem('notasCapturadas', JSON.stringify(notas));
      localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura);
    }
    function cargarNotasGuardadas() {
      const json = localStorage.getItem('notasCapturadas');
      const ord = localStorage.getItem('nextOrdenCaptura');
      if (ord) nextOrdenCaptura = parseInt(ord, 10);
      if (json) {
        try {
          notas = JSON.parse(json);
          let max = 0;
          notas.forEach(n => {
            if (n.ordenCaptura === undefined) n.ordenCaptura = nextOrdenCaptura++;
            if (n.ordenCaptura > max) max = n.ordenCaptura;
            if (n.canal === undefined) n.canal = "";
            if (n.pagina === undefined) n.pagina = "";
          });
          if (max >= nextOrdenCaptura) nextOrdenCaptura = max + 1;
          guardarNotas();
        } catch (e) {
          notas = [];
        }
      }
      ordenarTabla("ordenCaptura", true);
    }
    function exportarCSV() {
      if (notas.length === 0) { alert("No hay notas para exportar."); return; }
      const csv = "\uFEFF" + [camposDeDatos.map(k => encabezadosTabla[k] || k)].concat(
        notas.map(n => camposDeDatos.map(k => `"${(n[k] || '').toString().replace(/"/g, '""')}"`))
      ).map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `notas_${sesionActiva?.usuario || "desconocido"}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
    async function enviarTelegram() {
      if (notas.length === 0) { alert("No hay notas para enviar."); return; }
      if (!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.startsWith("TU_BOT_TOKEN")) {
           alert("üö® Error: Las credenciales de Telegram no est√°n configuradas.");
           return;
      }
      const URL_TELEGRAM = `https://api.telegram.org/bot8428524335:AAFeKrvKrUxrI9NAkL_G1-X6LdL4F5fkV4/sendDocument`;
      try {
          document.getElementById('btnTelegram').disabled = true;
          document.getElementById('btnTelegram').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
          const csv = "\uFEFF" + [camposDeDatos.map(k => encabezadosTabla[k] || k)].concat(
            notas.map(n => camposDeDatos.map(k => `"${(n[k] || '').toString().replace(/"/g, '""')}"`))
          ).map(r => r.join(",")).join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const formData = new FormData();
          formData.append('chat_id', "-1003492273306");
          formData.append('document', blob, `notas_${new Date().toISOString().slice(0,10)}.csv`);
          await fetch(URL_TELEGRAM, { method: 'POST', body: formData });
          alert("‚úÖ Enviado a Telegram.");
      } catch (e) {
          alert("‚ùå Error de Telegram.");
      } finally {
          document.getElementById('btnTelegram').disabled = false;
          document.getElementById('btnTelegram').innerHTML = '<i class="fa-brands fa-telegram"></i> Enviar por Telegram';
      }
    }
    async function enviarSugerenciaTema() {
      const tema = document.getElementById("sugerenciaTemaInput").value.trim();
      if (!tema) { alert("Escribe una sugerencia."); return; }
      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "sugerirTema", tema })
        });
        const data = await res.json();
        if (data.status === "success") {
          alert("‚úÖ Sugerencia enviada.");
          document.getElementById("sugerenciaTemaInput").value = "";
        } else {
          alert("‚ö†Ô∏è Error: " + (data.message || ""));
        }
      } catch (e) {
        alert("‚úÖ Sugerencia enviada (posible error CORS).");
        document.getElementById("sugerenciaTemaInput").value = "";
      }
    }

    // === FUNCIONES AUTOCOMPLETAR (igual que en tu index.txt) ===
    async function cargarCSV(url) {
      try {
        const res = await fetch(`${url}?t=${Date.now()}`);
        const txt = await res.text();
        return txt.split('\n').map(l => l.split(','));
      } catch (e) {
        return [];
      }
    }
    function limpiarFilasCSV(filas) {
      if (!filas.length) return [];
      if (filas[0][0]) filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      const hdr = filas[0] ? filas[0].map(c => (c || "").toLowerCase()).join(",") : "";
      const tieneHdr = hdr.includes("dependencia") || hdr.includes("medio") || hdr.includes("g√©nero");
      if (tieneHdr) filas = filas.slice(1);
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }
    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([k, v]) => {
        if (!k) return;
        k = k.trim(); v = v ? v.trim() : '';
        if (!map[k]) map[k] = new Set();
        if (v) map[k].add(v);
      });
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
      return { claves, map: mapArrays };
    }
    async function cargarLista(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      return Array.from(new Set(filas.map(r => r[0]))).sort((a, b) => a.localeCompare(b, 'es'));
    }
    function autocompletar(id, idSug, lista, cb) {
      const campo = document.getElementById(id);
      const cont = document.getElementById(idSug);
      campo.dataset.lista = JSON.stringify(lista);
      campo.addEventListener("input", () => {
        const val = campo.value.toLowerCase().trim();
        cont.innerHTML = "";
        if (!val) return;
        const sug = lista.filter(i => i.toLowerCase().includes(val));
        sug.forEach((s, i) => {
          const div = document.createElement("div");
          div.textContent = s;
          div.className = "sugerencia";
          div.onclick = () => {
            campo.value = s;
            cont.innerHTML = "";
            if (cb) cb(s);
            campo.dispatchEvent(new Event('blur'));
          };
          cont.appendChild(div);
        });
      });
      campo.addEventListener("keydown", e => {
        const items = cont.querySelectorAll(".sugerencia");
        if (items.length === 1 && (e.key === "Enter" || e.key === "Tab")) {
          e.preventDefault();
          campo.value = items[0].textContent;
          cont.innerHTML = "";
          if (cb) cb(campo.value);
          campo.dispatchEvent(new Event('blur'));
          if (e.key === "Tab") {
            const focusable = Array.from(document.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));
            const idx = focusable.indexOf(e.target);
            if (idx > -1 && idx < focusable.length - 1) focusable[idx + 1].focus();
            else document.getElementById('titular').focus();
          }
          return;
        }
        if (!items.length) return;
        let idx = -1;
        items.forEach((el, i) => { if (el.classList.contains("resaltado")) idx = i; });
        if (e.key === "ArrowDown") {
          e.preventDefault();
          idx = (idx + 1) % items.length;
          items.forEach(el => el.classList.remove("resaltado"));
          items[idx].classList.add("resaltado");
          items[idx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          idx = (idx - 1 + items.length) % items.length;
          items.forEach(el => el.classList.remove("resaltado"));
          items[idx].classList.add("resaltado");
          items[idx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (idx >= 0) {
            campo.value = items[idx].textContent;
            cont.innerHTML = "";
            if (cb) cb(campo.value);
            campo.dispatchEvent(new Event('blur'));
          }
        }
      });
      campo.addEventListener("focus", () => {
        document.querySelectorAll('.sugerencias').forEach(s => {
          if (s.id !== idSug) s.innerHTML = "";
        });
      });
      campo.addEventListener("blur", () => {
        setTimeout(() => {
          if (!cont.contains(document.activeElement)) cont.innerHTML = "";
        }, 150);
      });
    }
    function mostrarSugerencias(id, idSug) {
      const campo = document.getElementById(id);
      const cont = document.getElementById(idSug);
      document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
      const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
      lista.forEach(s => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.onclick = () => {
          campo.value = s;
          cont.innerHTML = "";
          campo.dispatchEvent(new Event('blur'));
        };
        cont.appendChild(div);
      });
    }
    function findKeyCaseInsensitive(map, value) {
      if (!value) return null;
      const lower = value.toLowerCase();
      for (let k in map) if (k.toLowerCase() === lower) return k;
      return null;
    }
    function setCanalFromMedio(medio, map) {
      const input = document.getElementById('canal');
      const locked = localStorage.getItem('bloqueado_canal') === 'true';
      if (locked) return;
      const key = findKeyCaseInsensitive(map, medio);
      const canales = key ? map[key] : [];
      if (canales.length > 0) {
        input.value = canales[0];
      } else if (!input.value) {
        input.value = '';
      }
    }

    // === INICIALIZACI√ìN ===
    document.addEventListener("DOMContentLoaded", async () => {
      // Autocompletar
      let orgMap, firmaMap, medioToCanalMap;
      const depData = await cargarMapa(urls.dependencias);
      orgMap = depData.map;
      autocompletar("dependencia", "sugDep", depData.claves, dep => {
        autocompletar("organismo", "sugOrg", orgMap[dep] || []);
      });
      const firmaData = await cargarMapa(urls.firmas);
      firmaMap = firmaData.map;
      const canalData = await cargarMapa(urls.medios);
      medioToCanalMap = canalData.map;
      autocompletar("medio", "sugMedio", canalData.claves, medio => {
        setCanalFromMedio(medio, medioToCanalMap);
        const firmas = firmaMap[medio] || [];
        autocompletar("firma", "sugFirma", firmas);
        if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
      });
      document.getElementById("dependencia").addEventListener("blur", e => {
        const val = e.target.value.trim();
        const key = findKeyCaseInsensitive(orgMap, val);
        if (key) {
          e.target.value = key;
          autocompletar("organismo", "sugOrg", orgMap[key] || []);
        } else {
          e.target.value = val;
          autocompletar("organismo", "sugOrg", []);
        }
      });
      document.getElementById("medio").addEventListener("blur", e => {
        const val = e.target.value.trim();
        const firmaKey = findKeyCaseInsensitive(firmaMap, val);
        if (firmaKey) {
          e.target.value = firmaKey;
          setCanalFromMedio(firmaKey, medioToCanalMap);
          const firmas = firmaMap[firmaKey] || [];
          autocompletar("firma", "sugFirma", firmas);
          if (firmas.length === 1) document.getElementById("firma").value = firmas[0];
        } else {
          const canalKey = findKeyCaseInsensitive(medioToCanalMap, val);
          if (canalKey) {
            e.target.value = canalKey;
            setCanalFromMedio(canalKey, medioToCanalMap);
            autocompletar("firma", "sugFirma", []);
            document.getElementById("firma").value = '';
          } else {
            e.target.value = val;
            setCanalFromMedio(val, medioToCanalMap);
            autocompletar("firma", "sugFirma", []);
          }
        }
      });
      autocompletar("organismo", "sugOrg", []);
      autocompletar("firma", "sugFirma", []);
      autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
      autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
      autocompletar("tema", "sugTema", await cargarLista(urls.temas));
      autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));
      const canalesLista = Array.from(new Set(Object.values(medioToCanalMap).flat())).sort((a, b) => a.localeCompare(b, 'es'));
      autocompletar("canal", "sugCanal", canalesLista);

      // Eventos de login
      document.getElementById("btnLogin").addEventListener("click", () => {
        const u = document.getElementById("loginUsuario").value.trim();
        const p = document.getElementById("loginContrasena").value.trim();
        if (u && p) {
          document.getElementById("loginError").style.display = "none";
          iniciarSesion(u, p);
        } else {
          document.getElementById("loginError").innerText = "Complete ambos campos.";
          document.getElementById("loginError").style.display = "block";
        }
      });
      document.getElementById("loginUsuario").addEventListener("keypress", e => e.key === "Enter" && document.getElementById("btnLogin").click());
      document.getElementById("loginContrasena").addEventListener("keypress", e => e.key === "Enter" && document.getElementById("btnLogin").click());

      // Eventos generales
      document.getElementById('buscador').addEventListener('input', filtrarTabla);
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        th.addEventListener('click', () => ordenarTabla(th.dataset.col));
      });
      document.addEventListener('click', e => {
        if (!e.target.closest('.campo')) {
            document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
        }
      });

      // Atajos
      document.addEventListener("keydown", e => {
        if (e.key === "Enter" && e.target.tagName === 'INPUT' && (e.target.type === 'text' || e.target.type === 'date')) {
          const sug = e.target.parentNode.querySelector('.sugerencias');
          const items = sug ? sug.querySelectorAll('.sugerencia') : [];
          if (items.length !== 1) {
            e.preventDefault();
            const focusable = Array.from(document.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));
            const idx = focusable.indexOf(e.target);
            if (idx > -1 && idx < focusable.length - 1) focusable[idx + 1].focus();
            else document.getElementById('titular').focus();
          }
        }
      });
      document.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'q') {
          e.preventDefault();
          document.querySelector("form").dispatchEvent(new Event('submit'));
        }
      });
      document.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'l') {
          e.preventDefault();
          const el = document.activeElement;
          const id = el.id;
          if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'date') && CAMPOS_CON_BLOQUEO.includes(id)) {
            const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (chk) {
              chk.checked = !chk.checked;
              alternarBloqueo(id);
              el.focus();
            }
          }
        }
      });
    });

    // === SUBMIT: guardar local + enviar a Sheets ===
    document.querySelector("form").addEventListener("submit", async e => {
      e.preventDefault();
      if (!sesionActiva) { alert("Inicia sesi√≥n."); return; }
      const nota = {};
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        nota[id] = document.getElementById(id).value.trim();
      });
      const faltan = contieneCamposVacios(nota);
      if (faltan.length > 0) {
        alert(`Llene los campos obligatorios: ${faltan.map(c => encabezadosTabla[c]).join(', ')}`);
        return;
      }
      if (filaEnEdicion !== null) {
        nota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
        notas[filaEnEdicion] = nota;
        resetearEstadoEdicion();
      } else {
        nota.ordenCaptura = nextOrdenCaptura++;
        notas.push(nota);
        // ‚úÖ Enviar inmediatamente a Sheets
        await guardarNotaEnSheets(nota);
      }
      guardarNotas(); // ‚úÖ Guardado local
      ordenarTabla(ordenActual.columna, true);
      // ‚úÖ Limpiar solo campos no bloqueados
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        const bloqueado = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`).checked;
        if (!bloqueado) {
          document.getElementById(id).value = '';
        }
      });
      document.getElementById('titular').focus();
    });

    document.querySelector("form").addEventListener('reset', e => {
      e.preventDefault();
      desbloquearTodosLosCampos();
      e.target.reset();
      setTimeout(() => {
        document.getElementById('titular').focus();
        resetearEstadoEdicion();
      }, 10);
    });
  </script>
</body>
</html>