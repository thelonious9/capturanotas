<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    /* ImportaciÃ³n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;       /* Oscuro Suave */
      --color-fondo-form: #52504E;         /* Gris CÃ¡lido (Fondo del Formulario) */
      --color-primary: #6F0909;            /* Rojo Intenso (Guardar/Borrar Todo) */
      --color-primary-hover: #792929;      /* Rojo Suave */
      --color-secondary: #792929;          /* Rojo Suave (BotÃ³n Limpiar/Hover) */
      --color-secondary-hover: #6F0909;    /* Rojo Intenso */
      --color-danger: #dc3545;             /* Rojo estÃ¡ndar para peligro */
      --color-danger-hover: #c82333;       /* Rojo oscuro */
      --color-telegram: #0088cc;           
      --color-telegram-hover: #0077b3;     
      --color-dark-text: #31302F;          /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;         /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;           /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;       
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    
    /* --- FORMULARIO (MODIFICACIÃ“N DE LAYOUT) --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
        outline: none;
    }
    
    /* ðŸŒŸ REGLAS PARA CAMPOS DE ANCHO COMPLETO ðŸŒŸ */
    /* Usuario (Label: 2do elemento, Input: 3er elemento) -> Ocupan 4 columnas */
    form > label:nth-child(2), 
    form > div:nth-child(3) {
        grid-column: 1 / span 4; 
    }
    
    /* Titular (Label: 8vo elemento, Input: 9no elemento) -> Ocupan 4 columnas */
    form > label:nth-child(8), 
    form > div:nth-child(9) {
        grid-column: 1 / span 4; 
    }
    
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    
    /* --- BLOQUEO --- */
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    
    /* --- BOTONES --- */
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    button i { margin-right: 8px; font-size: 1.1em; }
    
    /* --- TABLA (CORRECCIÃ“N DE DEFORMACIÃ“N Y TRUNCAMIENTO) --- */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
      /* ðŸŒŸ CORRECCIÃ“N CLAVE: Fija el layout de la tabla para evitar deformaciÃ³n */
      table-layout: fixed; 
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #7D7C79;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      /* Asegura que el contenido se ajuste al ancho fijo y se trunque */
      word-wrap: break-word; 
      overflow: hidden;
      white-space: nowrap; 
      text-overflow: ellipsis;
      /* Eliminamos max-width conflictivos */
      max-width: none !important; 
    }

    /* ðŸŒŸ DEFINICIÃ“N DE ANCHOS PROPORCIONALES (15 columnas: Total 100%) - ORDEN ACTUALIZADO ðŸŒŸ */
    /* Nuevo orden: #, Usuario, Fecha, Medio, Titular, Firma, PÃ¡gina, Dependencia, Organismo, GÃ©nero, Canal, Tema, Estatus, Municipio, Acciones */
    #tablaNotas th:nth-child(1), #tablaNotas td:nth-child(1) { width: 3%; }    /* # (ordenCaptura) */
    #tablaNotas th:nth-child(2), #tablaNotas td:nth-child(2) { width: 7%; }    /* Usuario */
    #tablaNotas th:nth-child(3), #tablaNotas td:nth-child(3) { width: 7%; }    /* Fecha */
    #tablaNotas th:nth-child(4), #tablaNotas td:nth-child(4) { width: 8%; }    /* Medio */
    #tablaNotas th:nth-child(5), #tablaNotas td:nth-child(5) { width: 15%; }   /* Titular (15%) */
    #tablaNotas th:nth-child(6), #tablaNotas td:nth-child(6) { width: 6%; }    /* Firma (6%) */
    #tablaNotas th:nth-child(7), #tablaNotas td:nth-child(7) { width: 5%; }    /* PÃ¡gina (5%) */
    #tablaNotas th:nth-child(8), #tablaNotas td:nth-child(8) { width: 7%; }    /* Dependencia (7%) */
    #tablaNotas th:nth-child(9), #tablaNotas td:nth-child(9) { width: 7%; }    /* Organismo (7%) */
    #tablaNotas th:nth-child(10), #tablaNotas td:nth-child(10) { width: 5%; }  /* GÃ©nero (5%) */
    #tablaNotas th:nth-child(11), #tablaNotas td:nth-child(11) { width: 5%; }  /* Canal (5%) */
    #tablaNotas th:nth-child(12), #tablaNotas td:nth-child(12) { width: 7%; }  /* Tema (7%) */
    #tablaNotas th:nth-child(13), #tablaNotas td:nth-child(13) { width: 5%; }  /* Estatus (5%) */
    #tablaNotas th:nth-child(14), #tablaNotas td:nth-child(14) { width: 6%; }  /* Municipio (6%) */
    #tablaNotas th:nth-child(15), #tablaNotas td:nth-child(15) { width: 6%; }  /* Acciones (6%) */

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #5D5C5A; } 
    /* ðŸŒŸ MEJORA: Resaltar fila al pasar el cursor */
    tbody tr:hover { 
      background-color: #6C6B69; 
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }
    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    .sorted.alerta-vacio .sort-icon { color: var(--color-dark-text); }
    
    /* --- GRUPO DE ACCIONES (Globales) --- */
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 25px; 
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan */
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    
    /* ðŸŒŸ NUEVO ESTILO: Enviar a Sheets ðŸŒŸ */
    #btnGoogleSheets { background-color: #0A66C2; }
    #btnGoogleSheets:hover { background-color: #0959A8; }
    
    #btnTelegram { background-color: #0088cc; }
    #btnTelegram:hover { background-color: #0077b3; }
    
    /* BotÃ³n Sugerir Tema - Nuevo Estilo */
    #btnSugerirTema { background-color: #096F4B; }
    #btnSugerirTema:hover { background-color: #0A7E56; }
    #btnSugerirTema i { margin-right: 0; } /* Quitar margen del icono en botÃ³n Sugerir Tema (ya que estÃ¡ al final) */


    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }

    /* --- NUEVOS ESTILOS PARA CAMPO DE SUGERENCIA DE TEMA DEDICADO --- */
    .suggestion-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        /* Estilo para que se distinga como un grupo funcional */
        background-color: #4A4A4A; 
        padding: 8px; 
        border-radius: var(--radius);
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #sugerenciaTemaInput {
        padding: 10px 15px;
        border: 1px solid var(--color-primary-hover);
        border-radius: var(--radius);
        background-color: var(--color-input-bg);
        color: var(--color-dark-text);
        flex-grow: 1; 
        width: 250px; /* Ancho base */
    }
    /* El botÃ³n sugerir tema ahora va dentro del grupo de sugerencia */
    .suggestion-input-group #btnSugerirTema {
        margin-right: 0;
        padding: 10px 15px; 
    }
    /* --- FIN NUEVOS ESTILOS --- */


    /* BotÃ³n Editar en Tabla */
    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }
    
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(111, 9, 9, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        .actions-group { flex-direction: column; align-items: stretch; }
        .actions-group button { width: 100%; margin-bottom: 10px; }
        
        /* Responsive para el grupo de sugerencia */
        .suggestion-input-group {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
            padding: 15px 10px; /* MÃ¡s padding para que se vea mejor */
        }
        #sugerenciaTemaInput {
            max-width: none;
            width: 100%;
            margin-bottom: 5px;
        }
        .suggestion-input-group #btnSugerirTema {
             width: 100%;
        }

        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #7D7C79; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #8D8C8A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            /* Resetear para responsive */
            width: auto;
            max-width: 100%; 
            white-space: normal;
            text-overflow: clip; 
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
        .alerta-vacio td { color: var(--color-dark-text) !important; }
    }
  </style>
</head>
<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Prensa</h1>
  </header>

  <form>
    <div class="form-logo-container">
        <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">ðŸ”’</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">ðŸ”’</label>
    </div>

    <label for="medio">Medio:</label>
    <div class="campo">
      <input type="text" id="medio" name="medio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('medio','sugMedio')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkMedio" onchange="alternarBloqueo('medio')" tabindex="-1">
      <label for="checkMedio">ðŸ”’</label>
      <div id="sugMedio" class="sugerencias"></div>
    </div>
    
    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">ðŸ”’</label>
    </div>

    <label for="firma">Firma:</label>
    <div class="campo">
      <input type="text" id="firma" name="firma" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('firma','sugFirma')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkFirma" onchange="alternarBloqueo('firma')" tabindex="-1">
      <label for="checkFirma">ðŸ”’</label>
      <div id="sugFirma" class="sugerencias"></div>
    </div>
    
    <label for="pagina">PÃ¡gina:</label>
    <div class="campo">
      <input type="text" id="pagina" name="pagina" required> 
      <input type="checkbox" id="checkPagina" onchange="alternarBloqueo('pagina')" tabindex="-1">
      <label for="checkPagina">ðŸ”’</label>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">ðŸ”’</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>
    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">ðŸ”’</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>
    
    <label for="genero">GÃ©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">ðŸ”’</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>
    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">ðŸ”’</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>
    
    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">ðŸ”’</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>
    
    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">ðŸ”’</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">ðŸ”’</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>
    <label></label>
    <div class="campo"></div>


    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="actions-group">
    <div class="suggestion-input-group">
        <input type="text" id="sugerenciaTemaInput" placeholder="Escribe aquÃ­ tu sugerencia de tema" required>
        <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
            Sugerir Tema <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
    
    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-file-csv"></i> Exportar a hoja de cÃ¡lculo
    </button>
    
    <button id="btnGoogleSheets" onclick="enviarACalculo()">
      <i class="fa-solid fa-table"></i> Enviar a Sheets
    </button>
    
    <button id="btnTelegram" onclick="enviarTelegram()">
      <i class="fa-brands fa-telegram"></i> Enviar por Telegram
    </button> 
    
    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-trash-can"></i> Borrar Todas
    </button>
  </div>
  
  <div id="erroresCarga" class="error-carga"></div>
  
  <div class="buscador-container">
      <i class="fas fa-search buscador-icon"></i>
      <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Medio, etc.)">
  </div>
  
  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th data-col="ordenCaptura"><div class="sortable-header"># <span class="sort-icon"></span></div></th>
        <th data-col="usuario"><div class="sortable-header">Usuario <span class="sort-icon"></span></div></th>
        <th data-col="fecha"><div class="sortable-header">Fecha <span class="sort-icon"></span></div></th>
        <th data-col="medio"><div class="sortable-header">Medio <span class="sort-icon"></span></div></th>
        <th data-col="titular"><div class="sortable-header">Titular <span class="sort-icon"></span></div></th>
        <th data-col="firma"><div class="sortable-header">Firma <span class="sort-icon"></span></div></th>
        <th data-col="pagina"><div class="sortable-header">PÃ¡gina <span class="sort-icon"></span></div></th>
        <th data-col="dependencia"><div class="sortable-header">Dependencia <span class="sort-icon"></span></div></th>
        <th data-col="organismo"><div class="sortable-header">Organismo <span class="sort-icon"></span></div></th>
        <th data-col="genero"><div class="sortable-header">GÃ©nero <span class="sort-icon"></span></div></th>
        <th data-col="canal"><div class="sortable-header">Canal <span class="sort-icon"></span></div></th>
        <th data-col="tema"><div class="sortable-header">Tema <span class="sort-icon"></span></div></th>
        <th data-col="estatus"><div class="sortable-header">Estatus <span class="sort-icon"></span></div></th>
        <th data-col="municipio"><div class="sortable-header">Municipio <span class="sort-icon"></span></div></th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>

  <script>
    let notas = [];
    let filaEnEdicion = null;
    let nextOrdenCaptura = 1;
    
    // ORDEN DE CAMPOS ACTUALIZADO
    const camposDeDatos = ["ordenCaptura", "usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];
    
    // ðŸŒŸ NUEVA CONSTANTE PARA MANEJAR BLOQUEO GLOBAL Y RESET ðŸŒŸ
    const CAMPOS_CON_BLOQUEO = ["usuario", "fecha", "medio", "titular", "firma", "pagina", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];

    // ðŸŒŸ CABECERAS SIN (Opcional) ðŸŒŸ
    const encabezadosTabla = {
        "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma", 
        "pagina": "PÃ¡gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "GÃ©nero", "canal": "Canal",
        "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };
    
    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' }; 

    // RUTAS RELATIVAS (AsegÃºrese de que estos archivos estÃ©n en la misma carpeta)
    const urls = {
      dependencias: "./Dependencia.csv",
      medios: "./Medio.csv", // Usado para la dependencia Medio -> Canal
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      firmas: "./Firma.csv" // Usado para la lista de Firmas por Medio
    };
    
    // ======================================================================
    // ðŸŸ¢ CONSTANTES GLOBALES (Apps Script y Telegram) ðŸŸ¢
    // ======================================================================

    // URL para enviar sugerencias a Google Apps Script (Â¡ACTUALIZADA con tu URL!)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw9a6kEd2lTlbtU6OcwtmNx4983L-qNvuoh_fHzGDiKisiy7DjN-AwTORvnDQkfRvM/exec";
    
    // CREDENCIALES DE TELEGRAM (CONFIRMADAS)
    const TELEGRAM_BOT_TOKEN = "8428524335:AAFeKrvKrUxrI9NAkL_G1-X6LdL4F5fkV4"; 
    const TELEGRAM_CHAT_ID = "-1003492273306"; 
    
    // ======================================================================
    // ----------------------------------------------------------------------

    function findKeyCaseInsensitive(map, value) {
        if (!value) return null;
        const lowerValue = value.toLowerCase();
        for (const key in map) {
            if (key.toLowerCase() === lowerValue) {
                return key; 
            }
        }
        return null;
    }

    async function cargarCSV(url) {
      try {
        const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
        const res = await fetch(urlConCacheBuster);
        
        const contentType = res.headers.get("content-type");
        if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
            if (res.status === 404) {
                 throw new Error(`Archivo no encontrado. Revise la ruta: ${url}`);
            } else {
                 throw new Error(`Contenido inesperado (${contentType}). Revise ruta: ${url}`);
            }
        }
        
        const buffer = await res.arrayBuffer(); 
        const decoder = new TextDecoder('utf-8'); 
        const texto = decoder.decode(buffer); 
        return texto.split('\n').map(linea => linea.split(','));
      } catch (e) {
        document.getElementById("erroresCarga").innerText += `Error al cargar ${url}: ${e.message}\n`;
        return [];
      }
    }
    
    function limpiarFilasCSV(filas) {
      if (!filas || filas.length === 0) return [];
      // Elimina el BOM (Byte Order Mark) si existe en el primer campo
      if (filas[0] && filas[0][0]) {
          filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      }
      const encabezado = filas[0] ? filas[0].map(c => (c || "").toLowerCase()).join(",") : "";
      // Intenta detectar si hay encabezado para saltar la primera fila
      const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("medio") || encabezado.includes("gÃ©nero");
      if (tieneEncabezado) filas = filas.slice(1);
      // Limpia y filtra filas vacÃ­as
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }

    // Carga un mapa de dependencia (e.g., Dependencia -> Organismos, o Medio -> Firmas, o Medio -> Canales)
    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([clave, valor]) => {
        if (!clave) return;
        clave = clave.trim();
        valor = valor ? valor.trim() : '';
        map[clave] = map[clave] || new Set();
        if (valor) map[clave].add(valor);
      });
      // Convierte los Sets a Arrays ordenados
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
      return { claves, map: mapArrays };
    }

    // Carga una lista simple (e.g., GÃ©neros, Estatus)
    async function cargarLista(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      return Array.from(new Set(filas.map(r => r[0]))).sort((a, b) => a.localeCompare(b, 'es'));
    }
    
    function autocompletar(idCampo, idSugerencias, lista, callback) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        campo.dataset.lista = JSON.stringify(lista);
        let indice = -1;

        campo.addEventListener("input", () => {
            const valor = campo.value.toLowerCase().trim();
            contenedor.innerHTML = "";
            indice = -1;
            if (!valor) return;

            const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));

            sugerencias.forEach((s, i) => {
                const div = document.createElement("div");
                div.textContent = s;
                div.className = "sugerencia";
                div.dataset.index = i;
                div.onclick = () => {
                    campo.value = s;
                    contenedor.innerHTML = "";
                    if (callback) callback(s);
                };
                contenedor.appendChild(div);
            });
        });

        campo.addEventListener("keydown", e => {
            const items = contenedor.querySelectorAll(".sugerencia");
            // --- ðŸŒŸ NUEVA LÃ“GICA: SELECCIÃ“N ÃšNICA CON ENTER O TAB ðŸŒŸ --- 
            if (items.length === 1 && (e.key === "Enter" || e.key === "Tab")) {
                // Previene el comportamiento por defecto de la tecla (evita submit o movimiento inmediato de Tab)
                e.preventDefault(); 
                // 1. Selecciona el valor Ãºnico
                const valorSeleccionado = items[0].textContent;
                campo.value = valorSeleccionado;
                contenedor.innerHTML = "";
                // 2. Ejecuta el callback (si existe) y dispara el blur para actualizar dependencias (Medio -> Canal/Firma)
                if (callback) callback(valorSeleccionado);
                campo.dispatchEvent(new Event('blur')); 
                
                // 3. Simula el movimiento de foco si fue la tecla Tab
                if (e.key === "Tab") {
                    const form = document.querySelector('form');
                    // Solo busca inputs de texto y fecha que no estÃ©n marcados para ser saltados (tabindex="-1")
                    const focusable = Array.from(form.querySelectorAll('input[type="text"]:not([tabindex="-1"]), input[type="date"]:not([tabindex="-1"])'));
                    const index = focusable.indexOf(e.target);
                    // Mueve el foco al siguiente campo enfocable
                    if (index > -1 && index < focusable.length - 1) {
                        focusable[index + 1].focus();
                    } else if (index === focusable.length - 1) {
                        // Si es el Ãºltimo, vuelve al titular
                        document.getElementById('titular').focus();
                    }
                }
                return; // Termina la funciÃ³n aquÃ­
            }
            // --- FIN LÃ“GICA DE SELECCIÃ“N ÃšNICA ---

            // LÃ³gica de flechas y Enter original (si hay mÃ¡s de una sugerencia o si no se ha usado Enter/Tab)
            if (items.length === 0) return;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                indice = (indice + 1) % items.length;
                resaltar(items, indice);
                items[indice].scrollIntoView({ block: 'nearest' });
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                indice = (indice - 1 + items.length) % items.length;
                resaltar(items, indice);
                items[indice].scrollIntoView({ block: 'nearest' });
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (indice >= 0 && items[indice]) {
                    campo.value = items[indice].textContent;
                    contenedor.innerHTML = "";
                    if (callback) callback(campo.value);
                    // Disparar blur para actualizar dependencias
                    campo.dispatchEvent(new Event('blur'));
                }
            }
        });

        campo.addEventListener("focus", () => {
            // Cierra otras sugerencias
            document.querySelectorAll('.sugerencias').forEach(sug => {
                if (sug.id !== idSugerencias) {
                    sug.innerHTML = "";
                }
            });
        });

        campo.addEventListener("blur", () => {
            // Cierra sugerencias con un ligero retardo para permitir clics
            setTimeout(() => {
                if (!contenedor.contains(document.activeElement)) {
                    contenedor.innerHTML = "";
                }
            }, 150);
        });

        function resaltar(items, i) {
            items.forEach(el => el.classList.remove("resaltado"));
            items[i].classList.add("resaltado");
        }
    }
    
    function mostrarSugerencias(idCampo, idSugerencias) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        // Cierra todas las sugerencias antes de abrir una
        document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");
        
        const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
        contenedor.innerHTML = "";
        
        // Muestra todas las sugerencias si el campo estÃ¡ vacÃ­o al hacer clic
        if (campo.value.trim() === "") {
            lista.forEach((s, i) => {
                const div = document.createElement("div");
                div.textContent = s;
                div.className = "sugerencia";
                div.dataset.index = i;
                div.onclick = () => {
                    campo.value = s;
                    contenedor.innerHTML = "";
                    document.getElementById(idCampo).dispatchEvent(new Event('blur')); // Disparar blur para actualizar dependencias (si aplica)
                };
                contenedor.appendChild(div);
            });
        }
    }


    // --- LÃ“GICA DE PERSISTENCIA Y BLOQUEO ---
    function guardarPersistencia() {
        CAMPOS_CON_BLOQUEO.forEach(id => {
            const input = document.getElementById(id);
            const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            
            // Si el campo estÃ¡ bloqueado, ya guardamos su valor en alternarBloqueo, no lo tocamos aquÃ­.
            if (localStorage.getItem(`bloqueado_${id}`) === 'true') {
                return;
            }
            
            // Si el campo estÃ¡ desbloqueado, guardamos su valor actual si no estÃ¡ vacÃ­o.
            if (input.value) {
                localStorage.setItem(id, input.value);
            } else {
                // Si estÃ¡ vacÃ­o, limpiamos la persistencia del valor, pero no el estado de bloqueo
                localStorage.removeItem(id);
            }
        });
    }

    function cargarPersistencia() {
        CAMPOS_CON_BLOQUEO.forEach(id => {
            const input = document.getElementById(id);
            const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            
            // 1. Cargar estado de bloqueo
            const estadoBloqueo = localStorage.getItem(`bloqueado_${id}`);
            if (estadoBloqueo === 'true') {
                checkbox.checked = true;
                input.classList.add('bloqueado');
                input.readOnly = true;
            } else {
                checkbox.checked = false;
                input.classList.remove('bloqueado');
                input.readOnly = false;
            }

            // 2. Cargar valor persistido (solo si estÃ¡ bloqueado O si el campo no tiene valor actual)
            const valorPersistido = localStorage.getItem(id);
            if (valorPersistido) {
                // Siempre cargar si tiene un valor guardado (incluso si estÃ¡ desbloqueado)
                input.value = valorPersistido;
            }
        });
    }

    function alternarBloqueo(id) {
        const input = document.getElementById(id);
        const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);

        if (checkbox.checked) {
            // Bloqueando: Guardamos el valor actual y marcamos como bloqueado
            localStorage.setItem(id, input.value); 
            localStorage.setItem(`bloqueado_${id}`, 'true');
            input.classList.add('bloqueado');
            input.readOnly = true;
        } else {
            // Desbloqueando: Limpiamos el estado de bloqueo
            localStorage.removeItem(`bloqueado_${id}`);
            // Limpiamos el valor de persistencia para que no se restaure automÃ¡ticamente
            localStorage.removeItem(id); 
            input.classList.remove('bloqueado');
            input.readOnly = false;
            // Limpiamos el campo en la UI si el usuario desbloquea
            input.value = ''; 
        }
    }
    
    function desbloquearTodosLosCampos() {
        CAMPOS_CON_BLOQUEO.forEach(id => {
            const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (checkbox && checkbox.checked) {
                checkbox.checked = false;
                // La llamada a alternarBloqueo es CRUCIAL. Esto limpia `bloqueado_id` y `id` de localStorage
                alternarBloqueo(id); 
            }
        });
    }
    
    // ----------------------------------------------------------------------
    // ðŸš¨ NUEVA FUNCIÃ“N AÃ‘ADIDA PARA EL BOTÃ“N LIMPIAR ðŸš¨
    // ----------------------------------------------------------------------
    function limpiarValoresPersistidos() {
        CAMPOS_CON_BLOQUEO.forEach(id => {
            // Limpia el valor persistido de la nota, sin tocar el estado de bloqueo
            localStorage.removeItem(id); 
        });
    }
    // ----------------------------------------------------------------------


    // --- LÃ“GICA DE VALIDACIÃ“N ---
    function contieneCamposVacios(nota) {
        // Campos obligatorios. 'firma' y 'tema' son opcionales.
        const camposObligatorios = ["usuario", "fecha", "medio", "titular", "pagina", "dependencia", "organismo", "genero", "canal", "estatus", "municipio"];
        
        return camposObligatorios.filter(campo => {
            let valor = nota[campo];
            if (typeof valor === 'string') {
                valor = valor.trim();
            }
            return !valor;
        }).map(campo => {
            // Devuelve el nombre visible del campo para el alert
            return encabezadosTabla[campo] || campo; 
        });
    }

    // --- MANEJO DE NOTAS ---
    function cargarNotas() {
        const notasGuardadas = localStorage.getItem('notas');
        if (notasGuardadas) {
            notas = JSON.parse(notasGuardadas);
            if (notas.length > 0) {
                nextOrdenCaptura = Math.max(...notas.map(n => n.ordenCaptura)) + 1;
            }
        }
        cargarPersistencia();
        ordenarTabla(ordenActual.columna); 
    }

    function guardarNotas() {
        localStorage.setItem('notas', JSON.stringify(notas));
    }

    function renderizarTabla() {
        const tbody = document.querySelector("#tablaNotas tbody");
        tbody.innerHTML = '';
        
        const notasFiltradas = filtrarNotas();
        
        // Asignar los encabezados de tabla (data-label para responsive)
        const encabezados = {
            "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "medio": "Medio", "titular": "Titular", "firma": "Firma", 
            "pagina": "PÃ¡gina", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "GÃ©nero", "canal": "Canal",
            "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio"
        };
        
        notasFiltradas.forEach((nota, index) => {
            const tr = document.createElement('tr');
            
            // Agregar la clase de ediciÃ³n si es la fila actual
            if (filaEnEdicion !== null && notas[filaEnEdicion].ordenCaptura === nota.ordenCaptura) {
                 tr.classList.add('editando');
            }
            
            // Comprobar si le falta el titular (alerta de vacÃ­o)
            if (!nota.titular || nota.titular.trim() === "") {
                tr.classList.add('alerta-vacio');
            }
            
            camposDeDatos.forEach(campo => {
                const td = document.createElement('td');
                td.textContent = nota[campo];
                td.setAttribute('data-label', encabezados[campo] || campo); // Para Responsive
                tr.appendChild(td);
            });

            // Columna de Acciones
            const tdAcciones = document.createElement('td');
            tdAcciones.setAttribute('data-label', 'Acciones'); // Para Responsive
            const btnEditar = document.createElement('button');
            btnEditar.textContent = 'Editar';
            btnEditar.className = 'btn-accion-tabla';
            btnEditar.onclick = () => cargarNotaParaEdicion(nota.ordenCaptura);
            tdAcciones.appendChild(btnEditar);
            tr.appendChild(tdAcciones);

            tbody.appendChild(tr);
        });
        
        // Resetear Ã­conos de ordenaciÃ³n
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.parentNode.classList.remove('sorted', 'desc', 'asc');
            header.querySelector('.sort-icon').className = 'sort-icon';
            if (header.parentNode.dataset.col === ordenActual.columna) {
                header.parentNode.classList.add('sorted', ordenActual.direccion);
                header.querySelector('.sort-icon').className = `sort-icon fas fa-caret-${ordenActual.direccion === 'asc' ? 'up' : 'down'}`;
            }
        });
    }

    function cargarNotaParaEdicion(ordenCaptura) {
        // Encontrar el Ã­ndice de la nota a editar
        const index = notas.findIndex(n => n.ordenCaptura === ordenCaptura);
        if (index === -1) return;

        filaEnEdicion = index;
        const nota = notas[index];
        
        // Cargar los datos de la nota en el formulario
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const input = document.getElementById(id);
            // Si el campo NO estÃ¡ bloqueado, se carga el valor de la nota
            if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                 input.value = nota[id] || '';
            }
            // Si estÃ¡ bloqueado, mantiene su valor de persistencia
        });

        // Ocultar Limpiar, mostrar Borrar Nota, cambiar Guardar a Actualizar
        document.getElementById('btnGuardar').querySelector('i').className = 'fa-solid fa-pen-to-square';
        document.getElementById('btnGuardar').childNodes[1].nodeValue = ' Actualizar';
        document.getElementById('btnLimpiar').style.display = 'none';
        document.getElementById('btnEliminar').style.display = 'inline-block';
        
        // Resaltar la fila en la tabla
        renderizarTabla();
        
        document.getElementById('titular').focus();
    }
    
    function resetearEstadoEdicion() {
        filaEnEdicion = null;
        document.getElementById('btnGuardar').querySelector('i').className = 'fa-solid fa-floppy-disk';
        document.getElementById('btnGuardar').childNodes[1].nodeValue = ' Guardar';
        document.getElementById('btnLimpiar').style.display = 'inline-block';
        document.getElementById('btnEliminar').style.display = 'none';
        renderizarTabla();
    }
    
    function borrarNota() {
        if (filaEnEdicion !== null) {
            const orden = notas[filaEnEdicion].ordenCaptura;
            if (confirm(`Â¿EstÃ¡ seguro de que desea eliminar la nota #${orden}?`)) {
                notas.splice(filaEnEdicion, 1);
                guardarNotas();
                ordenarTabla(ordenActual.columna, true); 
                // Limpiar el formulario y resetear estado de ediciÃ³n
                document.querySelector("form").reset();
            }
        }
    }

    function borrarTodo() {
        if (confirm("ðŸš¨ ATENCIÃ“N: Â¿EstÃ¡ seguro de que desea ELIMINAR TODAS las notas? Esta acciÃ³n no se puede deshacer.")) {
            notas = [];
            guardarNotas();
            nextOrdenCaptura = 1; 
            ordenarTabla(ordenActual.columna, true);
            // Limpiar el formulario y resetear estado de ediciÃ³n
            document.querySelector("form").reset(); 
            // Adicionalmente, limpiar la persistencia completa si se borran todas las notas
            CAMPOS_CON_BLOQUEO.forEach(id => {
                localStorage.removeItem(id);
                localStorage.removeItem(`bloqueado_${id}`);
                // Asegurar que los checkboxes se desmarquen en la UI
                const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
                if (checkbox) checkbox.checked = false;
                const input = document.getElementById(id);
                if (input) {
                    input.classList.remove('bloqueado');
                    input.readOnly = false;
                }
            });
        }
    }
    
    // --- LÃ“GICA DE ORDENACIÃ“N ---
    function ordenarTabla(columna, forzarRender = false) {
        if (ordenActual.columna === columna && !forzarRender) {
            ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
            ordenActual.columna = columna;
            ordenActual.direccion = 'desc'; // Ordenar por # descendente por defecto
        }

        const esNumero = ['ordenCaptura', 'pagina'].includes(columna);
        const factor = ordenActual.direccion === 'asc' ? 1 : -1;

        notas.sort((a, b) => {
            let valA = a[columna] || (esNumero ? 0 : '');
            let valB = b[columna] || (esNumero ? 0 : '');
            
            if (esNumero) {
                valA = parseFloat(valA);
                valB = parseFloat(valB);
            } else {
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }
            
            if (valA < valB) return -1 * factor;
            if (valA > valB) return 1 * factor;
            return 0; 
        });

        renderizarTabla();
    }
    
    // --- LÃ“GICA DE BÃšSQUEDA ---
    function filtrarNotas() {
        const busqueda = document.getElementById('buscador').value.toLowerCase().trim();
        if (!busqueda) {
            return notas;
        }

        return notas.filter(nota => {
            // Buscar en todos los campos de texto
            return camposDeDatos.some(campo => {
                const valor = String(nota[campo] || '').toLowerCase();
                return valor.includes(busqueda);
            });
        });
    }

    // --- LÃ“GICA DE EXPORTACIÃ“N Y ENVÃO ---
    function exportarCSV() {
        if (notas.length === 0) {
            alert("No hay notas para exportar.");
            return;
        }

        const headers = camposDeDatos.map(id => encabezadosTabla[id]).join(',');
        
        const rows = notas.map(nota => 
            camposDeDatos.map(campo => {
                let valor = nota[campo] || '';
                // Escapar comillas dobles y encerrar entre comillas si contiene comas o saltos de lÃ­nea
                valor = valor.replace(/"/g, '""');
                if (valor.includes(',') || valor.includes('\n') || valor.includes('\r')) {
                    valor = `"${valor}"`;
                }
                return valor;
            }).join(',')
        );

        const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join('\n');
        
        const link = document.createElement('a');
        link.setAttribute('href', encodeURI(csvContent));
        link.setAttribute('download', 'notas_de_prensa.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    async function enviarDatos(url, data) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', // Necesario para Google Apps Script
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data).toString()
            });
            // Debido a 'no-cors', no podemos leer la respuesta, solo podemos asumir Ã©xito.
            return true;
        } catch (error) {
            console.error('Error al enviar datos:', error);
            alert("Error al enviar la informaciÃ³n. Revise la consola.");
            return false;
        }
    }

    // ðŸŒŸ FUNCIÃ“N ENVIAR SUGERENCIA DE TEMA ðŸŒŸ
    async function enviarSugerenciaTema() {
        const input = document.getElementById('sugerenciaTemaInput');
        const tema = input.value.trim();
        
        if (!tema) {
            alert("Por favor, escriba el tema que desea sugerir.");
            return;
        }

        const data = {
            action: "sugerirTema",
            tema: tema,
            timestamp: new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })
        };
        
        const exito = await enviarDatos(APPS_SCRIPT_URL, data);
        
        if (exito) {
            alert(`Sugerencia de tema enviada: "${tema}". Gracias por su contribuciÃ³n.`);
            input.value = '';
        }
    }
    
    // ðŸŒŸ FUNCIÃ“N ENVIAR A SHEETS (Guardar notas) ðŸŒŸ
    async function enviarACalculo() {
        if (notas.length === 0) {
            alert("No hay notas para enviar.");
            return;
        }

        const notasParaEnviar = notas.map(nota => {
            const data = {};
            camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(campo => {
                data[campo] = nota[campo] || '';
            });
            return data;
        });

        const data = {
            action: "guardarNotas",
            notas: JSON.stringify(notasParaEnviar)
        };

        alert("Enviando notas a la hoja de cÃ¡lculo de Google. Espere un momento...");
        
        const exito = await enviarDatos(APPS_SCRIPT_URL, data);
        
        if (exito) {
            alert("âœ… Notas enviadas exitosamente a Google Sheets.");
        }
    }

    // ðŸŒŸ FUNCIÃ“N ENVIAR A TELEGRAM ðŸŒŸ
    function formatearMensajeTelegram(nota) {
        const nombreUsuario = nota.usuario || 'Desconocido';
        const fecha = nota.fecha || 'N/A';
        const hora = new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Mexico_City' });

        return `ðŸ“° *Nueva Nota de Prensa Capturada* ðŸ“°\n\n` +
               `*Usuario:* ${nombreUsuario}\n` +
               `*Fecha:* ${fecha} ${hora}\n` +
               `*Medio:* ${nota.medio || 'N/A'}\n` +
               `*Titular:* ${nota.titular || 'N/A'}\n` +
               `*Firma:* ${nota.firma || 'N/A'}\n` +
               `*PÃ¡gina:* ${nota.pagina || 'N/A'}\n` +
               `*Dependencia:* ${nota.dependencia || 'N/A'}\n` +
               `*Organismo:* ${nota.organismo || 'N/A'}\n` +
               `*GÃ©nero:* ${nota.genero || 'N/A'}\n` +
               `*Canal:* ${nota.canal || 'N/A'}\n` +
               `*Tema:* ${nota.tema || 'N/A'}\n` +
               `*Estatus:* ${nota.estatus || 'N/A'}\n` +
               `*Municipio:* ${nota.municipio || 'N/A'}\n`;
    }

    async function enviarTelegram() {
        if (notas.length === 0) {
            alert("No hay notas para enviar a Telegram.");
            return;
        }
        
        const ultimaNota = notas[notas.length - 1]; 
        const mensaje = formatearMensajeTelegram(ultimaNota);
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: mensaje,
                    parse_mode: 'Markdown'
                })
            });

            const data = await response.json();
            
            if (data.ok) {
                alert("âœ… Ãšltima nota enviada exitosamente a Telegram.");
            } else {
                console.error("Error de Telegram:", data);
                alert(`Error al enviar a Telegram: ${data.description || 'Token o Chat ID invÃ¡lido.'}`);
            }
        } catch (error) {
            console.error('Error de red al enviar a Telegram:', error);
            alert("Error de red al enviar la informaciÃ³n a Telegram.");
        }
    }
    
    // --- LÃ“GICA DE INICIALIZACIÃ“N ---
    async function init() {
        // Cargar listas dependientes de CSV
        const [
            mapaDependencias, listaGeneros, listaEstatus, listaTemas, 
            listaMunicipios, mapaMedios, mapaFirmas
        ] = await Promise.all([
            cargarMapa(urls.dependencias),
            cargarLista(urls.generos),
            cargarLista(urls.estatus),
            cargarLista(urls.temas),
            cargarLista(urls.municipios),
            cargarMapa(urls.medios), // Medios contiene Medio -> Canal
            cargarMapa(urls.firmas)  // Firmas contiene Medio -> Firmas
        ]);

        // Autocompletar y Dependencia LÃ³gica

        // 1. Dependencia/Organismo
        autocompletar('dependencia', 'sugDep', mapaDependencias.claves, (depSeleccionada) => {
            const organismos = mapaDependencias.map[depSeleccionada] || [];
            document.getElementById('organismo').dataset.lista = JSON.stringify(organismos);
            document.getElementById('organismo').value = '';
            // Limpia la persistencia del organismo si cambia la dependencia
            localStorage.removeItem('organismo');
        });
        autocompletar('organismo', 'sugOrg', [], null); // La lista se llena dinÃ¡micamente

        // 2. Medio/Firma/Canal
        autocompletar('medio', 'sugMedio', mapaMedios.claves, (medioSeleccionado) => {
            // Actualizar Canal
            const canales = mapaMedios.map[medioSeleccionado] || [];
            document.getElementById('canal').dataset.lista = JSON.stringify(canales);
            document.getElementById('canal').value = '';
            localStorage.removeItem('canal');
            
            // Actualizar Firma (usando el mapa de Firmas)
            const firmas = mapaFirmas.map[medioSeleccionado] || [];
            document.getElementById('firma').dataset.lista = JSON.stringify(firmas);
            document.getElementById('firma').value = '';
            localStorage.removeItem('firma');
        });
        autocompletar('firma', 'sugFirma', [], null); // La lista se llena dinÃ¡micamente
        autocompletar('canal', 'sugCanal', [], null); // La lista se llena dinÃ¡micamente

        // 3. Listas Simples
        autocompletar('genero', 'sugGenero', listaGeneros, null);
        autocompletar('estatus', 'sugEstatus', listaEstatus, null);
        autocompletar('tema', 'sugTema', listaTemas, null);
        autocompletar('municipio', 'sugMunicipio', listaMunicipios, null);

        // Cargar notas guardadas y aplicar persistencia
        cargarNotas();
        
        // Asignar listeners de ordenaciÃ³n
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const columna = header.parentNode.dataset.col;
                ordenarTabla(columna);
            });
        });
        
        // Listener de bÃºsqueda
        document.getElementById('buscador').addEventListener('input', () => renderizarTabla());
    }

    // --- MANEJO DEL FORMULARIO ---
    document.querySelector("form").addEventListener('submit', (e) => {
        e.preventDefault(); 
        
        // 1. Recopilar datos
        const nuevaNota = {};
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            nuevaNota[id] = document.getElementById(id).value.trim();
        });

        // ðŸš¨ VALIDACIÃ“N: No guarda si faltan campos obligatorios 
        const camposFaltantes = contieneCamposVacios(nuevaNota);

        if (camposFaltantes.length > 0) {
            // ðŸš¨ ALERTA CORREGIDA SIN MENCIONAR CAMPOS OPCIONALES ðŸš¨
            alert(`ðŸš¨ Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}`);
            return; // Detiene el proceso de guardado/actualizaciÃ³n
        }
        
        // 2. Guardar/Actualizar nota
        if (filaEnEdicion !== null) {
            nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
            notas[filaEnEdicion] = nuevaNota;
            resetearEstadoEdicion();
        } else {
            nuevaNota.ordenCaptura = nextOrdenCaptura++; 
            notas.push(nuevaNota);
        }
        
        guardarNotas();
        ordenarTabla(ordenActual.columna, true); 
        
        // 3. Limpiar campos NO bloqueados y eliminar su persistencia
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            // Si el campo NO estÃ¡ bloqueado (o estÃ¡ desbloqueado por la nueva lÃ³gica de 'alternarBloqueo'),
            // se limpia su valor en la UI.
            if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                document.getElementById(id).value = ''; 
                // CRUCIAL: Limpiar el valor persistido para el campo NO bloqueado
                localStorage.removeItem(id); 
            }
        });
        
        // 4. Devolver el foco al campo Titular
        document.getElementById('titular').focus();
    });
    
    // ----------------------------------------------------------------------
    // âœ… CORRECCIÃ“N DEL EVENTO RESET (LIMPIAR)
    // ----------------------------------------------------------------------
    document.querySelector("form").addEventListener('reset', (e) => {
        e.preventDefault(); 
        
        // 1. Desbloquear todos los campos (limpia el estado de bloqueo de localStorage y el valor si estaba bloqueado)
        desbloquearTodosLosCampos();

        // 2. Limpiar todos los VALORES persistidos. (Crucial para los campos que ya estaban desbloqueados)
        limpiarValoresPersistidos();

        // 3. Ejecutamos el reset del formulario (limpia la UI)
        e.target.reset(); 

        // 4. Resetear estado de ediciÃ³n y foco
        setTimeout(() => {
            document.getElementById('titular').focus();
            resetearEstadoEdicion(); 
        }, 10);
    });

    // ðŸŒŸ INICIALIZACIÃ“N ðŸŒŸ
    document.addEventListener('DOMContentLoaded', init);
</script>

  <footer>
    Â© 2025 Francisco Villeda. Todos los derechos reservados.
  </footer>
</body>
</html>