<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura de notas</title>
  <style>
    input, select { width: 200px; margin: 5px; }
    .sugerencias { border: 1px solid #ccc; display: none; position: absolute; background: #fff; z-index: 10; }
    .sugerencias div { padding: 4px; cursor: pointer; }
    .sugerencias div:hover { background: #eee; }
  </style>
</head>
<body>

<h2>Formulario de captura</h2>
<form id="formulario">
  <input id="fecha" type="date" placeholder="Fecha">
  <input id="medio" placeholder="Medio"><div id="sugMedio" class="sugerencias"></div>
  <input id="canal" placeholder="Canal" readonly>
  <input id="titular" placeholder="Titular">
  <input id="firma" placeholder="Firma">
  <input id="pagina" placeholder="Página">
  <input id="dependencia" placeholder="Dependencia"><div id="sugDep" class="sugerencias"></div>
  <input id="organismo" placeholder="Organismo"><div id="sugOrg" class="sugerencias"></div>
  <input id="genero" placeholder="Género">
  <input id="tema" placeholder="Tema"><div id="sugTema" class="sugerencias"></div>
  <input id="estatus" placeholder="Estatus">
  <input id="municipio" placeholder="Municipio"><div id="sugMpio" class="sugerencias"></div>
  <button type="submit">Agregar nota</button>
</form>
<h3>Notas capturadas</h3>
<table id="tabla">
  <thead>
    <tr>
      <th>#</th><th>Fecha</th><th>Medio</th><th>Canal</th><th>Titular</th><th>Firma</th><th>Página</th>
      <th>Dependencia</th><th>Organismo</th><th>Género</th><th>Tema</th><th>Estatus</th><th>Municipio</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- ✅ Botón para exportar a Excel -->
<button onclick="exportarExcel()">Exportar a Excel</button>
<script>
// Vínculos de descarga directa (convertidos correctamente)
const urls = {
  medios: "https://onedrive.live.com/download?resid=45D8F391765B4743BA7FDC2CEBCB186B&authkey=!45D8F391765B4743BA7FDC2CEBCB186B&em=2",
  dependencias: "https://onedrive.live.com/download?resid=6A7BF92722BBE9ED!s3f0865bf78e54dcfbddd75159f094d4b&authkey=!s3f0865bf78e54dcfbddd75159f094d4b&em=2",
  municipios: "https://onedrive.live.com/download?resid=93E048FB646444CFAA7C0CC73FBEC358&authkey=!93E048FB646444CFAA7C0CC73FBEC358&em=2",
  temas: "https://onedrive.live.com/download?resid=EEF06F910C40438989B7F05BA4560EA8&authkey=!EEF06F910C40438989B7F05BA4560EA8&em=2"
};

let medios = {};
let dependencias = {};
let temas = [];
let municipios = [];

function cargarCSV(url, callback) {
  fetch(url)
    .then(res => res.text())
    .then(text => {
      const filas = text.trim().split("\n").map(f => f.split(",").map(c => c.trim()));
      callback(filas);
    });
}

// Medios y canal
cargarCSV(urls.medios, filas => {
  filas.forEach(([medio, canal]) => {
    if (medio && canal) medios[medio] = canal;
  });
  autocompletar("medio", "sugMedio", Object.keys(medios), medio => {
    document.getElementById("canal").value = medios[medio] || "";
  });
});

// Dependencias con encabezado y organismos debajo
cargarCSV(urls.dependencias, filas => {
  dependencias = {};
  let actual = null;
  filas.forEach(fila => {
    const celda = fila[0]?.trim();
    if (!celda) return;
    if (fila.length === 1 || (fila.length === 2 && !fila[1])) {
      actual = celda;
      dependencias[actual] = [];
    } else if (actual) {
      dependencias[actual].push(celda);
    }
  });
  autocompletar("dependencia", "sugDep", Object.keys(dependencias), dep => {
    autocompletar("organismo", "sugOrg", dependencias[dep] || []);
  });
});

// Temas
cargarCSV(urls.temas, filas => {
  temas = filas.map(f => f[0]).filter(Boolean);
  autocompletar("tema", "sugTema", temas);
});

// Municipios
cargarCSV(urls.municipios, filas => {
  municipios = filas.map(f => f[0]).filter(Boolean);
  autocompletar("municipio", "sugMpio", municipios);
});
</script>
<script>
function autocompletar(idCampo, idSugerencias, lista, callback) {
  const campo = document.getElementById(idCampo);
  const contenedor = document.getElementById(idSugerencias);

  campo.addEventListener("input", () => {
    const valor = campo.value.toLowerCase();
    contenedor.innerHTML = "";
    if (!valor) return contenedor.style.display = "none";

    const sugerencias = lista.filter(e => e.toLowerCase().includes(valor)).slice(0, 10);
    sugerencias.forEach(s => {
      const div = document.createElement("div");
      div.textContent = s;
      div.onclick = () => {
        campo.value = s;
        contenedor.style.display = "none";
        if (callback) callback(s);
      };
      contenedor.appendChild(div);
    });
    contenedor.style.display = "block";
  });

  campo.addEventListener("blur", () => setTimeout(() => contenedor.style.display = "none", 200));
}

document.getElementById("formulario").addEventListener("submit", e => {
  e.preventDefault();
  const campos = ["fecha","medio","canal","titular","firma","pagina","dependencia","organismo","genero","tema","estatus","municipio"];
  const fila = document.createElement("tr");
  fila.innerHTML = `<td>${document.querySelectorAll("#tabla tbody tr").length + 1}</td>` +
    campos.map(id => `<td>${document.getElementById(id).value}</td>`).join("");
  document.querySelector("#tabla tbody").appendChild(fila);
  document.getElementById("formulario").reset();
});
<script>
function exportarExcel() {
  const tabla = document.getElementById("tabla");
  const filas = Array.from(tabla.rows).map(row =>
    Array.from(row.cells).map(cell => cell.innerText)
  );

  let csv = filas.map(f => f.join(",")).join("\n");
  let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "notas.csv";
  a.click();
}
</script>
</body>
</html>